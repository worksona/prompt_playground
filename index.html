<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worksona Playground</title>
    
    <!-- Core Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- Document Processing Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        /* Theme Variables */
        :root {
            --primary-bg: #1e1e1e;  /* Dark background like IDE */
            --secondary-bg: #252526; /* Slightly lighter for panels */
            --accent-color: #007acc; /* Blue accent like VS Code */
            --text-primary: #d4d4d4; /* Light gray text */
            --text-secondary: #858585; /* Dimmer text */
            --border-color: #3c3c3c; /* Darker borders */
            --button-hover: #2a2d2e; /* Button hover state */
            --error-color: #f48771; /* Error text color */
            --border-radius: 0;  /* Add this variable for consistency */
        }

        /* Base styles */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }

        #particles-js {
            display: none;
        }

        .container {
            padding: 0;
            display: flex;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Agency Details styles */
        .agency-details {
            margin-bottom: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background: transparent;
            padding: 0;
            border: none;
            border-radius: 0;
        }

        .agency-name-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            resize: none;
            outline: none;
            font-family: inherit;
            background: var(--primary-bg);
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 500;
            height: 2.5rem;
        }

        .agency-description-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            resize: vertical;
            outline: none;
            font-family: inherit;
            background: var(--primary-bg);
            color: var(--text-primary);
            min-height: 4rem;
            font-size: 0.875rem;
        }
        /* Fixed section */
        .fixed-section {
            width: 320px;
            min-width: 320px;
            max-width: 320px;
            flex-shrink: 0;
            padding: 1.25rem;
            border-right: 1px solid var(--border-color);
            background: var(--secondary-bg);
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            position: fixed;
            left: 0;
            top: 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            z-index: 100;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Focus states for textareas */
        .agency-name-textarea:focus,
        .agency-description-textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(99, 226, 183, 0.1);
        }

        /* Placeholder colors */
        .agency-name-textarea::placeholder,
        .agency-description-textarea::placeholder {
            color: var(--text-secondary);
        }

        /* Persona styles */
        .persona-tray {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 0;
        }

        .persona-selector-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .persona-selector {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
        }

        .add-persona-btn {
            background: var(--accent-color);
            color: var(--primary-bg);
            border: none;
            border-radius: 0;
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .persona-card {
            background: var(--secondary-bg);
            border-radius: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            padding: 1rem;
            min-width: 300px;
            max-width: 400px;
            height: fit-content;
            flex-shrink: 0;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            border: 1px solid var(--border-color);
            border-left: 4px solid #FF9800; /* Orange accent for personas */
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-sizing: border-box;
        }

        .persona-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-color);
        }

        .persona-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .persona-emoji {
            font-size: 2rem;
        }

        .persona-title {
            font-weight: 500;
            color: var(--text-primary);
        }

        .persona-name {
            width: calc(100% - 1rem);
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            outline: none;
            margin: 0 0.5rem 0.5rem 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }

        .persona-name:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(99, 226, 183, 0.2);
        }

        .direction-selector {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .persona-textarea {
            width: calc(100% - 1rem);
            min-height: 150px;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            resize: vertical;
            outline: none;
            font-family: inherit;
            background: var(--primary-bg);
            color: var(--text-primary);
            margin: 0 0.5rem 1rem 0.5rem;
            box-sizing: border-box;
        }

        .persona-textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(99, 226, 183, 0.2);
        }

        .persona-textarea::placeholder {
            color: var(--text-secondary);
        }

        /* Image Upload styles */
        .image-upload-zone {
            border: 2px dashed var(--border-color);
            padding: 2rem;
            border-radius: 0;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--secondary-bg);
            margin-bottom: 1rem;
        }

        .image-upload-zone:hover {
            border-color: var(--accent-color);
            background: var(--secondary-bg);
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            margin: 1rem 0;
            border-radius: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Image Tray styles */
        .image-tray {
            margin-top: 1rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--secondary-bg);
        }

        .image-tray-title {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .image-preview-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .image-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 0;
            overflow: hidden;
            border: 2px solid var(--border-color);
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-item.selected {
            border-color: var(--accent-color);
        }

        .image-preview-item .delete-button {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--secondary-bg);
            border: none;
            border-radius: 0;
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-weight: bold;
        }

        /* Content area */
        .content-area {
            flex: 1;
            margin-left: 320px;
            min-width: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow-x: auto;
        }

        /* Remove horizontal scroll padding */
        .horizontal-scroll {
            display: flex;
            gap: 2rem;
            padding: 0;
            min-width: min-content;
        }

        /* Add styles for card columns */
        .card-column {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            min-width: 300px;
            max-width: 400px;
            flex-shrink: 0;
            max-height: calc(100vh - 8rem);
            overflow-y: auto;
        }

        /* Update prompt container to include bottom padding */
        .prompt-container {
            display: flex;
            gap: 0;
            flex-shrink: 0;
            height: 100vh;
            padding: 0;
            margin-left: -2rem;
            overflow-x: auto;
            overflow-y: hidden;
        }

        /* Update prompt card to include bottom padding */
        .prompt-card {
            background: var(--secondary-bg);
            border-radius: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            padding: 1rem;
            padding-bottom: 3rem; /* Add extra padding at bottom */
            min-width: 300px;
            max-width: 400px;
            height: 100vh;
            flex-shrink: 0;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            border: 1px solid var(--border-color);
            overflow-y: auto;
        }

        /* Add padding to the last element in prompt card */
        .prompt-card > *:last-child {
            margin-bottom: 2rem; /* Add space after the last element */
        }

        .prompt-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-color);
        }

        .prompt-card.image-mode {
            border-left: 4px solid var(--accent-color);
        }

        .source-type-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0;
            background: transparent;
            border-radius: 0;
        }

        .source-type-button {
            flex: 1;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--secondary-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .source-type-button.active {
            background: var(--accent-color);
            color: var(--primary-bg);
            border-color: var(--accent-color);
        }

        .source-selector {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            outline: none;
            margin-bottom: 0.5rem;
            min-height: 120px; /* Add minimum height */
            max-height: 200px;
            overflow-y: auto;
        }

        .source-selector option {
            padding: 0.5rem 0.5rem 0.5rem 2rem;
            cursor: pointer;
            position: relative;
        }

        .source-selector option:checked,
        .source-selector option:hover:checked,
        .source-selector option[selected] {
            background: var(--accent-color) !important;
            color: white !important;
            -webkit-appearance: none;
            appearance: none;
        }

        .source-selector option:checked::before,
        .source-selector option[selected]::before {
            content: "✓";
            position: absolute;
            left: 0.5rem;
            color: white;
            font-weight: bold;
        }

        .source-selector option:hover {
            background: rgba(226, 152, 99, 0.1);
        }

        .prompt-textarea {
            width: 100%;
            min-height: 200px;
            height: 200px;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            resize: vertical;
            outline: none;
            font-family: inherit;
            background: var(--primary-bg);
            color: var(--text-primary);
            margin: 0;
            box-sizing: border-box;
            transition: border-color 0.2s ease;
        }

        .prompt-textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(99, 226, 183, 0.2);
        }

        .prompt-textarea::placeholder {
            color: var(--text-secondary);
        }

        .result-container {
            position: relative;
            width: 100%;
        }

        .result-textarea {
            width: 100%;
            min-height: 250px;
            height: 250px;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            resize: vertical;
            outline: none;
            font-family: inherit;
            background: var(--primary-bg);
            color: var(--text-primary);
            margin: 0;
            box-sizing: border-box;
        }

        /* API Key Input styles */
        .api-key-input {
            width: 100%;
            height: 45px;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.875rem;
            outline: none;
            margin: 0.5rem 0;
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .api-key-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(226, 152, 99, 0.1);
        }

        /* Button styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            font-size: 0.875rem;
            background-color: var(--secondary-bg);
            color: var(--text-primary);
        }

        .btn:hover {
            background-color: var(--button-hover);
            transform: none;
        }

        .btn-primary, .btn-agency {
            background-color: var(--accent-color);
            color: var(--text-primary);
        }

        .btn-success {
            background-color: var(--accent-color);
            color: var(--primary-bg);
            width: 100%;
        }

        .btn-danger,
        .delete-button {
            background-color: #8B7E7E;
            color: var(--primary-bg);
        }

        .btn-danger:hover,
        .delete-button:hover {
            background-color: #766868;
            color: var(--primary-bg);
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-bg);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Utility styles */
        .hidden {
            display: none;
        }

        .error {
            background-color: rgba(139, 126, 126, 0.2);
            border-left: 4px solid #8B7E7E;
            padding: 1rem;
            margin: 1rem 0;
            color: #8B7E7E;
        }

        /* Copy button styles */
        .copy-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 0;
            padding: 0.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .copy-button svg {
            width: 16px;
            height: 16px;
            stroke: var(--text-primary);
        }

        .copy-button:hover {
            background: var(--accent-color);
        }

        .copy-button:hover svg {
            stroke: var(--primary-bg);
        }

        .model-selector {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            outline: none;
            margin-bottom: 1rem;
        }

        /* Add styles for the button bar */
        .button-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background: var(--secondary-bg);
            width: calc(100% - 2rem); /* Account for padding */
            margin-top: 2rem; /* Add space above buttons */
        }

        .button-bar .btn {
            flex: 1;
            min-width: calc(50% - 0.25rem);
        }

        .document-tray {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 0;
        }

        .document-tray-title {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .document-preview-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .document-preview-item {
            display: flex;
            flex-direction: column;
            background: var(--primary-bg);
            border-radius: 0;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .document-preview-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--secondary-bg);
        }

        .document-icon {
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .document-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .document-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .preview-button,
        .use-button {
            background: var(--accent-color);
            color: var(--primary-bg);
            border: none;
            border-radius: 0;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .preview-button:hover,
        .use-button:hover {
            opacity: 0.9;
        }

        .document-content {
            width: 100%;
            min-height: 100px;
            max-height: 200px;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--secondary-bg);
            color: var(--text-primary);
            font-size: 0.875rem;
            resize: vertical;
            overflow-y: auto;
        }

        .prompt-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .prompt-title {
            font-weight: 500;
            color: var(--text-primary);
        }

        .prompt-title-input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            font-size: 0.875rem;
            outline: none;
        }

        .prompt-title-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(226, 152, 99, 0.1);
        }

        /* Result action buttons */
        .result-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .enhance-status {
            font-size: 0.875rem;
            padding: 0.5rem;
            margin-top: 0.5rem;
            background: var(--accent-color);
            color: var(--primary-bg);
            border-radius: 0;
            text-align: center;
            opacity: 0.9;
            transition: all 0.3s ease;
        }

        .enhance-status.error {
            background: #8B7E7E;
        }

        .result-button {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 0;
            padding: 0.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            width: 24px;
            height: 24px;
        }

        .result-button:hover {
            background: var(--accent-color);
            color: var(--primary-bg);
        }

        .result-button svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
        }

        .result-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Scenario styles */
        .scenario-card {
            background: var(--secondary-bg);
            border-radius: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            padding: 1rem;
            min-width: 300px;
            max-width: 400px;
            height: fit-content;
            min-height: 320px; /* Match persona card initial height */
            flex-shrink: 0;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            border: 1px solid var(--border-color);
            border-left: 4px solid #4CAF50; /* Green accent for scenarios */
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-sizing: border-box;
        }

        .scenario-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-color);
        }

        .scenario-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .scenario-title {
            font-weight: 500;
            color: var(--text-primary);
        }

        .scenario-name {
            width: calc(100% - 1rem);
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            outline: none;
            margin: 0 0.5rem 0.5rem 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }

        .scenario-name:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(99, 226, 183, 0.2);
        }

        .scenario-textarea {
            width: calc(100% - 1rem);
            min-height: 150px;
            height: 150px; /* Set initial height to match persona textarea */
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            resize: vertical;
            outline: none;
            font-family: inherit;
            background: var(--primary-bg);
            color: var(--text-primary);
            margin: 0 0.5rem 1rem 0.5rem;
            box-sizing: border-box;
        }

        .scenario-textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(99, 226, 183, 0.2);
        }

        .scenario-textarea::placeholder {
            color: var(--text-secondary);
        }

        /* Scenario Tray styles */
        .scenario-tray {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 0;
        }

        .scenario-selector-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .scenario-selector {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
        }

        .add-scenario-btn {
            background: var(--accent-color);
            color: var(--primary-bg);
            border: none;
            border-radius: 0;
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .add-scenario-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .add-scenario-btn:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .card {
            background-color: #ffffff;
            border-radius: 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 15px;
            width: 300px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .card-content {
            flex-grow: 1;
            font-size: 1rem;
            line-height: 1.5;
            color: #666;
        }

        .scenario-card {
            border-left: 5px solid #4CAF50;  /* Green accent */
        }

        .prompt-card {
            border-left: 5px solid #2196F3;  /* Blue accent */
        }

        .persona-card {
            border-left: 5px solid #FF9800;  /* Orange accent */
        }

        /* Add emoji styles for both cards */
        .prompt-emoji,
        .scenario-emoji {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }

        /* Update headers to accommodate emojis */
        .prompt-header,
        .scenario-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .prompt-title,
        .scenario-title {
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            margin-right: 0.5rem;
        }

        .source-label,
        .persona-label {
            font-size: 1.0rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            padding-left: 0.25rem;
        }

        /* Update the tabs-container and tab-content styles */
        .tabs-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            overflow: hidden; /* Prevent container overflow */
        }

        /* Update the tab-content styles to add padding at the bottom */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 0.5rem;
            padding-bottom: 2rem; /* Add padding at bottom for scrolling content */
            margin-right: -0.5rem;
            width: 100%;
        }

        /* Update the button-bar styles to ensure visibility */
        .button-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background: var(--secondary-bg);
            width: calc(100% - 2rem); /* Account for padding */
            margin-top: 2rem; /* Add space above buttons */
        }

        /* Ensure all content within tabs doesn't cause horizontal scroll */
        .tab-content > * {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Adjust input and textarea widths */
        .api-key-input,
        .model-selector,
        .agency-name-textarea,
        .agency-description-textarea {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .instructions-content {
            padding: 1rem;
            background: var(--primary-bg);
            border-radius: 0;
            border: 1px solid var(--border-color);
        }

        .instructions-section {
            margin-bottom: 1.5rem;
        }

        .instructions-section h3 {
            color: var(--accent-color);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .instructions-section p {
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .instructions-section ul {
            list-style-type: none;
            padding-left: 1rem;
            margin-bottom: 0.75rem;
        }

        .instructions-section li {
            color: var(--text-primary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .instructions-section li::before {
            content: "•";
            color: var(--accent-color);
            position: absolute;
            left: -1rem;
        }

        /* Update the tab buttons to accommodate three tabs */
        .tab-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .tab-button {
            flex: 1;
            padding: 0.75rem 0.5rem;
            font-size: 0.875rem;
            background: var(--secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            background: var(--primary-bg);
            border-color: var(--accent-color);
        }

        .tab-button.active {
            background: var(--accent-color);
            color: var(--text-primary);
            border-color: var(--accent-color);
        }

        /* In the App component, update the tab buttons and add instructions content */
        <div className="tab-buttons">
            <button 
                className={`tab-button ${activeTab === 'settings' ? 'active' : ''}`}
                onClick={() => setActiveTab('settings')}
            >
                ⚙️ Settings
            </button>
            <button 
                className={`tab-button ${activeTab === 'content' ? 'active' : ''}`}
                onClick={() => setActiveTab('content')}
            >
                🎮 Play
            </button>
        </div>

        <div className="tab-content" style={{ display: 'flex', flexDirection: 'column', flex: 1, overflow: 'auto' }}>
            {activeTab === 'settings' && (
                <>
                    <h3 className="section-title"> Models</h3>
                    <input
                        type="password"
                        placeholder="Enter OpenAI API Key"
                        value={apiKey}
                        onChange={(e) => setApiKey(e.target.value)}
                        className="api-key-input"
                    />

                    <div className="model-selector-wrapper">
                        <select 
                            value={model}
                            onChange={(e) => setModel(e.target.value)}
                            className="model-selector"
                        >
                            {OPENAI_MODELS.map(model => (
                                <option key={model} value={model}>{model}</option>
                            ))}
                        </select>
                    </div>

                    <div className="section-separator"></div>

                    <h3 className="section-title">📚 Playgrounds</h3>
                    <PlaygroundTray onLoadPlayground={loadPlayground} />

                    <div className="agency-details">
                        <textarea
                            value={agencyName}
                            onChange={(e) => setAgencyName(e.target.value)}
                            placeholder="Enter Playground Name..."
                            className="agency-name-textarea"
                        />
                        <textarea
                            value={agencyDescription}
                            onChange={(e) => setAgencyDescription(e.target.value)}
                            placeholder="Enter Playground Description..."
                            className="agency-description-textarea"
                        />
                    </div>

                    <div style={{ display: 'flex', gap: '0.5rem', marginTop: '1rem' }}>
                        <input
                            type="file"
                            id="loadAgencyInput"
                            className="hidden"
                            accept=".json"
                            onChange={loadAgency}
                        />
                        <button 
                            onClick={() => document.getElementById('loadAgencyInput').click()} 
                            className="btn btn-agency"
                            style={{ flex: 1 }}
                        >
                            📂 Import Playground
                        </button>
                        <button 
                            onClick={exportAgency} 
                            className="btn btn-agency"
                            style={{ flex: 1 }}
                        >
                            💾 Export Playground
                        </button>
                    </div>
                </>
            )}
            
            {activeTab === 'content' && (
                <div className="content-tab" style={{ display: 'flex', flexDirection: 'column', flex: 1 }}>
                    {/* Upload Components Group */}
                    <div className="upload-content-group">
                        <div className="document-tray-title" style={{ color: 'var(--text-primary)', textTransform: 'uppercase' }}>
                            🎴 Upload Content
                        </div>
                        <input
                            type="file"
                            id="fileInput"
                            className="hidden"
                            accept=".txt,.md,.json,image/*"
                            onChange={handleFileUpload}
                            multiple
                        />
                        <button 
                            onClick={() => document.getElementById('fileInput').click()}
                            className="btn btn-primary"
                            style={{ marginBottom: '1rem' }}
                        >
                            📎 Upload File or Image
                        </button>

                        <div className="tray-container" style={{ display: 'flex', flexDirection: 'column', gap: '1rem', marginBottom: '2rem' }}>
                            <DocumentTray 
                                uploadedDocuments={uploadedDocuments} 
                                onDeleteDocument={(id) => {
                                    setUploadedDocuments(current => current.filter(doc => doc.id !== id));
                                }}
                                onSelectDocument={(content) => setSourceContent(content)}
                            />

                            <div className="document-tray-title" style={{ color: 'var(--text-primary)', textTransform: 'uppercase' }}>
                                🎴 Select Sources
                            </div>
                            <textarea
                                value={sourceContent}
                                onChange={(e) => setSourceContent(e.target.value)}
                                placeholder="Enter or upload source content..."
                                style={{ 
                                    width: '100%',
                                    minHeight: '200px',
                                    padding: '0.75rem',
                                    borderRadius: '0',
                                    border: '1px solid var(--border-color)',
                                    background: 'var(--primary-bg)',
                                    color: 'var(--text-primary)',
                                    resize: 'vertical'
                                }}
                            />

                            <ImageTray uploadedImages={uploadedImages} onDeleteImage={deleteImage} />
                        </div>
                    </div>

                    {/* Card Selection Group */}
                    <div className="document-tray-title" style={{ color: 'var(--text-primary)', textTransform: 'uppercase' }}>
                        🎴 Card Selection
                    </div>
                    <div className="selection-trays" style={{ display: 'flex', flexDirection: 'column', gap: '1rem', marginBottom: '1rem' }}>
                        <ScenarioTray onAddScenario={addScenarioCard} />
                        <PersonaTray onAddPersona={addPersonaCard} />
                        <PromptTray onAddPrompt={(template) => {
                            const newPrompt = {
                                ...template,
                                id: Date.now(),
                                result: '',
                                source: 'SOURCE',
                                sources: ['SOURCE'],
                                sourceType: 'text',
                                selectedImage: null,
                                selectedPersonas: []
                            };
                            setPrompts([...prompts, newPrompt]);
                        }} />
                    </div>
                </div>
            )}
        </div>

        {error && <div className="error">{error}</div>}
        
        {activeTab === 'content' && (
            <div className="button-bar">
                <button onClick={addPrompt} className="btn btn-agency">
                    📝 Add Prompt Card
                </button>
                <button onClick={runAllPrompts} className="btn btn-agency">
                    🚀 Run All
                </button>
                <button onClick={exportContent} className="btn btn-agency">
                    📤 Export Content
                </button>
            </div>
        )}
    </div>

    {/* Add these styles in the <style> section */

    .playground-tray {
        margin-top: 1rem;
        padding: 1rem;
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 0;
    }
    .playground-selector-container {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .playground-selector {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 0;
        background: var(--primary-bg);
        color: var(--text-primary);
        font-size: 0.875rem;
    }

    .add-playground-btn {
        background: var(--accent-color);
        color: var(--primary-bg);
        border: none;
        border-radius: 0;
        padding: 0.5rem 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-size: 1.25rem;
        line-height: 1;
    }

    .add-playground-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .add-playground-btn:hover:not(:disabled) {
        opacity: 0.9;
        transform: translateY(-2px);
    }

    .section-separator {
        height: 1px;
        background: var(--border-color);
        margin: 1.5rem 0;
        width: 100%;
    }

    .section-title {
        font-size: 1rem;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Add new styles for scenario fields */
    .scenario-section {
        margin-bottom: 1.5rem;
    }

    .scenario-section-title {
        font-weight: 500;
        color: var(--accent-color);
        margin-bottom: 0.75rem;
        font-size: 0.875rem;
        text-transform: uppercase;
    }

    .scenario-field {
        margin-bottom: 1rem;
    }

    .scenario-field-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
        text-transform: capitalize;
    }

    .scenario-textarea {
        width: 100%;
        min-height: 60px;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0;
        resize: vertical;
        outline: none;
        font-family: inherit;
        background: var(--primary-bg);
        color: var(--text-primary);
        font-size: 0.875rem;
        box-sizing: border-box;
    }

    .scenario-textarea:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 2px rgba(99, 226, 183, 0.2);
    }

    /* Add these styles for the slider toggle */
    .source-mode-toggle {
        display: flex;
        align-items: center;
        gap: 0.25rem;  /* Reduced from 0.75rem */
        font-size: 0.65rem;  /* Reduced from 0.75rem */
        margin-top: 0.25rem;  /* Reduced space from text area above */
        margin-bottom: 1rem;  /* Space before next section */
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 20px;  /* Reduced from 28px */
        height: 12px;  /* Reduced from 16px */
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--border-color);
        transition: .4s;
        border-radius: 34px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 8px;  /* Reduced from 12px */
        width: 8px;   /* Reduced from 12px */
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
        background-color: var(--accent-color);
    }

    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(8px);  /* Reduced from 12px */
    }

    .toggle-switch:hover .toggle-slider {
        background-color: var(--accent-color);
        opacity: 0.8;
    }

    .toggle-switch input:checked:hover + .toggle-slider {
        opacity: 0.8;
    }

    .source-mode-toggle span {
        font-size: 0.875rem;
        color: var(--text-primary);
    }

    .source-mode-toggle span:first-child {
        font-weight: 500;
    }

    .source-selector {
        margin-bottom: 1rem;
    }

    .source-selector option {
        padding: 0.5rem 0.5rem 0.5rem 2rem;
        cursor: pointer;
        position: relative;
    }

    .source-selector option:checked,
    .source-selector option:hover:checked,
    .source-selector option[selected] {
        background: var(--accent-color) !important;
        color: white !important;
        -webkit-appearance: none;
        appearance: none;
    }

    .source-selector option:checked::before,
    .source-selector option[selected]::before {
        content: "✓";
        position: absolute;
        left: 0.5rem;
        color: white;
        font-weight: bold;
    }

    .source-selector option:hover {
        background: rgba(226, 152, 99, 0.1);
    }

    .persona-selector {
        margin-bottom: 1rem;
    }

    .persona-selector option {
        padding: 0.5rem 0.5rem 0.5rem 2rem;
        cursor: pointer;
        position: relative;
    }

    .persona-selector option:checked,
    .persona-selector option:hover:checked,
    .persona-selector option[selected] {
        background: var(--accent-color) !important;
        color: white !important;
        -webkit-appearance: none;
        appearance: none;
    }

    .persona-selector option:checked::before,
    .persona-selector option[selected]::before {
        content: "✓";
        position: absolute;
        left: 0.5rem;
        color: white;
        font-weight: bold;
    }

    .persona-selector option:hover {
        background: rgba(226, 152, 99, 0.1);
    }

    .component-divider {
        height: 1px;
        background-color: var(--border-color);
        margin: 1rem 0;
        opacity: 0.5;
    }

    /* Prompt Selector styles */
    .prompt-tray {
        margin-top: 1rem;
        padding: 1rem;
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 0;
    }

    .prompt-selector-container {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .prompt-selector {
        flex: 1;
        padding: 0.75rem;  /* Increased from 0.5rem */
        border: 1px solid var(--border-color);
        border-radius: 0;
        background: var(--primary-bg);
        color: var(--text-primary);
        font-size: 0.875rem;  /* Added to match persona selector */
        transition: all 0.2s ease;  /* Added transition */
        cursor: pointer;
        -webkit-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 1em;
        padding-right: 2.5rem;
    }

    .prompt-selector:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 2px rgba(226, 152, 99, 0.1);
        outline: none;
    }

    .prompt-selector option {
        padding: 0.5rem;
        font-size: 0.875rem;
    }

    .add-prompt-btn {
        background: var(--accent-color);
        color: var(--primary-bg);
        border: none;
        border-radius: 0;
        padding: 0.5rem 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .add-prompt-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .add-prompt-btn:hover:not(:disabled) {
        opacity: 0.9;
    }

    /* Add these new styles in the style section */
    .floating-gear {
        position: fixed;
        top: 1rem;
        right: 1rem;
        width: 48px;
        height: 48px;
        background: var(--accent-color);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        color: white;
        padding: 0;
    }

    .floating-gear:hover {
        transform: rotate(90deg);
        opacity: 0.9;
    }

    .floating-gear svg {
        width: 24px;
        height: 24px;
        stroke: currentColor;
        fill: none;
    }

    /* Remove any duplicate floating gear button HTML in the style section */

    /* Add these styles for the settings panel */
    .settings-panel {
        position: fixed;
        top: 0;
        right: -420px; /* Start off-screen */
        width: 400px;
        height: 100vh;
        background: var(--secondary-bg);
        border-left: 1px solid var(--border-color);
        padding: 1.5rem;
        box-shadow: -2px 0 8px rgba(0, 0, 0, 0.2);
        transition: right 0.3s ease;
        z-index: 9998;
        overflow-y: auto;
    }

    .settings-panel.open {
        right: 0;
    }

    .settings-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2rem;
    }

    .settings-panel-title {
        font-size: 1.25rem;
        font-weight: 500;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .settings-panel-close {
        background: none;
        border: none;
        color: var(--text-primary);
        cursor: pointer;
        padding: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s ease;
    }

    .settings-panel-close:hover {
        transform: rotate(90deg);
    }

    .settings-section {
        margin-bottom: 2rem;
    }

    .settings-section-title {
        font-size: 1rem;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Update the floating gear styles */
    .floating-gear {
        position: fixed;
        top: 1rem;
        right: 1rem;
        width: 48px;
        height: 48px;
        background: var(--accent-color);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        color: white;
        padding: 0;
    }

    .floating-gear:hover {
        transform: rotate(90deg);
        opacity: 0.9;
    }

    .floating-gear svg {
        width: 24px;
        height: 24px;
        stroke: currentColor;
        fill: none;
    }

    /* Remove all existing floating-gear styles and add this single definition */
    .floating-gear {
        position: fixed;
        top: 1rem;
        right: 1rem;
        width: 48px;
        height: 48px;
        background: var(--accent-color);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        color: white;
        padding: 0;
    }

    .floating-gear:hover {
        transform: rotate(90deg);
        opacity: 0.9;
    }

    .floating-gear svg {
        width: 24px;
        height: 24px;
        stroke: currentColor;
        fill: none;
    }

    /* Add new chat window styles */
    .chat-toggle-button {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 48px;
        height: 48px;
        background: var(--accent-color);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999999; /* Increased z-index to ensure visibility */
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        color: white;
        padding: 0;
        pointer-events: auto; /* Ensure clickability */
    }

    .chat-toggle-button:hover {
        transform: translateY(-2px);
        opacity: 0.9;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .chat-toggle-button svg {
        width: 24px;
        height: 24px;
        stroke: currentColor;
        fill: none;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
    }

    .chat-window {
        position: fixed;
        bottom: 6rem;
        right: 2rem;
        width: 400px;
        height: 600px;
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        z-index: 99998;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        transform-origin: bottom right;
    }

    .chat-window.hidden {
        transform: scale(0);
        opacity: 0;
    }

    .chat-titlebar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background: var(--accent-color);
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        color: white;
    }

    .chat-title {
        font-weight: 500;
        font-size: 1rem;
    }

    .chat-titlebar-actions {
        display: flex;
        gap: 0.5rem;
    }

    .chat-titlebar-button {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.8;
        transition: opacity 0.2s ease;
    }

    .chat-titlebar-button:hover {
        opacity: 1;
    }

    .chat-titlebar-button svg {
        width: 16px;
        height: 16px;
        stroke: currentColor;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .chat-message {
        display: flex;
        gap: 0.75rem;
        align-items: flex-start;
    }

    .chat-message.user {
        flex-direction: row-reverse;
    }

    .chat-message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--accent-color);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 500;
        flex-shrink: 0;
    }

    .chat-message-content {
        background: var(--primary-bg);
        padding: 0.75rem 1rem;
        border-radius: 12px;
        max-width: 80%;
        color: var(--text-primary);
    }

    .chat-message.user .chat-message-content {
        background: var(--accent-color);
        color: white;
    }

    .chat-input-container {
        padding: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .chat-input {
        width: 100%;
        min-height: 60px;
        max-height: 150px;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: var(--primary-bg);
        color: var(--text-primary);
        resize: vertical;
        outline: none;
        font-family: inherit;
        font-size: 0.875rem;
    }

    .chat-input:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.1);
    }

    .chat-message-content[contenteditable="true"] {
        outline: none;
        cursor: text;
    }

    .chat-message-content[contenteditable="true"]:focus {
        box-shadow: 0 0 0 2px var(--accent-color);
    }

    /* Add padding to the last child in the fixed-section to ensure space after buttons */
    .fixed-section > *:last-child {
        padding-bottom: 1rem;
    }

    /* Add padding to the last child before the button bar */
    .tab-content > *:not(.button-bar):last-child {
        margin-bottom: 2rem; /* Add space before buttons */
    }

    /* Update source selector styles */
    .source-selector {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 0;
        background: var(--primary-bg);
        color: var(--text-primary);
        outline: none;
        margin-bottom: 0.5rem;
        min-height: 120px; /* Add minimum height */
        max-height: 200px;
        overflow-y: auto;
    }

    /* Update persona selector styles */
    .persona-selector {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 0;
        background: var(--primary-bg);
        color: var(--text-primary);
        outline: none;
        margin-bottom: 0.5rem;
        min-height: 120px; /* Add minimum height */
        max-height: 200px;
        overflow-y: auto;
    }

    /* Add flex layout to prompt card content */
    .prompt-card {
        display: flex;
        flex-direction: column;
    }

    /* Make source and persona sections maintain size */
    .source-section,
    .persona-section {
        flex-shrink: 0; /* Prevent sections from shrinking */
        min-height: 160px; /* Include labels and margins */
        margin-bottom: 1rem;
    }

    /* Make result section flexible */
    .result-container {
        flex: 1;
        min-height: 250px;
        display: flex;
        flex-direction: column;
    }

    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        // Add this constant at the top of your script, before any other code
        const PERSONAS = [
            {
                id: 'executive',
                name: 'Executive',
                emoji: '👔',
                description: 'Strategic, high-level communication focused on business impact and ROI'
            },
            {
                id: 'technical',
                name: 'Technical Expert',
                emoji: '🔧',
                description: 'Detailed, precise communication with technical specifications and implementation details'
            },
            {
                id: 'creative',
                name: 'Creative Director',
                emoji: '🎨',
                description: 'Visual and conceptual thinking with emphasis on design and innovation'
            },
            {
                id: 'marketer',
                name: 'Marketing Specialist',
                emoji: '📢',
                description: 'Persuasive communication focused on value proposition and audience engagement'
            },
            {
                id: 'customer',
                name: 'Customer Service',
                emoji: '🤝',
                description: 'Empathetic, solution-oriented communication focused on user satisfaction'
            },
            {
                id: 'analyst',
                name: 'Data Analyst',
                emoji: '📊',
                description: 'Analytical communication with focus on metrics, trends, and insights'
            },
            {
                id: 'trainer',
                name: 'Training Specialist',
                emoji: '📚',
                description: 'Educational communication focused on learning outcomes and skill development'
            },
            {
                id: 'hr',
                name: 'HR Professional',
                emoji: '👥',
                description: 'People-focused communication emphasizing policies, culture, and employee relations'
            }
        ];

        // Constants
        const OPENAI_MODELS = [
            "gpt-4o",
            "gpt-4-turbo-preview",
            "gpt-4",
            "gpt-3.5-turbo"
        ];

        const SUPPORTED_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/gif'];
        const MAX_IMAGE_SIZE = 10 * 1024 * 1024; // 10MB

        // Update the FileProcessor utility
        const FileProcessor = {
            async processImage(file) {
                if (!file || !SUPPORTED_IMAGE_TYPES.includes(file.type)) {
                    throw new Error('Unsupported image type');
                }

                if (file.size > MAX_IMAGE_SIZE) {
                    throw new Error('Image size too large (max 10MB)');
                }

                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = () => reject(new Error('Error reading image'));
                    reader.readAsDataURL(file);
                });
            },

            // Remove the processFile method since we're handling text files directly
        };

        // Add these constants at the top of your script
        const SUPPORTED_FILE_TYPES = [
            'text/plain',
            'text/markdown',
            'application/json',
            ...SUPPORTED_IMAGE_TYPES
        ];

        // React Components
        const CopyButton = ({ text }) => {
            const [copied, setCopied] = React.useState(false);
            
            const copyToClipboard = async () => {
                try {
                    await navigator.clipboard.writeText(text);
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                } catch (err) {
                    console.error('Failed to copy:', err);
                }
            };

            return (
                <button 
                    onClick={copyToClipboard} 
                    className="copy-button" 
                    title={copied ? "Copied!" : "Copy to clipboard"}
                >
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        {copied ? (
                            <path d="M20 6L9 17l-5-5"/>
                        ) : (
                            <>
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </>
                        )}
                    </svg>
                </button>
            );
        };

        const ProcessingIndicator = ({ isVisible }) => (
            <div className={`processing-file ${!isVisible ? 'hidden' : ''}`}>
                <h3>Processing File...</h3>
                <p>Please wait while we process your content</p>
            </div>
        );

        const PersonaCard = ({ persona, onUpdate, onDelete, apiKey }) => {
            return (
                <div className="persona-card">
                    <div className="persona-header">
                        <span className="persona-emoji">{persona.emoji}</span>
                        <span className="persona-title">PERSONA CARD</span>
                        <input 
                            type="text" 
                            className="persona-name" 
                            value={persona.name} 
                            onChange={(e) => onUpdate(persona.cardId, { name: e.target.value })}
                        />
                    </div>
                    
                    <textarea
                        value={persona.description}
                        onChange={(e) => onUpdate(persona.cardId, { description: e.target.value })}
                        className="persona-textarea"
                        spellCheck="true"
                        rows="6"
                    />
                    
                    <button 
                        onClick={() => onDelete(persona.cardId)}
                        className="btn btn-danger"
                    >
                        Delete
                    </button>
                </div>
            );
        };

        const PersonaTray = ({ onAddPersona }) => {
            const [selectedPersona, setSelectedPersona] = React.useState('');

            const handleAddPersona = () => {
                if (selectedPersona) {
                    const persona = PERSONAS.find(p => p.id === selectedPersona);
                    onAddPersona({
                        ...persona,
                        cardId: Date.now()
                    });
                    setSelectedPersona('');
                }
            };

            return (
                <div className="persona-tray">
                    <div className="persona-selector-container">
                        <select 
                            value={selectedPersona}
                            onChange={(e) => setSelectedPersona(e.target.value)}
                            className="persona-selector"
                        >
                            <option value="">👥 Select Audience...</option>
                            {PERSONAS.map(persona => (
                                <option key={persona.id} value={persona.id}>
                                    {persona.emoji} {persona.name}
                                </option>
                            ))}
                        </select>
                        <button 
                            onClick={handleAddPersona}
                            className="add-persona-btn"
                            disabled={!selectedPersona}
                        >
                            +
                        </button>
                    </div>
                </div>
            );
        };
        const PromptCard = ({ prompt, sourceOptions, loading, onUpdate, onDelete, onRun, uploadedImages, uploadedDocuments, apiKey, personaCards, sourceContent, onSourceSelect }) => {
            const [enhancing, setEnhancing] = React.useState(false);
            const [enhanceStatus, setEnhanceStatus] = React.useState('');

            const handleEnhance = async () => {
                if (!prompt.result) return;
                
                setEnhancing(true);
                try {
                    const selectedImage = uploadedImages.find(img => img.id === prompt.selectedImage);
                    if (!selectedImage) {
                        throw new Error('Selected image not found');
                    }

                    setEnhanceStatus('Sending analysis request...');
                    
                    // Ensure the image URL is base64
                    const imageUrl = selectedImage.url; // This should already be base64 from our upload process

                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`,
                        },
                        body: JSON.stringify({
                            model: "gpt-4o",
                            messages: [
                                {
                                    role: "user",
                                    content: [
                                        { 
                                            type: "text", 
                                            text: prompt.text 
                                        },
                                        {
                                            type: "image_url",
                                            image_url: {
                                                url: imageUrl,
                                                detail: "high" // Changed from "auto" to "high" for better analysis
                                            }
                                        }
                                    ]
                                }
                            ],
                            max_tokens: 1000 // Increased from 500 for more detailed responses
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                    }

                    setEnhanceStatus('Processing response...');
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error.message);
                    }
                    
                    const enhancedResult = data.choices[0].message.content;
                    onUpdate(prompt.id, { result: enhancedResult });
                    
                    setEnhanceStatus('Analysis complete!');
                    setTimeout(() => setEnhanceStatus(''), 2000);
                } catch (error) {
                    console.error('Analysis error:', error);
                    setEnhanceStatus(`Error: ${error.message}`);
                    setTimeout(() => setEnhanceStatus(''), 3000);
                } finally {
                    setEnhancing(false);
                }
            };

            // When the component mounts or when prompt.id changes, set a default title if none exists
            React.useEffect(() => {
                if (!prompt.title || prompt.title === `${prompt.id}`) {
                    onUpdate(prompt.id, { title: `PROMPT${prompt.id}` });
                }
            }, [prompt.id]);

            const isImageMode = prompt.sourceType === 'image';

            return (
                <div className={`prompt-card ${isImageMode ? 'image-mode' : ''}`}>
                    <div className="prompt-header">
                        <span className="prompt-emoji">📝</span>
                        <span className="prompt-title">PROMPT CARD</span>
                        <input
                            type="text"
                            className="prompt-title-input"
                            value={prompt.title || `PROMPT${prompt.id}`}
                            onChange={(e) => onUpdate(prompt.id, { title: e.target.value })}
                            placeholder={`PROMPT${prompt.id}`}
                        />
                    </div>
            
                    <div className="source-type-selector">
                        <button 
                            className={`source-type-button ${prompt.sourceType === 'text' ? 'active' : ''}`}
                            onClick={() => onUpdate(prompt.id, { sourceType: 'text' })}
                        >
                            Text
                        </button>
                        <button 
                            className={`source-type-button ${prompt.sourceType === 'image' ? 'active' : ''}`}
                            onClick={() => onUpdate(prompt.id, { sourceType: 'image' })}
                        >
                            Image
                        </button>
                    </div>

                    {isImageMode ? (
                        <>
                            <div className="source-label">Select Image</div>
                            <select
                                value={prompt.selectedImage || ''}
                                onChange={(e) => {
                                    const value = e.target.value ? parseInt(e.target.value) : '';
                                    onUpdate(prompt.id, { selectedImage: value });
                                }}
                                className="source-selector"
                            >
                                <option value="">Select an image...</option>
                                {uploadedImages.map(img => (
                                    <option key={img.id} value={img.id}>
                                        {img.name || `Image ${img.id}`}
                                    </option>
                                ))}
                            </select>
                            {prompt.selectedImage && (
                                <div className="image-preview-container">
                                    <img 
                                        src={uploadedImages.find(img => img.id === parseInt(prompt.selectedImage))?.url} 
                                        alt="Selected" 
                                        className="image-preview"
                                    />
                                </div>
                            )}
                        </>
                    ) : (
                        <>
                            <div className="source-label">SELECT SOURCES</div>
                            <select 
                                multiple
                                value={prompt.sources || ['SOURCE']}
                                onChange={(e) => {
                                    const selectedOptions = Array.from(e.target.selectedOptions).map(option => option.value);
                                    onUpdate(prompt.id, { 
                                        ...prompt, 
                                        sources: selectedOptions,
                                        source: selectedOptions.includes('SOURCE') ? sourceContent : prompt.source
                                    });
                                }}
                                className="source-selector"
                            >
                                <option value="SOURCE">SOURCE</option>
                                {uploadedDocuments.map(doc => (
                                    <option key={doc.id} value={`DOC-${doc.id}`}>
                                        📄 {doc.name}
                                    </option>
                                ))}
                                {sourceOptions.map(p => (
                                    <option key={p.id} value={`RESULT${p.id}`}>
                                        💬 Result from Prompt {p.id}
                                    </option>
                                ))}
                            </select>
                        </>
                    )}

                    <div className="persona-label">SELECT PERSONAS</div>
                    <select
                        multiple
                        value={prompt.selectedPersonas || []}
                        onChange={(e) => {
                            const selectedOptions = Array.from(e.target.selectedOptions).map(option => option.value);
                            onUpdate(prompt.id, { ...prompt, selectedPersonas: selectedOptions });
                        }}
                        className="source-selector"
                    >
                        {personaCards.map(persona => (
                            <option key={persona.cardId} value={persona.cardId}>
                                {persona.direction === 'from' ? '🗣️ FROM: ' : '👥 TO: '} {persona.name}
                            </option>
                        ))}
                    </select>
            
                    <div className="prompt-label">PROMPT</div>
                    <textarea
                        value={prompt.text}
                        onChange={(e) => onUpdate(prompt.id, { text: e.target.value })}
                        placeholder={isImageMode ? "Enter your image analysis prompt..." : "Enter your prompt..."}
                        className="prompt-textarea"
                        spellCheck="true"
                        autoComplete="off"
                        rows="6"
                    />
            
                    <div className="result-label">RESULT{prompt.id}</div>
            
                            <div className="result-container">
                                <textarea
                                    value={prompt.result}
                                    onChange={(e) => onUpdate(prompt.id, { result: e.target.value })}
                                    placeholder="Results will appear here..."
                                    className="result-textarea"
                                    readOnly
                                    rows="8"
                                />
                                <div className="result-actions">
                                    <button
                                        className="result-button"
                                        onClick={handleEnhance}
                                        title="Enhance content"
                                        disabled={!prompt.result || enhancing}
                                    >
                                        {enhancing ? (
                                            <div className="loading-spinner"></div>
                                        ) : (
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83" strokeWidth="2" strokeLinecap="round"/>
                                            </svg>
                                        )}
                                    </button>
                                    <button
                                        className="result-button"
                                        onClick={() => navigator.clipboard.writeText(prompt.result)}
                                        title="Copy to clipboard"
                                    >
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M8 4v12a2 2 0 002 2h8a2 2 0 002-2V7.242a2 2 0 00-.602-1.43L16.083 2.57A2 2 0 0014.685 2H10a2 2 0 00-2 2z" strokeWidth="2" strokeLinecap="round"/>
                                            <path d="M16 18v2a2 2 0 01-2 2H6a2 2 0 01-2-2V9a2 2 0 012-2h2" strokeWidth="2" strokeLinecap="round"/>
                                        </svg>
                                    </button>
                                    <button
                                        className="result-button"
                                        onClick={() => onUpdate(prompt.id, { result: '' })}
                                        title="Clear result"
                                    >
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M19 7l-7 7m0 0l-7-7m7 7V4" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                        </svg>
                                    </button>
                                </div>
                        {enhanceStatus && (
                            <div className={`enhance-status ${enhanceStatus.includes('Error') ? 'error' : ''}`}>
                                {enhanceStatus}
                            </div>
                        )}
                    </div>
            
                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                            <button
                            onClick={() => onRun(prompt.id)} 
                            className="btn btn-success"
                            disabled={loading || (isImageMode && !prompt.selectedImage)}
                        >
                            {loading ? (
                                <span className="loading-spinner" />
                            ) : (
                                isImageMode ? 'Analyze Image' : 'Run'
                            )}
                        </button>
                        <button 
                            onClick={() => onDelete(prompt.id)}
                            className="btn btn-danger"
                        >
                            Delete
                        </button>
                    </div>
                </div>
            );
        };

        const ImageTray = ({ uploadedImages, onDeleteImage }) => (
            <div className="image-tray">
                <div className="image-tray-title">Uploaded Images</div>
                <div className="image-preview-list">
                    {uploadedImages.map(image => (
                        <div key={image.id} className="image-preview-item">
                            <img src={image.url} alt={image.name} />
                            <button 
                                className="delete-button"
                                onClick={() => onDeleteImage(image.id)}
                            >
                                ×
                            </button>
                        </div>
                    ))}
                </div>
            </div>
        );

        const DocumentTray = ({ uploadedDocuments, onDeleteDocument, onSelectDocument }) => {
            const [expandedDoc, setExpandedDoc] = React.useState(null);

            return (
                <div className="document-tray">
                    <div className="document-tray-title">Uploaded Documents</div>
                    <div className="document-preview-list">
                        {uploadedDocuments.map(doc => (
                            <div key={doc.id} className="document-preview-item">
                                <div className="document-preview-content">
                                    <span className="document-icon">📄</span>
                                    <span className="document-name" onClick={() => onSelectDocument(doc.content)}>
                                        {doc.name}
                                    </span>
                                </div>
                                <div className="document-actions">
                                    <button 
                                        className="preview-button"
                                        onClick={() => setExpandedDoc(expandedDoc === doc.id ? null : doc.id)}
                                    >
                                        {expandedDoc === doc.id ? 'Hide' : 'Preview'}
                                    </button>
                                    <button 
                                        className="use-button"
                                        onClick={() => onSelectDocument(doc.content)}
                                    >
                                        Use
                                    </button>
                                    <button 
                                        className="delete-button"
                                        onClick={() => onDeleteDocument(doc.id)}
                                    >
                                        ×
                                    </button>
                                </div>
                                {expandedDoc === doc.id && (
                                    <div className="document-content">
                                        <textarea
                                            readOnly
                                            value={doc.content}
                                            className="document-content-preview"
                                        />
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Update the SCENARIOS constant with populated fields
        const SCENARIOS = [
            {
                id: 'content-strategy',
                emoji: '📝',
                name: 'Content Strategy',
                scenario: {
                    situation: 'Developing a comprehensive content strategy for a growing business',
                    description: 'Business seeks to establish thought leadership and increase market presence through content',
                    context: 'Competitive market with increasing demand for high-quality, authoritative content',
                    challenges: 'Limited resources, need for consistent quality, content distribution challenges',
                    opportunities: 'Growing audience interest, emerging content platforms, partnership possibilities'
                },
                objective: {
                    description: 'Create and implement a scalable content strategy that positions the business as an industry authority',
                    alignment: 'Align content with business goals, audience needs, and market opportunities',
                    measurable_outcomes: 'Increased engagement metrics, lead generation, audience growth targets'
                }
            },
            {
                id: 'market-expansion',
                emoji: '🌐',
                name: 'Market Expansion',
                scenario: {
                    situation: 'Planning expansion into new market segments or geographical regions',
                    description: 'Organization looking to capture new market opportunities and diversify revenue streams',
                    context: 'Changing market dynamics, emerging opportunities in adjacent markets',
                    challenges: 'Market entry barriers, resource allocation, competitive landscape',
                    opportunities: 'Untapped customer segments, technological advantages, strategic partnerships'
                },
                objective: {
                    description: 'Successfully enter and establish presence in new market segments',
                    alignment: 'Strategic market positioning, resource optimization, risk management',
                    measurable_outcomes: 'Market share targets, revenue goals, customer acquisition metrics'
                }
            },
            {
                id: 'digital-transformation',
                emoji: '💻',
                name: 'Digital Transformation',
                scenario: {
                    situation: 'Implementing digital transformation initiatives across organization',
                    description: 'Business modernizing operations and customer experience through digital technologies',
                    context: 'Industry-wide digital adoption, changing customer expectations',
                    challenges: 'Technical complexity, change management, skill gaps',
                    opportunities: 'Operational efficiency, enhanced customer experience, data-driven insights'
                },
                objective: {
                    description: 'Transform key business processes through digital technologies',
                    alignment: 'Technology adoption roadmap, stakeholder engagement, capability building',
                    measurable_outcomes: 'Process efficiency metrics, digital adoption rates, ROI targets'
                }
            },
            {
                id: 'customer-experience',
                emoji: '🤝',
                name: 'Customer Experience',
                scenario: {
                    situation: 'Enhancing customer experience across all touchpoints',
                    description: 'Organization focusing on improving customer satisfaction and loyalty',
                    context: 'Increasing customer expectations, competitive service landscape',
                    challenges: 'Consistency across channels, personalization needs, feedback integration',
                    opportunities: 'Customer loyalty programs, personalized experiences, service innovation'
                },
                objective: {
                    description: 'Deliver exceptional customer experience that drives loyalty and advocacy',
                    alignment: 'Customer journey optimization, service excellence, feedback loops',
                    measurable_outcomes: 'Customer satisfaction scores, retention rates, advocacy metrics'
                }
            },
            {
                id: 'innovation-initiative',
                emoji: '💡',
                name: 'Innovation Initiative',
                scenario: {
                    situation: 'Launching new innovation initiatives to drive growth',
                    description: 'Organization implementing innovation programs to maintain competitive advantage',
                    context: 'Rapid technological change, evolving market needs',
                    challenges: 'Innovation culture, resource constraints, risk management',
                    opportunities: 'New product development, process improvements, market differentiation'
                },
                objective: {
                    description: 'Foster innovation culture and deliver breakthrough solutions',
                    alignment: 'Innovation framework, cross-functional collaboration, rapid experimentation',
                    measurable_outcomes: 'Innovation pipeline metrics, implementation success rates, impact assessment'
                }
            }
        ];

        // React Components
        const ScenarioCard = ({ scenario, onUpdate, onDelete, apiKey }) => {
            const updateField = (section, field, value) => {
                const updatedScenario = {
                    ...scenario,
                    [section]: {
                        ...scenario[section],
                        [field]: value
                    }
                };
                onUpdate(scenario.cardId, updatedScenario);
            };

            return (
                <div className="scenario-card">
                    <div className="scenario-header">
                        <span className="scenario-emoji">🎯</span>
                        <span className="scenario-title">SCENARIO CARD</span>
                    </div>

                    <div className="scenario-section">
                        <div className="scenario-section-title">Scenario</div>
                        
                        <div className="scenario-field">
                            <div className="scenario-field-label">Situation</div>
                            <textarea
                                className="scenario-textarea"
                                value={scenario.scenario?.situation || ''}
                                onChange={(e) => updateField('scenario', 'situation', e.target.value)}
                                placeholder="Describe the current environment and challenges..."
                            />
                        </div>

                        <div className="scenario-field">
                            <div className="scenario-field-label">Description</div>
                            <textarea
                                className="scenario-textarea"
                                value={scenario.scenario?.description || ''}
                                onChange={(e) => updateField('scenario', 'description', e.target.value)}
                                placeholder="List factors or conditions influencing the scenario..."
                            />
                        </div>

                        <div className="scenario-field">
                            <div className="scenario-field-label">Context</div>
                            <textarea
                                className="scenario-textarea"
                                value={scenario.scenario?.context || ''}
                                onChange={(e) => updateField('scenario', 'context', e.target.value)}
                                placeholder="Key challenges or obstacles faced..."
                            />
                        </div>

                        <div className="scenario-field">
                            <div className="scenario-field-label">Challenges</div>
                            <textarea
                                className="scenario-textarea"
                                value={scenario.scenario?.challenges || ''}
                                onChange={(e) => updateField('scenario', 'challenges', e.target.value)}
                                placeholder="List specific challenges faced in the scenario..."
                            />
                        </div>
                    </div>

                    <div className="scenario-section">
                        <div className="scenario-section-title">Objective</div>
                        
                        <div className="scenario-field">
                            <div className="scenario-field-label">Description</div>
                            <textarea
                                className="scenario-textarea"
                                value={scenario.objective?.description || ''}
                                onChange={(e) => updateField('objective', 'description', e.target.value)}
                                placeholder="Description of the strategies to achieve the objectives..."
                            />
                        </div>

                        <div className="scenario-field">
                            <div className="scenario-field-label">Alignment</div>
                            <textarea
                                className="scenario-textarea"
                                value={scenario.objective?.alignment || ''}
                                onChange={(e) => updateField('objective', 'alignment', e.target.value)}
                                placeholder="Specific tactics or actions to be implemented..."
                            />
                        </div>

                        <div className="scenario-field">
                            <div className="scenario-field-label">Measurable Outcomes</div>
                            <textarea
                                className="scenario-textarea"
                                value={scenario.objective?.measurable_outcomes || ''}
                                onChange={(e) => updateField('objective', 'measurable_outcomes', e.target.value)}
                                placeholder="Plans for addressing potential risks or obstacles..."
                            />
                        </div>
                    </div>

                    <button 
                        onClick={() => onDelete(scenario.cardId)}
                        className="btn btn-danger"
                    >
                        Delete
                    </button>
                </div>
            );
        };

        const ScenarioTray = ({ onAddScenario }) => {
            const [selectedScenario, setSelectedScenario] = React.useState('');

            const handleAddScenario = () => {
                if (selectedScenario) {
                    const baseScenario = SCENARIOS.find(s => s.id === selectedScenario);
                    const newScenario = {
                        ...baseScenario,
                        cardId: Date.now(),
                        scenario: { ...baseScenario.scenario },
                        objective: { ...baseScenario.objective }
                    };
                    onAddScenario(newScenario);
                    setSelectedScenario('');
                }
            };

            return (
                <div className="scenario-tray">
                    <div className="scenario-selector-container">
                        <select 
                            value={selectedScenario}
                            onChange={(e) => setSelectedScenario(e.target.value)}
                            className="scenario-selector"
                        >
                            <option value="">🎯 Select Scenario...</option>
                            {SCENARIOS.map(scenario => (
                                <option key={scenario.id} value={scenario.id}>
                                    {scenario.emoji} {scenario.name}
                                </option>
                            ))}
                        </select>
                        <button 
                            onClick={handleAddScenario}
                            className="add-persona-btn"
                            disabled={!selectedScenario}
                        >
                            +
                        </button>
                    </div>
                </div>
            );
        };

        // Add this constant near the other constants at the top of the script
        const PROMPT_TEMPLATES = [
            {
                id: 'empty',
                name: 'Empty Prompt Card',
                emoji: '✨',
                text: ''
            },
            {
                id: 'summary',
                name: 'Content Summary',
                emoji: '📝',
                text: 'Please provide a comprehensive summary, highlighting the key points and main ideas'
            },
            {
                id: 'analysis',
                name: 'Detailed Analysis',
                emoji: '🔍',
                text: 'Please perform a detailed analysis, including:\n1. Main themes and concepts\n2. Key arguments or positions\n3. Supporting evidence\n4. Potential implications'
            },
            {
                id: 'actionItems',
                name: 'Action Items',
                emoji: '✅',
                text: 'Identify and list specific, actionable items that should be addressed'
            },
            {
                id: 'keyInsights',
                name: 'Key Insights',
                emoji: '💡',
                text: 'Extract and explain the most important insights'
            }
        ];

        // Add the PromptTray component
        const PromptTray = ({ onAddPrompt }) => {
            const [selectedTemplate, setSelectedTemplate] = React.useState('');

            const handleAddPrompt = () => {
                if (selectedTemplate) {
                    const template = PROMPT_TEMPLATES.find(t => t.id === selectedTemplate);
                    if (template) {
                        onAddPrompt({
                            id: Date.now(),
                            title: template.name,
                            text: template.text,
                            result: '',
                            source: 'SOURCE',
                            sources: ['SOURCE'],
                            sourceType: 'text',
                            selectedImage: null,
                            selectedPersonas: []
                        });
                        setSelectedTemplate('');
                    }
                }
            };

            return (
                <div className="persona-tray">
                    <div className="persona-selector-container">
                        <select 
                            value={selectedTemplate}
                            onChange={(e) => setSelectedTemplate(e.target.value)}
                            className="persona-selector"
                        >
                            <option value="">✨ Select Prompt... </option>
                            {PROMPT_TEMPLATES.map(template => (
                                <option key={template.id} value={template.id}>
                                    {template.emoji} {template.name}
                                </option>
                            ))}
                        </select>
                        <button 
                            onClick={handleAddPrompt}
                            className="add-persona-btn"
                            disabled={!selectedTemplate}
                        >
                            +
                        </button>

                        
                    </div>
                </div>
            );
        };

        // Add these constants near the top of your script
        const LOCAL_STORAGE_KEYS = {
            API_KEY: 'worksona_api_key',
            MODEL: 'worksona_model'
        };

        // Add the Chat component before the App component
        const Chat = ({ apiKey, model, isOpen, onClose, prompts, sourceContent }) => {
            const [messages, setMessages] = React.useState([]);
            const [inputValue, setInputValue] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false);
            const [selectedSources, setSelectedSources] = React.useState([]);
            const [currentSelection, setCurrentSelection] = React.useState('');
            const [includeChatHistory, setIncludeChatHistory] = React.useState(true);
            const messagesEndRef = React.useRef(null);

            // Create source options list with separator
            const sourceOptions = [
                { id: 'source', label: 'Source Content', content: sourceContent },
                { id: 'separator', label: '──────────', disabled: true },
                ...prompts.map(prompt => ({
                    id: `result-${prompt.id}`,
                    label: `Result: ${prompt.title || `Prompt ${prompt.id}`}`,
                    content: prompt.result
                }))
            ];

            const addSelectedSource = () => {
                if (!currentSelection) return;
                const source = sourceOptions.find(opt => opt.id === currentSelection);
                if (source && !selectedSources.find(s => s.id === source.id)) {
                    setSelectedSources([...selectedSources, source]);
                }
                setCurrentSelection('');
            };

            const removeSource = (sourceId) => {
                setSelectedSources(selectedSources.filter(s => s.id !== sourceId));
            };

            // Update handleSubmit to include selected sources
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!inputValue.trim() || isLoading) return;

                const userMessage = inputValue.trim();
                setInputValue('');
                
                // Combine selected sources into context
                const contextContent = selectedSources
                    .map(source => `${source.label}:\n${source.content}`)
                    .join('\n\n');
                
                setMessages(prev => [...prev, { role: 'user', content: userMessage }]);
                setIsLoading(true);

                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { 
                                    role: "system", 
                                    content: contextContent ? 
                                        `Consider this context:\n\n${contextContent}\n\nRespond as a helpful assistant.` : 
                                        "You are a helpful assistant."
                                },
                                // Only include message history if toggle is on
                                ...(includeChatHistory ? messages : []),
                                { role: "user", content: userMessage }
                            ]
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to get response');
                    }

                    const data = await response.json();
                    const assistantMessage = data.choices[0].message.content;

                    setMessages(prev => [...prev, { role: 'assistant', content: assistantMessage }]);
                } catch (error) {
                    console.error('Chat error:', error);
                    setMessages(prev => [...prev, { 
                        role: 'assistant', 
                        content: 'Sorry, I encountered an error. Please try again.' 
                    }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const copyMessages = () => {
                const messageText = messages
                    .map(msg => `${msg.role}: ${msg.content}`)
                    .join('\n\n');
                navigator.clipboard.writeText(messageText);
            };

            const clearMessages = () => {
                setMessages([]);
            };

            if (!isOpen) return null;

            return (
                <div className="chat-window" style={{
                    position: 'fixed',
                    bottom: '5rem',
                    right: '2rem',
                    width: '400px',
                    height: '400px', // Reduced height
                    background: 'var(--secondary-bg)',
                    border: '1px solid var(--border-color)',
                    borderRadius: '8px',
                    zIndex: 1000000,
                    display: 'flex',
                    flexDirection: 'column',
                    boxShadow: '0 4px 12px rgba(0, 0, 0, 0.15)'
                }}>
                    <div className="chat-titlebar" style={{
                        padding: '0.75rem 1rem',
                        borderBottom: '1px solid var(--border-color)',
                        display: 'flex',
                        flexDirection: 'column',
                        gap: '0.5rem',
                        background: 'var(--primary-bg)'
                    }}>
                        <div style={{ 
                            display: 'flex', 
                            justifyContent: 'space-between', 
                            alignItems: 'center',
                            gap: '1rem'
                        }}>
                            <div className="chat-title" style={{ 
                                fontWeight: '500', 
                                color: 'var(--text-primary)',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '1rem'
                            }}>
                                <span>Chat Assistant</span>
                                <div style={{ 
                                    display: 'flex', 
                                    alignItems: 'center',
                                    gap: '0.5rem',
                                    fontSize: '0.8rem'
                                }}>
                                    <span style={{ color: 'var(--text-secondary)' }}>History</span>
                                    <label className="toggle-switch" style={{
                                        position: 'relative',
                                        display: 'inline-block',
                                        width: '36px',
                                        height: '20px'
                                    }}>
                                        <input
                                            type="checkbox"
                                            checked={includeChatHistory}
                                            onChange={(e) => setIncludeChatHistory(e.target.checked)}
                                            style={{
                                                opacity: 0,
                                                width: 0,
                                                height: 0
                                            }}
                                        />
                                        <span style={{
                                            position: 'absolute',
                                            cursor: 'pointer',
                                            top: 0,
                                            left: 0,
                                            right: 0,
                                            bottom: 0,
                                            backgroundColor: includeChatHistory ? 'var(--accent-color)' : 'var(--border-color)',
                                            transition: '0.4s',
                                            borderRadius: '34px',
                                            '&::before': {
                                                position: 'absolute',
                                                content: '""',
                                                height: '16px',
                                                width: '16px',
                                                left: '2px',
                                                bottom: '2px',
                                                backgroundColor: 'white',
                                                transition: '0.4s',
                                                borderRadius: '50%',
                                                transform: includeChatHistory ? 'translateX(16px)' : 'translateX(0)'
                                            }
                                        }}>
                                            <div style={{
                                                position: 'absolute',
                                                height: '16px',
                                                width: '16px',
                                                left: '2px',
                                                bottom: '2px',
                                                backgroundColor: 'white',
                                                transition: '0.4s',
                                                borderRadius: '50%',
                                                transform: includeChatHistory ? 'translateX(16px)' : 'translateX(0)'
                                            }} />
                                        </span>
                                    </label>
                                </div>
                            </div>
                            <div style={{ display: 'flex', gap: '0.5rem' }}>
                                <button
                                    onClick={copyMessages}
                                    className="chat-titlebar-button"
                                    title="Copy Chat"
                                    style={{
                                        background: 'none',
                                        border: 'none',
                                        color: 'var(--text-primary)',
                                        cursor: 'pointer',
                                        padding: '4px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center'
                                    }}
                                >
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="16" height="16">
                                        <path d="M8 4v12a2 2 0 002 2h8a2 2 0 002-2V7.242a2 2 0 00-.602-1.43L16.083 2.57A2 2 0 0014.685 2H10a2 2 0 00-2 2z" strokeWidth="2"/>
                                        <path d="M16 18v2a2 2 0 01-2 2H6a2 2 0 01-2-2V9a2 2 0 012-2h2" strokeWidth="2"/>
                                    </svg>
                                </button>
                                <button
                                    onClick={clearMessages}
                                    className="chat-titlebar-button"
                                    title="Clear Chat"
                                    style={{
                                        background: 'none',
                                        border: 'none',
                                        color: 'var(--text-primary)',
                                        cursor: 'pointer',
                                        padding: '4px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center'
                                    }}
                                >
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="16" height="16">
                                        <path d="M19 7l-7 7m0 0l-7-7m7 7V4" strokeWidth="2"/>
                                    </svg>
                                </button>
                                <button
                                    onClick={onClose}
                                    className="chat-titlebar-button"
                                    title="Close Chat"
                                    style={{
                                        background: 'none',
                                        border: 'none',
                                        color: 'var(--text-primary)',
                                        cursor: 'pointer',
                                        padding: '4px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center'
                                    }}
                                >
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="16" height="16">
                                        <path d="M18 6L6 18M6 6l12 12" strokeWidth="2" strokeLinecap="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        {/* Source selector */}
                        <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                            <select
                                value={currentSelection}
                                onChange={(e) => setCurrentSelection(e.target.value)}
                                style={{
                                    flex: 1,
                                    padding: '0.4rem',
                                    background: 'var(--primary-bg)',
                                    border: '1px solid var(--border-color)',
                                    color: 'var(--text-primary)',
                                    borderRadius: '4px'
                                }}
                            >
                                <option value="">Select source or result...</option>
                                {sourceOptions.map(opt => (
                                    <option 
                                        key={opt.id} 
                                        value={opt.id}
                                        disabled={opt.disabled}
                                    >
                                        {opt.label}
                                    </option>
                                ))}
                            </select>
                            <button
                                onClick={addSelectedSource}
                                disabled={!currentSelection}
                                style={{
                                    padding: '0.4rem',
                                    background: 'var(--accent-color)',
                                    border: 'none',
                                    borderRadius: '4px',
                                    color: 'white',
                                    cursor: currentSelection ? 'pointer' : 'not-allowed',
                                    opacity: currentSelection ? 1 : 0.5
                                }}
                            >
                                +
                            </button>
                        </div>

                        {/* Selected sources tags */}
                        {selectedSources.length > 0 && (
                            <div style={{ 
                                display: 'flex', 
                                flexWrap: 'wrap', 
                                gap: '0.4rem',
                                padding: '0.4rem 0'
                            }}>
                                {selectedSources.map(source => (
                                    <div
                                        key={source.id}
                                        style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '0.4rem',
                                            padding: '0.2rem 0.4rem',
                                            background: 'var(--secondary-bg)',
                                            border: '1px solid var(--border-color)',
                                            borderRadius: '4px',
                                            fontSize: '0.8rem'
                                        }}
                                    >
                                        <span style={{ color: 'var(--text-primary)' }}>{source.label}</span>
                                        <button
                                            onClick={() => removeSource(source.id)}
                                            style={{
                                                background: 'none',
                                                border: 'none',
                                                color: 'var(--text-primary)',
                                                cursor: 'pointer',
                                                padding: '0 0.2rem'
                                            }}
                                        >
                                            ×
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    
                    <div className="chat-messages" style={{
                        flex: 1,
                        overflowY: 'auto',
                        padding: '1rem',
                        display: 'flex',
                        flexDirection: 'column',
                        gap: '0.75rem'
                    }}>
                        {messages.map((message, index) => (
                            <div 
                                key={index} 
                                className={`chat-message ${message.role}`}
                                style={{
                                    maxWidth: '80%',
                                    padding: '0.75rem',
                                    borderRadius: '8px',
                                    alignSelf: message.role === 'user' ? 'flex-end' : 'flex-start',
                                    background: message.role === 'user' ? 'var(--accent-color)' : 'var(--primary-bg)',
                                    color: message.role === 'user' ? 'white' : 'var(--text-primary)'
                                }}
                            >
                                {message.content}
                            </div>
                        ))}
                        {isLoading && (
                            <div className="chat-message assistant" style={{
                                maxWidth: '80%',
                                padding: '0.75rem',
                                borderRadius: '8px',
                                alignSelf: 'flex-start',
                                background: 'var(--primary-bg)',
                                color: 'var(--text-primary)'
                            }}>
                                Thinking...
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    <form 
                        onSubmit={handleSubmit}
                        style={{
                            padding: '0.75rem',
                            borderTop: '1px solid var(--border-color)',
                            display: 'flex',
                            gap: '0.5rem'
                        }}
                    >
                        <textarea 
                            value={inputValue}
                            onChange={(e) => setInputValue(e.target.value)}
                            placeholder="Type your message..."
                            style={{
                                flex: 1,
                                padding: '0.75rem',
                                border: '1px solid var(--border-color)',
                                borderRadius: '4px',
                                background: 'var(--primary-bg)',
                                color: 'var(--text-primary)',
                                resize: 'none',
                                height: '40px',
                                lineHeight: '20px'
                            }}
                            onKeyDown={(e) => {
                                if (e.key === 'Enter' && !e.shiftKey) {
                                    e.preventDefault();
                                    handleSubmit(e);
                                }
                            }}
                        />
                        <button 
                            type="submit"
                            disabled={isLoading}
                            style={{
                                padding: '0.5rem 1rem',
                                background: 'var(--accent-color)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '4px',
                                cursor: isLoading ? 'not-allowed' : 'pointer',
                                opacity: isLoading ? 0.7 : 1
                            }}
                        >
                            Send
                        </button>
                    </form>
                </div>
            );
        };

        // Main App Component
        function App() {
            const [apiKey, setApiKey] = React.useState(() => {
                return localStorage.getItem(LOCAL_STORAGE_KEYS.API_KEY) || '';
            });

            const [model, setModel] = React.useState(() => {
                return localStorage.getItem(LOCAL_STORAGE_KEYS.MODEL) || OPENAI_MODELS[0];
            });

            // Update the API key handler
            const handleApiKeyChange = (e) => {
                const newKey = e.target.value;
                setApiKey(newKey);
                localStorage.setItem(LOCAL_STORAGE_KEYS.API_KEY, newKey);
            };

            // Update the model handler
            const handleModelChange = (e) => {
                const newModel = e.target.value;
                setModel(newModel);
                localStorage.setItem(LOCAL_STORAGE_KEYS.MODEL, newModel);
            };

            const [sourceContent, setSourceContent] = React.useState('');
            const [uploadedImages, setUploadedImages] = React.useState([]);
            const [agencyName, setAgencyName] = React.useState('');
            const [agencyDescription, setAgencyDescription] = React.useState('');
            const [personaCards, setPersonaCards] = React.useState([]);
            const [prompts, setPrompts] = React.useState([{ 
                id: 1, 
                title: '',
                text: '', 
                result: '',
                source: 'SOURCE',
                sources: ['SOURCE'],
                sourceType: 'text',
                selectedImage: null,
                selectedPersonas: []
            }]);
            const [loading, setLoading] = React.useState({});
            const [error, setError] = React.useState('');
            const [isProcessingFile, setIsProcessingFile] = React.useState(false);
            const [uploadedDocuments, setUploadedDocuments] = React.useState([]);
            const [scenarioCards, setScenarioCards] = React.useState([]);
            const [activeTab, setActiveTab] = React.useState('content');
            const [isSettingsOpen, setIsSettingsOpen] = React.useState(false);

            // Add new state for chat
            const [isChatOpen, setIsChatOpen] = React.useState(false);

            // Add these new states
            const [llmConfig, setLlmConfig] = React.useState({
                openaiKey: localStorage.getItem('openai_api_key') || '',
                anthropicKey: localStorage.getItem('anthropic_api_key') || '',
                model: localStorage.getItem('selected_model') || 'gpt-4'
            });

            // Add this handler
            const handleLlmConfigChange = (key, value) => {
                setLlmConfig(prev => {
                    const newConfig = { ...prev, [key]: value };
                    localStorage.setItem(`${key === 'model' ? 'selected_model' : key === 'openaiKey' ? 'openai_api_key' : 'anthropic_api_key'}`, value);
                    return newConfig;
                });
            };

            const handleFileUpload = async (event) => {
                const files = Array.from(event.target.files);
                if (!files.length) return;

                setIsProcessingFile(true);
                setError('');

                try {
                    for (const file of files) {
                        if (SUPPORTED_IMAGE_TYPES.includes(file.type)) {
                            // Handle image files
                            const imageContent = await FileProcessor.processImage(file);
                            const imageId = Date.now();
                            const imageData = {
                                id: imageId,
                                url: imageContent,
                                name: file.name,
                                type: file.type
                            };
                            setUploadedImages(current => [...current, imageData]);
                        } else {
                            // Handle text-based documents
                            const content = await file.text();
                            const docId = Date.now();
                            const docData = {
                                id: docId,
                                name: file.name,
                                content: content,
                                type: file.type
                            };
                            setUploadedDocuments(current => [...current, docData]);
                        }
                    }
                } catch (error) {
                    console.error('File processing error:', error);
                    setError('Error processing file: ' + error.message);
                } finally {
                    setIsProcessingFile(false);
                    // Clear the file input for future uploads
                    event.target.value = '';
                }
            };

            const deleteImage = (imageId) => {
                setUploadedImages(current => current.filter(img => img.id !== imageId));
                setPrompts(current => current.map(prompt => 
                    prompt.selectedImage === imageId 
                        ? {...prompt, selectedImage: null}
                        : prompt
                ));
            };

            const addPersonaCard = (persona) => {
                setPersonaCards([...personaCards, persona]);
            };

            const updatePersonaCard = (id, changes) => {
                setPersonaCards(personaCards.map(p => 
                    p.cardId === id ? {...p, ...changes} : p
                ));
            };

            const deletePersonaCard = (id) => {
                setPersonaCards(personaCards.filter(p => p.cardId !== id));
            };

            const addPrompt = () => {
                const newPrompt = {
                    id: Date.now(),
                    title: '',
                    text: '',
                    result: '',
                    source: 'SOURCE',
                    sources: ['SOURCE'],
                    sourceType: 'text',
                    selectedImage: null,
                    selectedPersonas: []
                };
                setPrompts([...prompts, newPrompt]);
            };

            const deletePrompt = (id) => {
                setPrompts(prompts.filter(p => p.id !== id));
            };

            const updatePrompt = (id, changes) => {
                setPrompts(prompts.map(p => 
                    p.id === id ? {...p, ...changes} : p
                ));
            };
            const getPromptSource = (promptId) => {
                const prompt = prompts.find(p => p.id === promptId);
                if (!prompt) return '';
                
                // Ensure we're working with an array of sources and log for debugging
                const sources = Array.isArray(prompt.sources) ? prompt.sources : [prompt.source];
                console.log('Processing sources:', sources); // Debug log
                
                const sourceContents = sources.map(source => {
                    if (!source) return '';
                    
                    let content = '';
                    if (source === 'SOURCE') {
                        content = sourceContent || '';
                        console.log('SOURCE content length:', content.length); // Debug log
                    } else if (source.startsWith('DOC-')) {
                        const docId = parseInt(source.replace('DOC-', ''));
                        const document = uploadedDocuments.find(doc => doc.id === docId);
                        content = document ? `[Document: ${document.name}]\n${document.content}` : '';
                        console.log('DOC content length:', content.length); // Debug log
                    } else if (source.startsWith('RESULT')) {
                        const sourcePromptId = parseInt(source.replace('RESULT', ''));
                        const sourcePrompt = prompts.find(p => p.id === sourcePromptId);
                        content = sourcePrompt ? `[Result from Prompt ${sourcePromptId}]\n${sourcePrompt.result}` : '';
                        console.log('RESULT content length:', content.length); // Debug log
                    }
                    
                    return content;
                }).filter(content => content.trim() !== '');

                console.log('Number of source contents:', sourceContents.length); // Debug log
                
                // Join all sources with clear separators
                const finalContent = sourceContents.join('\n\n=== SOURCE SEPARATOR ===\n\n');
                console.log('Final content length:', finalContent.length); // Debug log
                
                return finalContent;
            };

            const getPersonaContext = (selectedPersonas) => {
                if (!selectedPersonas || selectedPersonas.length === 0) {
                    return '\nRespond in a professional, general audience-appropriate tone.';
                }

                const personas = selectedPersonas.map(id => 
                    personaCards.find(p => p.cardId === parseInt(id))
                ).filter(Boolean);

                if (personas.length === 0) {
                    return '\nRespond in a professional, general audience-appropriate tone.';
                }

                const fromPersonas = personas.filter(p => p.direction === 'from');
                const toPersonas = personas.filter(p => p.direction === 'to');
                
                let context = '';
                
                if (fromPersonas.length > 0) {
                    context += `\nRespond FROM the perspective of: ${fromPersonas.map(p => 
                        `${p.name} (${p.description})`).join(', ')}`;
                }
                
                if (toPersonas.length > 0) {
                    context += `\nTarget your response TO: ${toPersonas.map(p => 
                        `${p.name} (${p.description})`).join(', ')}`;
                }
                
                return context;
            };

            // Update the runPrompt function to preserve existing results
            const runPrompt = async (id) => {
                if (!apiKey) {
                    setError('Please enter an OpenAI API key');
                    return;
                }

                setLoading(prev => ({ ...prev, [id]: true }));
                setError('');

                try {
                    // Get the current prompt without modifying other prompts
                    const prompt = prompts.find(p => p.id === id);
                    if (!prompt) throw new Error('Prompt not found');

                    let requestBody;

                    if (prompt.sourceType === 'image') {
                        // Image analysis logic...
                    } else {
                        const sourceText = getPromptSource(id);
                        requestBody = {
                            model: model,
                            messages: [
                                { 
                                    role: "system", 
                                    content: `Context:\n${sourceText}${getPersonaContext(prompt.selectedPersonas)}`
                                },
                                { 
                                    role: "user", 
                                    content: prompt.text 
                                }
                            ]
                        };
                    }

                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error.message);
                    }

                    const result = data.choices[0].message.content;
                    
                    // Update only the specific prompt's result while preserving others
                    setPrompts(currentPrompts => 
                        currentPrompts.map(p => 
                            p.id === id ? {...p, result} : p
                        )
                    );

                } catch (err) {
                    console.error('Error running prompt:', err);
                    setError(err.message || 'Error running prompt');
                } finally {
                    setLoading(prev => ({ ...prev, [id]: false }));
                }
            };

            // Update runAllPrompts to run sequentially and preserve results
            const runAllPrompts = async () => {
                for (const prompt of prompts) {
                    await runPrompt(prompt.id);
                }
            };

            const exportAgency = async () => {
                try {
                    const exportData = {
                        agencyName,
                        agencyDescription,
                        sourceContent,
                        uploadedImages,
                        personaCards,
                        prompts: prompts.map(({ id, title, text, result, source, sources, sourceType, selectedImage }) => ({
                            id,
                            title,
                            text,
                            result,
                            source,
                            sources,
                            sourceType,
                            selectedImage
                        })),
                        settings: { model },
                        scenarioCards,
                    };
                    
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
                        type: 'application/json' 
                    });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `playground-export-${Date.now()}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    setError('Error exporting playground: ' + error.message);
                }
            };

            const exportContent = () => {
                try {
                    const content = prompts.map(prompt => {
                        let promptContent = `PROMPT ${prompt.id}: ${prompt.title}\n${prompt.text}\n\n`;
                        if (prompt.sourceType === 'image') {
                            promptContent += `[Image Analysis]\n`;
                        }
                        promptContent += `RESULT ${prompt.id}:\n${prompt.result}\n\n---\n\n`;
                        return promptContent;
                    }).join('');
                    
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `playground-content-${Date.now()}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    setError('Error exporting content: ' + error.message);
                }
            };

            const loadAgency = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (!data.prompts || !data.settings) {
                            throw new Error('Invalid playground file structure');
                        }

                        setSourceContent(data.sourceContent || '');
                        setPrompts(data.prompts);
                        setModel(data.settings.model || OPENAI_MODELS[0]);
                        setAgencyName(data.agencyName || '');
                        setAgencyDescription(data.agencyDescription || '');
                        setUploadedImages(data.uploadedImages || []);
                        setPersonaCards(data.personaCards || []);
                        setScenarioCards(data.scenarioCards || []);
                    } catch (error) {
                        setError('Error loading playground: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };

            const handleDocumentSelect = (content) => {
                setSourceContent(content);
            };

            const addScenarioCard = (scenario) => {
                setScenarioCards([...scenarioCards, scenario]);
            };

            const updateScenarioCard = (id, changes) => {
                setScenarioCards(scenarioCards.map(s => 
                    s.cardId === id ? {...s, ...changes} : s
                ));
            };

            const deleteScenarioCard = (id) => {
                setScenarioCards(scenarioCards.filter(s => s.cardId !== id));
            };

            // Add this constant near your other constants (PERSONAS, SCENARIOS)
            const PLAYGROUNDS = [
                {
                    id: 'content-analysis',
                    name: 'Content Analysis',
                    description: 'Analyze content tone, style, and audience targeting',
                    config: {
                        agencyName: 'Content Analysis Playground',
                        agencyDescription: 'Analyze and optimize content for different platforms and audiences',
                        prompts: [{
                            id: 1,
                            title: 'Content Analysis',
                            text: 'Analyze this content and provide key insights about:\n1. Tone and style\n2. Target audience\n3. Key messages\n4. Areas for improvement',
                            result: '',
                            source: 'SOURCE',
                            sources: ['SOURCE'],
                            sourceType: 'text',
                            selectedImage: null
                        }]
                    }
                },
                {
                    id: 'social-media',
                    name: 'Social Media',
                    description: 'Create and optimize social media content',
                    config: {
                        agencyName: 'Social Media Playground',
                        agencyDescription: 'Create engaging social media content across platforms',
                        prompts: [{
                            id: 2,
                            title: 'Social Post Generator',
                            text: 'Create a series of social media posts optimized for engagement. Include variations for:\n1. LinkedIn\n2. Twitter\n3. Instagram',
                            result: '',
                            source: 'SOURCE',
                            sources: ['SOURCE'],
                            sourceType: 'text',
                            selectedImage: null
                        }]
                    }
                },
                {
                    id: 'blog-writing',
                    name: 'Blog Writing',
                    description: 'Generate blog content and outlines',
                    config: {
                        agencyName: 'Blog Writing Playground',
                        agencyDescription: 'Create engaging blog content and structured outlines',
                        prompts: [{
                            id: 3,
                            title: 'Blog Outline',
                            text: 'Create a detailed blog outline including:\n1. Title options\n2. Key sections\n3. Main points for each section\n4. Suggested examples or case studies',
                            result: '',
                            source: 'SOURCE',
                            sources: ['SOURCE'],
                            sourceType: 'text',
                            selectedImage: null
                        }]
                    }
                },
                {
                    id: 'email-marketing',
                    name: 'Email Marketing',
                    description: 'Create email marketing campaigns',
                    config: {
                        agencyName: 'Email Marketing Playground',
                        agencyDescription: 'Design effective email marketing campaigns',
                        prompts: [{
                            id: 4,
                            title: 'Email Sequence',
                            text: 'Generate an email marketing sequence including:\n1. Subject lines\n2. Email body content\n3. Call-to-action suggestions\n4. Follow-up variations',
                            result: '',
                            source: 'SOURCE',
                            sources: ['SOURCE'],
                            sourceType: 'text',
                            selectedImage: null
                        }]
                    }
                },
                {
                    id: 'product-description',
                    name: 'Product Description',
                    description: 'Write compelling product descriptions',
                    config: {
                        agencyName: 'Product Description Playground',
                        agencyDescription: 'Create engaging product descriptions and features',
                        prompts: [{
                            id: 5,
                            title: 'Product Description',
                            text: 'Create a compelling product description including:\n1. Main benefits\n2. Key features\n3. Technical specifications\n4. Use cases\n5. Target audience',
                            result: '',
                            source: 'SOURCE',
                            sources: ['SOURCE'],
                            sourceType: 'text',
                            selectedImage: null
                        }]
                    }
                }
            ];

            // Add the PlaygroundTray component
            const PlaygroundTray = ({ onLoadPlayground }) => {
                const [selectedPlayground, setSelectedPlayground] = React.useState('');

                const handleLoadPlayground = () => {
                    if (selectedPlayground) {
                        const playground = PLAYGROUNDS.find(p => p.id === selectedPlayground);
                        onLoadPlayground(playground.config);
                        setSelectedPlayground('');
                    }
                };

                return (
                    <div className="persona-tray" style={{ width: '100%', boxSizing: 'border-box' }}>
                        <div className="persona-selector-container" style={{ width: '100%', display: 'flex', alignItems: 'center' }}>
                            <select 
                                value={selectedPlayground}
                                onChange={(e) => setSelectedPlayground(e.target.value)}
                                className="persona-selector"
                                style={{ 
                                    flex: '1',
                                    maxWidth: 'calc(100% - 45px)', // Leave space for the button
                                    overflow: 'hidden',
                                    textOverflow: 'ellipsis',
                                    whiteSpace: 'nowrap'
                                }}
                            >
                                <option value="">🎮 Select Playground...</option>
                                {PLAYGROUNDS.map(playground => (
                                    <option key={playground.id} value={playground.id}>
                                        {playground.name} - {playground.description}
                                    </option>
                                ))}
                            </select>
                            <button 
                                onClick={handleLoadPlayground}
                                className="add-persona-btn"
                                disabled={!selectedPlayground}
                                style={{ 
                                    minWidth: '35px',
                                    height: '35px',
                                    padding: '0',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                }}
                            >
                                +
                            </button>
                        </div>
                    </div>
                );
            };

            // In your App component, add the loadPlayground function
            const loadPlayground = (config) => {
                setAgencyName(config.agencyName);
                setAgencyDescription(config.agencyDescription);
                setPrompts(config.prompts);
            };

            // Add this debug log
            React.useEffect(() => {
                console.log('Chat open state:', isChatOpen);
            }, [isChatOpen]);

            return (
                <React.Fragment>
                    <div 
                        style={{
                            position: 'fixed',
                            top: '1rem',
                            right: '1rem',
                            zIndex: 99999
                        }}
                    >
                        <button 
                            className="floating-gear"
                            onClick={() => setIsSettingsOpen(!isSettingsOpen)}
                            title="Settings"
                            style={{
                                width: '48px',
                                height: '48px',
                                background: 'var(--accent-color)',
                                border: 'none',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                boxShadow: '0 2px 8px rgba(0, 0, 0, 0.2)',
                                transition: 'all 0.3s ease',
                                color: 'white',
                                padding: 0
                            }}
                        >
                            <svg 
                                viewBox="0 0 24 24" 
                                fill="none" 
                                stroke="currentColor" 
                                strokeWidth="2"
                                style={{
                                    width: '24px',
                                    height: '24px'
                                }}
                            >
                                <path d="M12 15a3 3 0 100-6 3 3 0 000 6z" />
                                <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z" />
                            </svg>
                        </button>
                    </div>
                    <div className="container">
                        {/* Settings Button */}
                        <button 
                            style={{
                                position: 'fixed',
                                top: '1rem',
                                right: '1rem',
                                width: '48px',
                                height: '48px',
                                background: 'var(--accent-color)',
                                border: 'none',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                zIndex: 99999,
                                color: 'white',
                            }}
                            onClick={() => setIsSettingsOpen(!isSettingsOpen)}
                        >
                            ⚙️
                        </button>

                        {/* Settings Panel */}
                        {isSettingsOpen && (
                            <div style={{
                                position: 'fixed',
                                top: 0,
                                right: 0,
                                width: '320px',
                                height: '100vh',
                                background: 'var(--secondary-bg)',
                                borderLeft: '1px solid var(--border-color)',
                                boxShadow: '-2px 0 5px rgba(0, 0, 0, 0.2)',
                                zIndex: 99998,
                                padding: '1rem',
                                overflowY: 'auto'
                            }}>
                                <div style={{ 
                                    display: 'flex', 
                                    justifyContent: 'space-between', 
                                    alignItems: 'center',
                                    marginBottom: '1rem',
                                    borderBottom: '1px solid var(--border-color)',
                                    paddingBottom: '0.5rem'
                                }}>
                                    <h3 style={{ margin: 0 }}>Settings</h3>
                                    <button 
                                        onClick={() => setIsSettingsOpen(false)}
                                        style={{
                                            background: 'none',
                                            border: 'none',
                                            color: 'var(--text-primary)',
                                            cursor: 'pointer',
                                            fontSize: '1.2rem'
                                        }}
                                    >
                                        ×
                                    </button>
                                </div>

                                {/* LLM Settings Section */}
                                <div style={{ marginBottom: '2rem' }}>
                                    <h4 style={{ marginBottom: '1rem' }}>LLM Settings</h4>
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                        <div>
                                            <label style={{ display: 'block', marginBottom: '0.5rem' }}>OpenAI API Key</label>
                                            <input
                                                type="password"
                                                value={llmConfig.openaiKey}
                                                onChange={(e) => handleLlmConfigChange('openaiKey', e.target.value)}
                                                style={{
                                                    width: '100%',
                                                    padding: '0.5rem',
                                                    background: 'var(--primary-bg)',
                                                    border: '1px solid var(--border-color)',
                                                    color: 'var(--text-primary)'
                                                }}
                                            />
                                        </div>

                                        <div>
                                            <label style={{ display: 'block', marginBottom: '0.5rem' }}>Anthropic API Key</label>
                                            <input
                                                type="password"
                                                value={llmConfig.anthropicKey}
                                                onChange={(e) => handleLlmConfigChange('anthropicKey', e.target.value)}
                                                style={{
                                                    width: '100%',
                                                    padding: '0.5rem',
                                                    background: 'var(--primary-bg)',
                                                    border: '1px solid var(--border-color)',
                                                    color: 'var(--text-primary)'
                                                }}
                                            />
                                        </div>

                                        <div>
                                            <label style={{ display: 'block', marginBottom: '0.5rem' }}>Model</label>
                                            <select
                                                value={llmConfig.model}
                                                onChange={(e) => handleLlmConfigChange('model', e.target.value)}
                                                style={{
                                                    width: '100%',
                                                    padding: '0.5rem',
                                                    background: 'var(--primary-bg)',
                                                    border: '1px solid var(--border-color)',
                                                    color: 'var(--text-primary)'
                                                }}
                                            >
                                                <optgroup label="OpenAI">
                                                    <option value="gpt-4">GPT-4</option>
                                                    <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                                </optgroup>
                                                <optgroup label="Anthropic">
                                                    <option value="claude-3-opus">Claude 3 Opus</option>
                                                    <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                                                    <option value="claude-2.1">Claude 2.1</option>
                                                </optgroup>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                {/* Playground Management Section */}
                                <div>
                                    <h4 style={{ marginBottom: '1rem' }}>Playground Management</h4>
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                        <input
                                            type="file"
                                            id="loadPlayground"
                                            accept=".json"
                                            onChange={loadAgency}
                                            style={{ display: 'none' }}
                                        />
                                        <button 
                                            onClick={() => document.getElementById('loadPlayground').click()}
                                            style={{
                                                width: '100%',
                                                padding: '0.75rem',
                                                background: 'var(--accent-color)',
                                                border: 'none',
                                                color: 'white',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                gap: '0.5rem'
                                            }}
                                        >
                                            <span>📂</span> Import Playground
                                        </button>
                                        <button 
                                            onClick={exportAgency}
                                            style={{
                                                width: '100%',
                                                padding: '0.75rem',
                                                background: 'var(--accent-color)',
                                                border: 'none',
                                                color: 'white',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                gap: '0.5rem'
                                            }}
                                        >
                                            <span>💾</span> Export Playground
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        <ProcessingIndicator isVisible={isProcessingFile} />
                        
                        <div className="fixed-section">
                            <div className="tabs-container">
                                {/* Remove the tab buttons div entirely */}
                                <div className="tab-content">
                                    {/* Remove the settings tab case and keep only the content tab */}
                                    <div className="content-tab">
                                        {/* Playground Name and Description */}
                                        <div className="agency-details">
                                            <textarea
                                                value={agencyName}
                                                onChange={(e) => setAgencyName(e.target.value)}
                                                placeholder="Enter Playground Name..."
                                                className="agency-name-textarea"
                                            />
                                            <textarea
                                                value={agencyDescription}
                                                onChange={(e) => setAgencyDescription(e.target.value)}
                                                placeholder="Enter Playground Description..."
                                                className="agency-description-textarea"
                                            />
                                        </div>

                                        {/* Playground Selection */}
                                        <h3 className="section-title">📚 Playgrounds</h3>
                                        <PlaygroundTray onLoadPlayground={loadPlayground} />

                                        {/* Upload Components Group */}
                                        <div className="upload-content-group">
                                            <div className="document-tray-title">
                                                📚 Upload Content
                                            </div>
                                            <input
                                                type="file"
                                                id="fileInput"
                                                className="hidden"
                                                accept=".txt,.md,.json,image/*"
                                                onChange={handleFileUpload}
                                                multiple
                                            />
                                            <button 
                                                onClick={() => document.getElementById('fileInput').click()}
                                                className="btn btn-primary"
                                                style={{ marginBottom: '1rem' }}
                                            >
                                                📎 Upload File or Image
                                            </button>

                                            <div className="tray-container">
                                                <DocumentTray 
                                                    uploadedDocuments={uploadedDocuments} 
                                                    onDeleteDocument={(id) => {
                                                        setUploadedDocuments(current => current.filter(doc => doc.id !== id));
                                                    }}
                                                    onSelectDocument={(content) => setSourceContent(content)}
                                                />

                                                <div className="document-tray-title">
                                                    Source
                                                </div>
                                                <textarea
                                                    value={sourceContent}
                                                    onChange={(e) => setSourceContent(e.target.value)}
                                                    placeholder="Enter or upload source content..."
                                                    className="source-textarea"
                                                />

                                                <ImageTray uploadedImages={uploadedImages} onDeleteImage={deleteImage} />
                                            </div>
                                        </div>

                                        {/* Card Selection Group */}
                                        <div className="document-tray-title">
                                            🎴 Card Selection
                                        </div>
                                        <div className="selection-trays">
                                            <ScenarioTray onAddScenario={addScenarioCard} />
                                            <PersonaTray onAddPersona={addPersonaCard} />
                                            <PromptTray onAddPrompt={(template) => {
                                                const newPrompt = {
                                                    ...template,
                                                    id: Date.now(),
                                                    result: '',
                                                    source: 'SOURCE',
                                                    sources: ['SOURCE'],
                                                    sourceType: 'text',
                                                    selectedImage: null,
                                                    selectedPersonas: []
                                                };
                                                setPrompts([...prompts, newPrompt]);
                                            }} />
                                        </div>

                                        {activeTab === 'content' && (
                                            <div className="button-bar">
                                                <button onClick={runAllPrompts} className="btn btn-agency">
                                                    🚀 Run All
                                                </button>
                                                <button onClick={exportContent} className="btn btn-agency">
                                                    📤 Export Content
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="content-area">
                            <div className="horizontal-scroll">
                                <div className="scenario-container">
                                    {scenarioCards.map(scenario => (
                                        <ScenarioCard
                                            key={scenario.cardId}
                                            scenario={scenario}
                                            onUpdate={updateScenarioCard}
                                            onDelete={deleteScenarioCard}
                                        />
                                    ))}
                                </div>
                                <div className="persona-container">
                                    {personaCards.map(persona => (
                                        <PersonaCard
                                            key={persona.cardId}
                                            persona={persona}
                                            onUpdate={updatePersonaCard}
                                            onDelete={deletePersonaCard}
                                            apiKey={apiKey}
                                        />
                                    ))}
                                </div>
                                <div className="prompt-container">
                                    {prompts.map(prompt => (
                                        <PromptCard
                                            key={prompt.id}
                                            prompt={prompt}
                                            sourceOptions={prompts.filter(p => p.id < prompt.id)}
                                            loading={loading[prompt.id]}
                                            onUpdate={updatePrompt}
                                            onDelete={deletePrompt}
                                            onRun={runPrompt}
                                            uploadedImages={uploadedImages}
                                            uploadedDocuments={uploadedDocuments}
                                            apiKey={apiKey}
                                            personaCards={personaCards}
                                            sourceContent={sourceContent}
                                            onSourceSelect={(content) => setSourceContent(content)}
                                        />
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>

                    <button 
                        className="chat-toggle-button"
                        onClick={() => {
                            console.log('Chat button clicked');
                            setIsChatOpen(prev => !prev);
                        }}
                        style={{
                            position: 'fixed',
                            bottom: '2rem',
                            right: '2rem',
                            zIndex: 999999,
                            width: '48px',
                            height: '48px',
                            background: 'var(--accent-color)',
                            border: 'none',
                            borderRadius: '50%',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            boxShadow: '0 2px 8px rgba(0, 0, 0, 0.2)',
                            transition: 'all 0.3s ease',
                            color: 'white',
                            padding: 0
                        }}
                    >
                        <svg 
                            viewBox="0 0 24 24" 
                            fill="none" 
                            stroke="currentColor"
                            style={{
                                width: '24px',
                                height: '24px'
                            }}
                        >
                            <path 
                                d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10z" 
                                strokeWidth="2" 
                                strokeLinecap="round" 
                                strokeLinejoin="round"
                            />
                        </svg>
                    </button>

                    <Chat 
                        apiKey={apiKey}
                        model={model}
                        isOpen={isChatOpen}
                        onClose={() => {
                            console.log('Closing chat');
                            setIsChatOpen(false);
                        }}
                        prompts={prompts}
                        sourceContent={sourceContent}
                    />
                </React.Fragment>
            );
        }

        // Initialize React App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>