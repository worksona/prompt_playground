<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worksona Playground</title>
    
    <!-- Core Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- Document Processing Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        /* Theme Variables */
        :root {
            --primary-bg: #1e1e1e;  /* Dark background like IDE */
            --secondary-bg: #252526; /* Slightly lighter for panels */
            --accent-color: #007acc; /* Blue accent like VS Code */
            --secondary-accent: #FF5722; /* New secondary accent color */
            --text-primary: #d4d4d4; /* Light gray text */
            --text-secondary: #858585; /* Dimmer text */
            --border-color: #3c3c3c; /* Darker borders */
            --button-hover: #2a2d2e; /* Button hover state */
            --error-color: #f48771; /* Error text color */
            --border-radius: 0;  /* Add this variable for consistency */
        }

        /* Base styles */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }

        #particles-js {
            display: none;
        }

        .container {
            padding: 0;
            display: flex;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Agency Details styles */
        .agency-details {
            margin-bottom: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background: transparent;
            padding: 0;
            border: none;
            border-radius: 0;
        }

        .agency-name-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            resize: none;
            outline: none;
            font-family: inherit;
            background: var(--primary-bg);
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 500;
            height: 2.5rem;
        }

        .agency-description-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            resize: vertical;
            outline: none;
            font-family: inherit;
            background: var(--primary-bg);
            color: var(--text-primary);
            min-height: 4rem;
            font-size: 0.875rem;
        }
        /* Fixed section */
        .fixed-section {
            width: 320px;
            min-width: 320px;
            max-width: 320px;
            flex-shrink: 0;
            padding: 1.25rem;
            border-right: 1px solid var(--border-color);
            background: var(--secondary-bg);
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            position: fixed;
            left: 0;
            top: 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            z-index: 100;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Focus states for textareas */
        .agency-name-textarea:focus,
        .agency-description-textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(99, 226, 183, 0.1);
        }

        /* Placeholder colors */
        .agency-name-textarea::placeholder,
        .agency-description-textarea::placeholder {
            color: var(--text-secondary);
        }

        /* Persona styles */
        .persona-tray {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 0;
        }

        /* Update persona selector container styles */
        .persona-selector-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            width: 100%; /* Ensure full width */
        }

        .persona-selector {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            width: calc(100% - 35px); /* Account for add button width */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .add-persona-btn {
            min-width: 35px;
            height: 35px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent-color);
            color: var(--primary-bg);
            border: none;
            border-radius: 0;
            cursor: pointer;
        }

        .persona-card {
            background: var(--secondary-bg);
            border-radius: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            padding: 1rem;
            min-width: 300px;
            max-width: 400px;
            height: fit-content;
            flex-shrink: 0;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            border: 1px solid var(--border-color);
            border-left: 4px solid #FF9800; /* Orange accent for personas */
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-sizing: border-box;
        }

        .persona-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-color);
        }

        .persona-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .persona-emoji {
            font-size: 2rem;
        }

        .persona-title {
            font-weight: 500;
            color: var(--text-primary);
        }

        .persona-name {
            width: calc(100% - 1rem);
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            outline: none;
            margin: 0 0.5rem 0.5rem 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }

        .persona-name:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(99, 226, 183, 0.2);
        }

        .direction-selector {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .persona-textarea {
            width: calc(100% - 1rem);
            min-height: 150px;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            resize: vertical;
            outline: none;
            font-family: inherit;
            background: var(--primary-bg);
            color: var(--text-primary);
            margin: 0 0.5rem 1rem 0.5rem;
            box-sizing: border-box;
        }

        .persona-textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(99, 226, 183, 0.2);
        }

        .persona-textarea::placeholder {
            color: var(--text-secondary);
        }

        /* Image Upload styles */
        .image-upload-zone {
            border: 2px dashed var(--border-color);
            padding: 2rem;
            border-radius: 0;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--secondary-bg);
            margin-bottom: 1rem;
        }

        .image-upload-zone:hover {
            border-color: var(--accent-color);
            background: var(--secondary-bg);
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            margin: 1rem 0;
            border-radius: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Image Tray styles */
        .image-tray {
            margin-top: 1rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--secondary-bg);
        }

        .image-tray-title {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .image-preview-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .image-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 0;
            overflow: hidden;
            border: 2px solid var(--border-color);
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-item.selected {
            border-color: var(--accent-color);
        }

        .image-preview-item .delete-button {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--secondary-bg);
            border: none;
            border-radius: 0;
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-weight: bold;
        }

        /* Content area */
        .content-area {
            flex: 1;
            margin-left: 333px; /* 330px + 3px gap from left of screen */
            min-width: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow-x: auto;
        }

        /* Remove horizontal scroll padding */
        .horizontal-scroll {
            display: flex;
            gap: 2rem;
            padding: 0;
            min-width: min-content;
        }

        /* Add styles for card columns */
        .card-column {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            min-width: 300px;
            max-width: 400px;
            flex-shrink: 0;
            max-height: calc(100vh - 8rem);
            overflow-y: auto;
        }

        /* Update prompt container to include bottom padding */
        .prompt-container {
            display: flex;
            gap: 0;
            flex-shrink: 0;
            height: 100vh;
            padding: 0;
            margin-left: -2rem;
            overflow-x: auto;
            overflow-y: hidden;
        }

        /* Update prompt card to include bottom padding */
        .prompt-card {
            background: var(--secondary-bg);
            border-radius: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            padding: 1rem;
            padding-bottom: 3rem; /* Add extra padding at bottom */
            min-width: 300px;
            max-width: 400px;
            height: 100vh;
            flex-shrink: 0;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            border: 1px solid var(--border-color);
            overflow-y: auto;
        }

        /* Add padding to the last element in prompt card */
        .prompt-card > *:last-child {
            margin-bottom: 2rem; /* Add space after the last element */
        }

        .prompt-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-color);
        }

        .prompt-card.image-mode {
            border-left: 4px solid var(--accent-color);
        }

        .source-type-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0;
            background: transparent;
            border-radius: 0;
        }

        .source-type-button {
            flex: 1;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--secondary-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .source-type-button.active {
            background: var(--accent-color);
            color: var(--primary-bg);
            border-color: var(--accent-color);
        }

        .source-selector {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            outline: none;
            margin-bottom: 0.5rem;
            min-height: 120px; /* Add minimum height */
            max-height: 200px;
            overflow-y: auto;
        }

        .source-selector option {
            padding: 0.5rem 0.5rem 0.5rem 2rem;
            cursor: pointer;
            position: relative;
        }

        .source-selector option:checked,
        .source-selector option:hover:checked,
        .source-selector option[selected] {
            background: var(--accent-color) !important;
            color: white !important;
            -webkit-appearance: none;
            appearance: none;
        }

        .source-selector option:checked::before,
        .source-selector option[selected]::before {
            content: "✓";
            position: absolute;
            left: 0.5rem;
            color: white;
            font-weight: bold;
        }

        .source-selector option:hover {
            background: rgba(226, 152, 99, 0.1);
        }

        .prompt-textarea {
            width: 100%;
            min-height: 200px;
            height: 200px;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            resize: vertical;
            outline: none;
            font-family: inherit;
            background: var(--primary-bg);
            color: var(--text-primary);
            margin: 0;
            box-sizing: border-box;
            transition: border-color 0.2s ease;
        }

        .prompt-textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(99, 226, 183, 0.2);
        }

        .prompt-textarea::placeholder {
            color: var(--text-secondary);
        }

        .result-container {
            position: relative;
            width: 100%;
        }

        .result-textarea {
            width: 100%;
            min-height: 250px;
            height: 250px;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            resize: vertical;
            outline: none;
            font-family: inherit;
            background: var(--primary-bg);
            color: var(--text-primary);
            margin: 0;
            box-sizing: border-box;
        }

        /* API Key Input styles */
        .api-key-input {
            width: 100%;
            height: 45px;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.875rem;
            outline: none;
            margin: 0.5rem 0;
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .api-key-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(226, 152, 99, 0.1);
        }

        /* Button styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            font-size: 0.875rem;
            background-color: var(--secondary-bg);
            color: var(--text-primary);
        }

        .btn:hover {
            background-color: var(--button-hover);
            transform: none;
        }

        .btn-primary, .btn-agency {
            background-color: var(--accent-color);
            color: var(--text-primary);
        }

        .btn-success {
            background-color: var(--accent-color);
            color: var(--primary-bg);
            width: 100%;
        }

        .btn-danger,
        .delete-button {
            background-color: #8B7E7E;
            color: var(--primary-bg);
        }

        .btn-danger:hover,
        .delete-button:hover {
            background-color: #766868;
            color: var(--primary-bg);
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-bg);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Utility styles */
        .hidden {
            display: none;
        }

        .error {
            background-color: rgba(139, 126, 126, 0.2);
            border-left: 4px solid #8B7E7E;
            padding: 1rem;
            margin: 1rem 0;
            color: #8B7E7E;
        }

        /* Copy button styles */
        .copy-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 0;
            padding: 0.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .copy-button svg {
            width: 16px;
            height: 16px;
            stroke: var(--text-primary);
        }

        .copy-button:hover {
            background: var(--accent-color);
        }

        .copy-button:hover svg {
            stroke: var(--primary-bg);
        }

        .model-selector {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            outline: none;
            margin-bottom: 1rem;
        }

        /* Add styles for the button bar */
        .button-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background: var(--secondary-bg);
            width: calc(100% - 2rem); /* Account for padding */
            margin-top: 2rem; /* Add space above buttons */
        }

        .button-bar .btn {
            flex: 1;
            min-width: calc(50% - 0.25rem);
        }

        .document-tray {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 0;
        }

        .document-tray-title {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .document-preview-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .document-preview-item {
            display: flex;
            flex-direction: column;
            background: var(--primary-bg);
            border-radius: 0;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .document-preview-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--secondary-bg);
        }

        .document-icon {
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .document-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .document-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .preview-button,
        .use-button {
            background: var(--accent-color);
            color: var(--primary-bg);
            border: none;
            border-radius: 0;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .preview-button:hover,
        .use-button:hover {
            opacity: 0.9;
        }

        .document-content {
            width: 100%;
            min-height: 100px;
            max-height: 200px;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--secondary-bg);
            color: var(--text-primary);
            font-size: 0.875rem;
            resize: vertical;
            overflow-y: auto;
        }

        .prompt-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .prompt-title {
            font-weight: 500;
            color: var(--text-primary);
        }

        .prompt-title-input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            font-size: 0.875rem;
            outline: none;
        }

        .prompt-title-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(226, 152, 99, 0.1);
        }

        /* Result action buttons */
        .result-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .enhance-status {
            font-size: 0.875rem;
            padding: 0.5rem;
            margin-top: 0.5rem;
            background: var(--accent-color);
            color: var(--primary-bg);
            border-radius: 0;
            text-align: center;
            opacity: 0.9;
            transition: all 0.3s ease;
        }

        .enhance-status.error {
            background: #8B7E7E;
        }

        .result-button {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 0;
            padding: 0.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            width: 24px;
            height: 24px;
        }

        .result-button:hover {
            background: var(--accent-color);
            color: var(--primary-bg);
        }

        .result-button svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
        }

        .result-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Scenario styles */
        .scenario-card {
            background: var(--secondary-bg);
            border-radius: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            padding: 1rem;
            min-width: 300px;
            max-width: 400px;
            height: fit-content;
            min-height: 720px; /* Increased from 520px to accommodate taller textareas */
            flex-shrink: 0;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            border: 1px solid var(--border-color);
            border-left: 4px solid #4CAF50;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-sizing: border-box;
        }

        .scenario-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-color);
        }

        .scenario-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .scenario-title {
            font-weight: 500;
            color: var(--text-primary);
        }

        .scenario-name {
            width: calc(100% - 1rem);
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            outline: none;
            margin: 0 0.5rem 0.5rem 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }

        .scenario-name:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(99, 226, 183, 0.2);
        }

        /* Update scenario textarea styles */
        .scenario-textarea {
            width: calc(100% - 1rem);
            min-height: 150px; /* Increased from 100px */
            height: 150px; /* Increased from 100px */
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            resize: vertical;
            outline: none;
            font-family: inherit;
            background: var(--primary-bg);
            color: var(--text-primary);
            margin: 0 0.5rem 0.5rem 0.5rem;
            box-sizing: border-box;
        }

        .scenario-textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(99, 226, 183, 0.2);
        }

        .scenario-textarea::placeholder {
            color: var(--text-secondary);
        }

        /* Scenario Tray styles */
        .scenario-tray {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 0;
        }

        .scenario-selector-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .scenario-selector {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
        }

        .add-scenario-btn {
            background: var(--accent-color);
            color: var(--primary-bg);
            border: none;
            border-radius: 0;
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .add-scenario-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .add-scenario-btn:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .card {
            background-color: #ffffff;
            border-radius: 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 15px;
            width: 300px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .card-content {
            flex-grow: 1;
            font-size: 1rem;
            line-height: 1.5;
            color: #666;
        }

        .scenario-card {
            border-left: 5px solid #4CAF50;  /* Green accent */
        }

        .prompt-card {
            border-left: 5px solid #2196F3;  /* Blue accent */
        }

        .persona-card {
            border-left: 5px solid #FF9800;  /* Orange accent */
        }

        /* Add emoji styles for both cards */
        .prompt-emoji,
        .scenario-emoji {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }

        /* Update headers to accommodate emojis */
        .prompt-header,
        .scenario-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .prompt-title,
        .scenario-title {
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            margin-right: 0.5rem;
        }

        .source-label,
        .persona-label {
            font-size: 1.0rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            padding-left: 0.25rem;
        }

        /* Update the tabs-container and tab-content styles */
        .tabs-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            overflow: hidden; /* Prevent container overflow */
        }

        /* Update the tab-content styles to add padding at the bottom */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 0.5rem;
            padding-bottom: 2rem; /* Add padding at bottom for scrolling content */
            margin-right: -0.5rem;
            width: 100%;
        }

        /* Update the button-bar styles to ensure visibility */
        .button-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background: var(--secondary-bg);
            width: calc(100% - 2rem); /* Account for padding */
            margin-top: 2rem; /* Add space above buttons */
        }

        /* Ensure all content within tabs doesn't cause horizontal scroll */
        .tab-content > * {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Adjust input and textarea widths */
        .api-key-input,
        .model-selector,
        .agency-name-textarea,
        .agency-description-textarea {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .instructions-content {
            padding: 1rem;
            background: var(--primary-bg);
            border-radius: 0;
            border: 1px solid var(--border-color);
        }

        .instructions-section {
            margin-bottom: 1.5rem;
        }

        .instructions-section h3 {
            color: var(--accent-color);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .instructions-section p {
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .instructions-section ul {
            list-style-type: none;
            padding-left: 1rem;
            margin-bottom: 0.75rem;
        }

        .instructions-section li {
            color: var(--text-primary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .instructions-section li::before {
            content: "•";
            color: var(--accent-color);
            position: absolute;
            left: -1rem;
        }

        /* Update the tab buttons to accommodate three tabs */
        .tab-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .tab-button {
            flex: 1;
            padding: 0.75rem 0.5rem;
            font-size: 0.875rem;
            background: var(--secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            background: var(--primary-bg);
            border-color: var(--accent-color);
        }

        .tab-button.active {
            background: var(--accent-color);
            color: var(--text-primary);
            border-color: var(--accent-color);
        }

        /* In the App component, update the tab buttons and add instructions content */
        <div className="tab-buttons">
            <button 
                className={`tab-button ${activeTab === 'settings' ? 'active' : ''}`}
                onClick={() => setActiveTab('settings')}
            >
                ⚙️ Settings
            </button>
            <button 
                className={`tab-button ${activeTab === 'content' ? 'active' : ''}`}
                onClick={() => setActiveTab('content')}
            >
                🎮 Play
            </button>
        </div>

        <div className="tab-content" style={{ display: 'flex', flexDirection: 'column', flex: 1, overflow: 'auto' }}>
            {activeTab === 'settings' && (
                <>
                    <h3 className="section-title"> Models</h3>
                    <input
                        type="password"
                        value={apiKey}
                        onChange={handleApiKeyChange}
                        placeholder="Enter OpenAI API Key"
                        className="api-key-input"
                    />

                    <div className="model-selector-wrapper">
                        <select 
                            value={model}
                            onChange={(e) => setModel(e.target.value)}
                            className="model-selector"
                        >
                            {OPENAI_MODELS.map(model => (
                                <option key={model} value={model}>{model}</option>
                            ))}
                        </select>
                    </div>

                    <div className="section-separator"></div>

                    <h3 className="section-title">📚 Playgrounds</h3>
                    <PlaygroundTray onLoadPlayground={loadPlayground} />

                    <div className="agency-details">
                        <textarea
                            value={agencyName}
                            onChange={(e) => setAgencyName(e.target.value)}
                            placeholder="Worksona Playground"
                            className="agency-name-textarea"
                        />
                        <textarea
                            value={agencyDescription}
                            onChange={(e) => setAgencyDescription(e.target.value)}
                            placeholder="Power Prompting Workspace"
                            className="agency-description-textarea"
                        />
                    </div>
                    </div>

                    <div style={{ display: 'flex', gap: '0.5rem', marginTop: '1rem' }}>
                        <input
                            type="file"
                            id="loadAgencyInput"
                            className="hidden"
                            accept=".json"
                            onChange={loadAgency}
                        />
                        <button 
                            onClick={() => document.getElementById('loadAgencyInput').click()} 
                            className="btn btn-agency"
                            style={{ flex: 1 }}
                        >
                            📂 Import Playground
                        </button>
                        <button 
                            onClick={exportAgency} 
                            className="btn btn-agency"
                            style={{ flex: 1 }}
                        >
                            💾 Export Playground
                        </button>
                    </div>
                </>
            )}
            
            {activeTab === 'content' && (
                <div className="content-tab" style={{ display: 'flex', flexDirection: 'column', flex: 1 }}>
                    {/* Upload Components Group */}
                    <div className="upload-content-group">
                        <div className="document-tray-title" style={{ color: 'var(--text-primary)', textTransform: 'uppercase' }}>
                            🎴 Upload Content
                        </div>
                        <input
                            type="file"
                            id="fileInput"
                            className="hidden"
                            accept=".txt,.md,.json,.pdf,image/*"
                            onChange={handleFileUpload}
                            multiple
                        />
                        <button 
                            onClick={() => document.getElementById('fileInput').click()}
                            className="btn btn-primary"
                            style={{ marginBottom: '1rem' }}
                        >
                            📎 Upload Texts, PDFs or Images
                        </button>

                        <div className="tray-container" style={{ display: 'flex', flexDirection: 'column', gap: '1rem', marginBottom: '2rem' }}>
                            <DocumentTray 
                                uploadedDocuments={uploadedDocuments} 
                                onDeleteDocument={(id) => {
                                    setUploadedDocuments(current => current.filter(doc => doc.id !== id));
                                }}
                                onSelectDocument={(content) => setSourceContent(content)}
                            />

                            <div className="document-tray-title" style={{ color: 'var(--text-primary)', textTransform: 'uppercase' }}>
                                🎴 Select Sources
                            </div>
                            <textarea
                                value={sourceContent}
                                onChange={(e) => setSourceContent(e.target.value)}
                                placeholder="Enter or upload source content..."
                                style={{ 
                                    width: '100%',
                                    minHeight: '200px',
                                    padding: '0.75rem',
                                    borderRadius: '0',
                                    border: '1px solid var(--border-color)',
                                    background: 'var(--primary-bg)',
                                    color: 'var(--text-primary)',
                                    resize: 'vertical'
                                }}
                            />

                            <ImageTray uploadedImages={uploadedImages} onDeleteImage={deleteImage} />
                        </div>
                    </div>

                    {/* Card Selection Group */}
                    <div className="document-tray-title" style={{ color: 'var(--text-primary)', textTransform: 'uppercase' }}>
                        🎴 Card Selection
                    </div>
                    <div className="selection-trays" style={{ display: 'flex', flexDirection: 'column', gap: '1rem', marginBottom: '1rem' }}>
                        <ScenarioTray onAddScenario={addScenarioCard} />
                        <PersonaTray onAddPersona={addPersonaCard} />
                        <PromptTray onAddPrompt={(template) => {
                            const newPrompt = {
                                ...template,
                                id: Date.now(),
                                result: '',
                                source: 'SOURCE',
                                sources: ['SOURCE'],
                                sourceType: 'text',
                                selectedImage: null,
                                selectedPersonas: []
                            };
                            setPrompts([...prompts, newPrompt]);
                        }} />
                    </div>
                </div>
            )}
        </div>

        {/* Add these styles in the <style> section */

        .playground-tray {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 0;
        }
        .playground-selector-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .playground-selector {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .add-playground-btn {
            background: var(--accent-color);
            color: var(--primary-bg);
            border: none;
            border-radius: 0;
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 1.25rem;
            line-height: 1;
        }

        .add-playground-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .add-playground-btn:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .section-separator {
            height: 1px;
            background: var(--border-color);
            margin: 1.5rem 0;
            width: 100%;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Add new styles for scenario fields */
        .scenario-section {
            margin-bottom: 1.5rem;
        }

        .scenario-section-title {
            font-weight: 500;
            color: var(--accent-color);
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            text-transform: uppercase;
        }

        .scenario-field {
            margin-bottom: 1rem;
        }

        .scenario-field-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            text-transform: capitalize;
        }

        .scenario-textarea {
            width: 100%;
            min-height: 150px; /* Increased from 60px */
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            resize: vertical;
            outline: none;
            font-family: inherit;
            background: var(--primary-bg);
            color: var(--text-primary);
            margin: 0 0.5rem 0.5rem 0.5rem;
            box-sizing: border-box;
        }

        .scenario-textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(99, 226, 183, 0.2);
        }

        /* Add these styles for the slider toggle */
        .source-mode-toggle {
            display: flex;
            align-items: center;
            gap: 0.25rem;  /* Reduced from 0.75rem */
            font-size: 0.65rem;  /* Reduced from 0.75rem */
            margin-top: 0.25rem;  /* Reduced space from text area above */
            margin-bottom: 1rem;  /* Space before next section */
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 20px;  /* Reduced from 28px */
            height: 12px;  /* Reduced from 16px */
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 8px;  /* Reduced from 12px */
            width: 8px;   /* Reduced from 12px */
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--accent-color);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(8px);  /* Reduced from 12px */
        }

        .toggle-switch:hover .toggle-slider {
            background-color: var(--accent-color);
            opacity: 0.8;
        }

        .toggle-switch input:checked:hover + .toggle-slider {
            opacity: 0.8;
        }

        .source-mode-toggle span {
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .source-mode-toggle span:first-child {
            font-weight: 500;
        }

        .source-selector {
            margin-bottom: 1rem;
        }

        .source-selector option {
            padding: 0.5rem 0.5rem 0.5rem 2rem;
            cursor: pointer;
            position: relative;
        }

        .source-selector option:checked,
        .source-selector option:hover:checked,
        .source-selector option[selected] {
            background: var(--accent-color) !important;
            color: white !important;
            -webkit-appearance: none;
            appearance: none;
        }

        .source-selector option:checked::before,
        .source-selector option[selected]::before {
            content: "✓";
            position: absolute;
            left: 0.5rem;
            color: white;
            font-weight: bold;
        }

        .source-selector option:hover {
            background: rgba(226, 152, 99, 0.1);
        }

        .persona-selector {
            margin-bottom: 1rem;
        }

    .persona-selector option {
        padding: 0.5rem 0.5rem 0.5rem 2rem;
        cursor: pointer;
        position: relative;
    }

    .persona-selector option:checked,
    .persona-selector option:hover:checked,
    .persona-selector option[selected] {
        background: var(--accent-color) !important;
        color: white !important;
        -webkit-appearance: none;
        appearance: none;
    }

    .persona-selector option:checked::before,
    .persona-selector option[selected]::before {
        content: "✓";
        position: absolute;
        left: 0.5rem;
        color: white;
        font-weight: bold;
    }

    .persona-selector option:hover {
        background: rgba(226, 152, 99, 0.1);
    }

    .component-divider {
        height: 1px;
        background-color: var(--border-color);
        margin: 1rem 0;
        opacity: 0.5;
    }

    /* Prompt Selector styles */
    .prompt-tray {
        margin-top: 1rem;
        padding: 1rem;
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 0;
    }

    .prompt-selector-container {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .prompt-selector {
        flex: 1;
        padding: 0.75rem;  /* Increased from 0.5rem */
        border: 1px solid var(--border-color);
        border-radius: 0;
        background: var(--primary-bg);
        color: var(--text-primary);
        font-size: 0.875rem;  /* Added to match persona selector */
        transition: all 0.2s ease;  /* Added transition */
        cursor: pointer;
        -webkit-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 1em;
        padding-right: 2.5rem;
    }

    .prompt-selector:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 2px rgba(226, 152, 99, 0.1);
        outline: none;
    }

    .prompt-selector option {
        padding: 0.5rem;
        font-size: 0.875rem;
    }

    .add-prompt-btn {
        background: var(--accent-color);
        color: var(--primary-bg);
        border: none;
        border-radius: 0;
        padding: 0.5rem 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .add-prompt-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .add-prompt-btn:hover:not(:disabled) {
        opacity: 0.9;
    }

    /* Add these new styles in the style section */
    .floating-gear {
        position: fixed;
        top: 1rem;
        right: 1rem;
        width: 48px;
        height: 48px;
        background: var(--accent-color);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        color: white;
        padding: 0;
    }

    .floating-gear:hover {
        transform: rotate(90deg);
        opacity: 0.9;
    }

    .floating-gear svg {
        width: 24px;
        height: 24px;
        stroke: currentColor;
        fill: none;
    }

    /* Remove any duplicate floating gear button HTML in the style section */

    /* Add these styles for the settings panel */
    .settings-panel {
        position: fixed;
        top: 0;
        right: -420px; /* Start off-screen */
        width: 400px;
        height: 100vh;
        background: var(--secondary-bg);
        border-left: 1px solid var(--border-color);
        padding: 1.5rem;
        box-shadow: -2px 0 8px rgba(0, 0, 0, 0.2);
        transition: right 0.3s ease;
        z-index: 9998;
        overflow-y: auto;
    }

    .settings-panel.open {
        right: 0;
    }

    .settings-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2rem;
    }

    .settings-panel-title {
        font-size: 1.25rem;
        font-weight: 500;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .settings-panel-close {
        background: none;
        border: none;
        color: var(--text-primary);
        cursor: pointer;
        padding: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s ease;
    }

    .settings-panel-close:hover {
        transform: rotate(90deg);
    }

    .settings-section {
        margin-bottom: 2rem;
    }

    .settings-section-title {
        font-size: 1rem;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Update the floating gear styles */
    .floating-gear {
        position: fixed;
        top: 1rem;
        right: 1rem;
        width: 48px;
        height: 48px;
        background: var(--accent-color);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        color: white;
        padding: 0;
    }

    .floating-gear:hover {
        transform: rotate(90deg);
        opacity: 0.9;
    }

    .floating-gear svg {
        width: 24px;
        height: 24px;
        stroke: currentColor;
        fill: none;
    }

    /* Remove all existing floating-gear styles and add this single definition */
    .floating-gear {
        position: fixed;
        top: 1rem;
        right: 1rem;
        width: 48px;
        height: 48px;
        background: var(--accent-color);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        color: white;
        padding: 0;
    }

    .floating-gear:hover {
        transform: rotate(90deg);
        opacity: 0.9;
    }

    .floating-gear svg {
        width: 24px;
        height: 24px;
        stroke: currentColor;
        fill: none;
    }

    /* Add new chat window styles */
    .chat-toggle-button {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 48px;
        height: 48px;
        background: var(--accent-color);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999999; /* Increased z-index to ensure visibility */
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        color: white;
        padding: 0;
        pointer-events: auto; /* Ensure clickability */
    }

    .chat-toggle-button:hover {
        transform: translateY(-2px);
        opacity: 0.9;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .chat-toggle-button svg {
        width: 24px;
        height: 24px;
        stroke: currentColor;
        fill: none;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
    }

    .chat-window {
        position: fixed;
        bottom: 6rem;
        right: 2rem;
        width: 400px;
        height: 600px;
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        z-index: 99998;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        transform-origin: bottom right;
    }

    .chat-window.hidden {
        transform: scale(0);
        opacity: 0;
    }

    .chat-titlebar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background: var(--accent-color);
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        color: white;
    }

    .chat-title {
        font-weight: 500;
        font-size: 1rem;
    }

    .chat-titlebar-actions {
        display: flex;
        gap: 0.5rem;
    }

    .chat-titlebar-button {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.8;
        transition: opacity 0.2s ease;
    }

    .chat-titlebar-button:hover {
        opacity: 1;
    }

    .chat-titlebar-button svg {
        width: 16px;
        height: 16px;
        stroke: currentColor;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .chat-message {
        display: flex;
        gap: 0.75rem;
        align-items: flex-start;
    }

    .chat-message.user {
        flex-direction: row-reverse;
    }

    .chat-message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--accent-color);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 500;
        flex-shrink: 0;
    }

    .chat-message-content {
        background: var(--primary-bg);
        padding: 0.75rem 1rem;
        border-radius: 12px;
        max-width: 80%;
        color: var(--text-primary);
    }

    .chat-message.user .chat-message-content {
        background: var(--accent-color);
        color: white;
    }

    .chat-input-container {
        padding: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .chat-input {
        width: 100%;
        min-height: 60px;
        max-height: 150px;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: var(--primary-bg);
        color: var(--text-primary);
        resize: vertical;
        outline: none;
        font-family: inherit;
        font-size: 0.875rem;
    }

    .chat-input:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.1);
    }

    .chat-message-content[contenteditable="true"] {
        outline: none;
        cursor: text;
    }

    .chat-message-content[contenteditable="true"]:focus {
        box-shadow: 0 0 0 2px var(--accent-color);
    }

    /* Add padding to the last child in the fixed-section to ensure space after buttons */
    .fixed-section > *:last-child {
        padding-bottom: 1rem;
    }

    /* Add padding to the last child before the button bar */
    .tab-content > *:not(.button-bar):last-child {
        margin-bottom: 2rem; /* Add space before buttons */
    }

    /* Update source selector styles */
    .source-selector {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 0;
        background: var(--primary-bg);
        color: var(--text-primary);
        outline: none;
        margin-bottom: 0.5rem;
        min-height: 120px; /* Add minimum height */
        max-height: 200px;
        overflow-y: auto;
    }

    /* Update persona selector styles */
    .persona-selector {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 0;
        background: var(--primary-bg);
        color: var(--text-primary);
        outline: none;
        margin-bottom: 0.5rem;
        min-height: 120px; /* Add minimum height */
        max-height: 200px;
        overflow-y: auto;
    }

    /* Add flex layout to prompt card content */
    .prompt-card {
        display: flex;
        flex-direction: column;
    }

    /* Make source and persona sections maintain size */
    .source-section,
    .persona-section {
        flex-shrink: 0; /* Prevent sections from shrinking */
        min-height: 160px; /* Include labels and margins */
        margin-bottom: 1rem;
    }

    /* Make result section flexible */
    .result-container {
        flex: 1;
        min-height: 250px;
        display: flex;
        flex-direction: column;
    }

    /* Update the card selection styles */
    .document-tray-title {
        color: var(--text-primary);
        text-transform: uppercase;
        font-size: 0.75rem;
        margin-bottom: 0.25rem;
    }

    .selection-trays {
        display: flex;
        gap: 0.25rem;
        margin-bottom: 0.5rem;
    }

    .playground-tray,
    .scenario-tray,
    .persona-tray,
    .prompt-tray {
        padding: 0.25rem;
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 0;
    }

    .playground-selector,
    .scenario-selector,
    .persona-selector,
    .prompt-selector {
        padding: 0.25rem;
        font-size: 0.75rem;
        height: 24px;
    }

    .add-playground-btn,
    .add-scenario-btn,
    .add-persona-btn,
    .add-prompt-btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        height: 24px;
        min-width: 24px;
        border: 1px solid var(--text-primary);
        background: transparent;
        color: var(--text-primary);
    }

    .selector-container {
        display: flex;
        gap: 0.25rem;
        align-items: center;
    }

    /* Update the section title to be more compact */
    .section-title {
        font-size: 0.75rem;
        margin-bottom: 0.25rem;
    }

    /* Add scenario-container styles */
    .scenario-container {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        min-width: 300px;
        max-width: 400px;
        flex-shrink: 0;
        margin-left: 20px; /* Add margin to fix horizontal positioning */
    }

    /* Update scenario card styles to have different heights for different fields */
    .scenario-textarea {
        width: calc(100% - 1rem);
        min-height: 150px; /* Default height for most textareas */
        height: 150px;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0;
        resize: vertical;
        outline: none;
        font-family: inherit;
        background: var(--primary-bg);
        color: var(--text-primary);
        margin: 0 0.5rem 0.5rem 0.5rem;
        box-sizing: border-box;
    }

    /* Add specific style for the name textarea */
    .scenario-field:first-of-type .scenario-textarea {
        min-height: 40px; /* Reduced from 60px to fit 2 lines */
        height: 40px;
    }

    /* Add this style in the <style> section */
    .source-textarea {
        width: 100%;
        min-height: 200px;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0;
        background: var(--primary-bg);
        color: var(--text-primary);
        resize: vertical;
        outline: none;
        font-family: inherit;
        box-sizing: border-box;
        margin-bottom: 1rem;
    }

    .source-textarea:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 2px rgba(99, 226, 183, 0.2);
    }

    /* Rich text content styles */
    .result-content {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .result-content h1 {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 1rem 0;
        color: var(--accent-color);
    }

    .result-content h2 {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0.875rem 0;
        color: var(--accent-color);
    }

    .result-content h3 {
        font-size: 1.125rem;
        font-weight: 600;
        margin: 0.75rem 0;
        color: var(--accent-color);
    }

    .result-content p {
        margin: 0.75rem 0;
        line-height: 1.6;
    }

    .result-content strong {
        font-weight: 600;
        color: var(--accent-color);
    }

    .result-content em {
        font-style: italic;
        color: var(--text-secondary);
    }

    .result-content code {
        font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
        background: rgba(0, 0, 0, 0.1);
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-size: 0.875em;
        color: var(--accent-color);
    }

    .result-content pre {
        background: rgba(0, 0, 0, 0.1);
        padding: 1rem;
        border-radius: 4px;
        overflow-x: auto;
        margin: 0.75rem 0;
    }

    .result-content pre code {
        background: none;
        padding: 0;
        font-size: 0.875rem;
        color: var(--text-primary);
    }

    .result-content ul, 
    .result-content ol {
        margin: 0.75rem 0;
        padding-left: 1.5rem;
    }

    .result-content li {
        margin: 0.375rem 0;
        line-height: 1.6;
    }

    .result-content a {
        color: var(--accent-color);
        text-decoration: none;
        border-bottom: 1px solid transparent;
        transition: border-color 0.2s ease;
    }

    .result-content a:hover {
        border-bottom-color: var(--accent-color);
    }

    .result-content blockquote {
        border-left: 3px solid var(--accent-color);
        margin: 0.75rem 0;
        padding-left: 1rem;
        color: var(--text-secondary);
        font-style: italic;
    }

    /* New styles for titling sections in cards */
    .card-section-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--secondary-accent);
        border-bottom: 2px solid var(--secondary-accent);
        padding-bottom: 0.25rem;
        margin-bottom: 0.75rem;
    }

    .result-label {
        font-size: 1rem;
        font-weight: 600;
        color: var(--secondary-accent);
        border-bottom: 2px solid var(--secondary-accent);
        padding-bottom: 0.25rem;
        margin-bottom: 0.75rem;
    }

    .source-label {
        font-size: 1rem;
        font-weight: 600;
        color: var(--secondary-accent);
        border-bottom: 2px solid var(--secondary-accent);
        padding-bottom: 0.25rem;
        margin-bottom: 0.75rem;
    }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        // Add this constant at the top of your script, before any other code
        const PERSONAS = {
            'Customers': [
                {
                    id: 'value-seeker',
                    name: 'Value-Conscious Shopper',
                    emoji: '💰',
                    description: 'Price-sensitive consumer who prioritizes deals and discounts. Carefully researches purchases, compares prices, and seeks the best value for money. Loyal to brands that offer consistent value and rewards programs.'
                },
                {
                    id: 'luxury-buyer',
                    name: 'Luxury Lifestyle Consumer',
                    emoji: '✨',
                    description: 'High-end shopper who values premium quality and exclusive brands. Willing to pay more for superior products and experiences. Appreciates personalized service and unique offerings.'
                },
                {
                    id: 'eco-conscious',
                    name: 'Eco-Conscious Consumer',
                    emoji: '🌱',
                    description: 'Environmentally aware shopper who prioritizes sustainable and ethical products. Seeks brands with strong environmental commitments and transparent practices. Values eco-friendly packaging and materials.'
                },
                {
                    id: 'tech-savvy',
                    name: 'Digital-First Shopper',
                    emoji: '📱',
                    description: 'Tech-savvy consumer who prefers online shopping and digital experiences. Comfortable with new technologies, values convenience, and expects seamless omnichannel experiences.'
                },
                {
                    id: 'traditional',
                    name: 'Traditional Retail Shopper',
                    emoji: '🏪',
                    description: 'Prefers in-store shopping experiences and values personal interaction. Appreciates hands-on product examination and face-to-face customer service. Values established retail relationships.'
                }
            ],
            'Service Types': [
                {
                    id: 'convenience',
                    name: 'Convenience Services',
                    emoji: '⚡',
                    description: 'Focuses on quick, efficient solutions for busy consumers. Offers time-saving options and streamlined processes. Values accessibility and ease of use above all.'
                },
                {
                    id: 'premium',
                    name: 'Premium Services',
                    emoji: '👑',
                    description: 'Delivers high-end, personalized experiences. Emphasizes quality, exclusivity, and exceptional customer care. Caters to discerning clients who expect the best.'
                },
                {
                    id: 'specialized',
                    name: 'Specialized Services',
                    emoji: '🎯',
                    description: 'Provides expert solutions in specific niches. Offers deep knowledge and customized approaches. Values expertise and targeted problem-solving.'
                },
                {
                    id: 'digital',
                    name: 'Digital Services',
                    emoji: '💻',
                    description: 'Delivers solutions through digital platforms and technology. Emphasizes automation, scalability, and data-driven approaches. Values innovation and technological advancement.'
                },
                {
                    id: 'consultative',
                    name: 'Consultative Services',
                    emoji: '🤝',
                    description: 'Focuses on advisory and relationship-based solutions. Emphasizes understanding client needs and providing strategic guidance. Values long-term partnerships and continuous improvement.'
                }
            ],
            'C-Suite': [
                {
                    id: 'ceo',
                    name: 'Chief Executive Officer',
                    emoji: '👑',
                    description: 'As a seasoned leader, you\'ve successfully steered companies through growth and transformation. Your strategic vision and decisive leadership have been key to achieving long-term success and market leadership.'
                },
                {
                    id: 'cfo',
                    name: 'Chief Financial Officer',
                    emoji: '💰',
                    description: 'With a sharp financial acumen, you\'ve navigated complex financial landscapes to keep projects profitable. Your strategic financial management has been instrumental in sustaining growth and maximizing returns.'
                },
                {
                    id: 'cmo',
                    name: 'Chief Marketing Officer',
                    emoji: '📈',
                    description: 'A marketing powerhouse, you have successfully led branding and marketing initiatives that have positioned products as market leaders. Your ability to craft and execute winning strategies has driven significant market share growth.'
                },
                {
                    id: 'cto',
                    name: 'Chief Technology Officer',
                    emoji: '💻',
                    description: 'A technology visionary, you\'ve pioneered innovative solutions that have kept companies at the forefront of their industries. Your leadership in technology has driven sustainable growth and competitive advantage.'
                },
                {
                    id: 'cxo',
                    name: 'Chief Experience Officer',
                    emoji: '🌟',
                    description: 'A champion of customer experience, you have transformed customer interactions into memorable experiences. Your strategies have consistently improved customer satisfaction and loyalty, setting new standards in the industry.'
                }
            ],
            'Agency': [
                {
                    id: 'customer',
                    name: 'Customer Experience Leader',
                    emoji: '🤝',
                    description: 'A customer-centric strategist who has revolutionized service delivery standards. Your innovative approaches have transformed customer satisfaction metrics and established industry-leading loyalty programs.'
                },
                {
                    id: 'analyst',
                    name: 'Data Analytics Expert',
                    emoji: '📊',
                    description: 'A sophisticated data scientist with expertise in predictive modeling and business intelligence. Your analytical insights have driven strategic decisions and uncovered valuable market opportunities.'
                },
                {
                    id: 'trainer',
                    name: 'Learning Development Expert',
                    emoji: '📚',
                    description: 'An innovative education strategist who has designed transformative learning programs. Your methodologies have significantly improved organizational capabilities and employee development outcomes.'
                },
                {
                    id: 'hr',
                    name: 'HR Strategic Leader',
                    emoji: '👥',
                    description: 'A progressive HR leader who has shaped organizational culture and talent strategies. Your initiatives have enhanced employee engagement and established best-in-class talent management practices.'
                },
                {
                    id: 'marketing-manager',
                    name: 'Marketing Manager',
                    emoji: '🎯',
                    description: 'A strategic marketer with a creative edge, you\'ve launched campaigns that have significantly boosted brand visibility and customer engagement. Your strategies have consistently delivered high returns on investment.'
                },
                {
                    id: 'social-media',
                    name: 'Social Media Manager',
                    emoji: '💬',
                    description: 'A social media maven, you\'ve grown online communities into thriving hubs of engagement. Your ability to connect with audiences has turned casual followers into loyal brand advocates.'
                },
                {
                    id: 'advertising',
                    name: 'Advertising/Media Manager',
                    emoji: '📺',
                    description: 'You have orchestrated high-impact media campaigns that have reached millions. With a keen understanding of media dynamics, you ensure that every ad dollar spent generates maximum visibility and engagement.'
                },
                {
                    id: 'creative-director',
                    name: 'Creative Director',
                    emoji: '🎨',
                    description: 'A visionary with a keen eye for detail, you have brought brands to life with stunning creative work. Your leadership in creative projects has consistently resulted in award-winning campaigns and iconic brand imagery.'
                }
            ]
        };

        // Constants
        const OPENAI_MODELS = [
            "gpt-4o",
            "gpt-4-turbo-preview",
            "gpt-4",
            "gpt-3.5-turbo"
        ];

        const SUPPORTED_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/gif'];
        const MAX_IMAGE_SIZE = 10 * 1024 * 1024; // 10MB

        // Update the SUPPORTED_FILE_TYPES constant
        const SUPPORTED_FILE_TYPES = [
            'text/plain',
            'text/markdown',
            'application/json',
            'application/pdf',  // Add PDF support
            ...SUPPORTED_IMAGE_TYPES
        ];

        // Update the FileProcessor utility
        const FileProcessor = {
            async processImage(file) {
                if (!file || !SUPPORTED_IMAGE_TYPES.includes(file.type)) {
                    throw new Error('Unsupported image type');
                }

                if (file.size > MAX_IMAGE_SIZE) {
                    throw new Error('Image size too large (max 10MB)');
                }

                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = () => reject(new Error('Error reading image'));
                    reader.readAsDataURL(file);
                });
            },

            async processPDF(file) {
                return new Promise(async (resolve, reject) => {
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        let fullText = '';
                        
                        // Process each page
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += `Page ${i}:\n${pageText}\n\n`;
                        }
                        
                        resolve(fullText);
                    } catch (error) {
                        reject(new Error('Error processing PDF: ' + error.message));
                    }
                });
            }
        };

        // React Components
        const CopyButton = ({ text }) => {
            const [copied, setCopied] = React.useState(false);
            
            const copyToClipboard = async () => {
                try {
                    await navigator.clipboard.writeText(text);
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                } catch (err) {
                    console.error('Failed to copy:', err);
                }
            };

            return (
                <button 
                    onClick={copyToClipboard} 
                    className="copy-button" 
                    title={copied ? "Copied!" : "Copy to clipboard"}
                >
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        {copied ? (
                            <path d="M20 6L9 17l-5-5"/>
                        ) : (
                            <>
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </>
                        )}
                    </svg>
                </button>
            );
        };

        const ProcessingIndicator = ({ isVisible }) => (
            <div className={`processing-file ${!isVisible ? 'hidden' : ''}`}>
                <h3>Processing File...</h3>
                <p>Please wait while we process your content</p>
            </div>
        );

        const PersonaCard = ({ persona, onUpdate, onDelete, apiKey }) => {
            return (
                <div className="persona-card">
                    <div className="persona-header">
                        <span className="persona-emoji">{persona.emoji}</span>
                        <span className="persona-title">PERSONA CARD</span>
                        <input 
                            type="text" 
                            className="persona-name" 
                            value={persona.name} 
                            onChange={(e) => onUpdate(persona.cardId, { name: e.target.value })}
                        />
                    </div>
                    
                    <textarea
                        value={persona.description}
                        onChange={(e) => onUpdate(persona.cardId, { description: e.target.value })}
                        className="persona-textarea"
                        spellCheck="true"
                        rows="6"
                    />
                    
                    <button 
                        onClick={() => onDelete(persona.cardId)}
                        className="btn btn-danger"
                    >
                        Delete
                    </button>
                </div>
            );
        };

        const PersonaTray = ({ onAddPersona }) => {
            const [selectedPersona, setSelectedPersona] = React.useState('');

            const handleAddPersona = () => {
                if (selectedPersona === 'empty') {
                    onAddPersona({
                        cardId: Date.now(),
                        id: 'empty',
                        name: '',
                        emoji: '👤',
                        description: ''
                    });
                    setSelectedPersona('');
                    return;
                }

                if (selectedPersona) {
                    const persona = Object.values(PERSONAS)
                        .flat()
                        .find(p => p.id === selectedPersona);
                    
                    if (persona) {
                        onAddPersona({
                            ...persona,
                            cardId: Date.now()
                        });
                        setSelectedPersona('');
                    }
                }
            };

            return (
                <div className="persona-tray">
                    <div className="persona-selector-container">
                        <select 
                            value={selectedPersona}
                            onChange={(e) => setSelectedPersona(e.target.value)}
                            className="persona-selector"
                        >
                            <option value="">👥 Select Audience...</option>
                            <option value="empty">✨ Empty Audience Card</option>
                            <optgroup label="Customer">
                                {PERSONAS['Customers'].map(persona => (
                                    <option key={persona.id} value={persona.id}>
                                        {persona.emoji} {persona.name}
                                    </option>
                                ))}
                            </optgroup>
                            <optgroup label="Service">
                                {PERSONAS['Service Types'].map(persona => (
                                    <option key={persona.id} value={persona.id}>
                                        {persona.emoji} {persona.name}
                                    </option>
                                ))}
                            </optgroup>
                            <optgroup label="C-Suite">
                                {PERSONAS['C-Suite'].map(persona => (
                                    <option key={persona.id} value={persona.id}>
                                        {persona.emoji} {persona.name}
                                    </option>
                                ))}
                            </optgroup>
                            <optgroup label="Agency">
                                {PERSONAS['Agency'].map(persona => (
                                    <option key={persona.id} value={persona.id}>
                                        {persona.emoji} {persona.name}
                                    </option>
                                ))}
                            </optgroup>
                        </select>
                        <button 
                            onClick={handleAddPersona}
                            className="add-persona-btn"
                            disabled={!selectedPersona}
                        >
                            +
                        </button>
                    </div>
                </div>
            );
        };

        // Add this before the PromptCard component definition
        const markdownToHtml = (markdown) => {
            if (!markdown) return '';
            
            return markdown
                // Headers
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                // Bold
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Italic
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Code blocks
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                // Inline code
                .replace(/`(.*?)`/g, '<code>$1</code>')
                // Lists
                .replace(/^\s*\d+\.\s+(.*$)/gm, '<li>$1</li>')
                .replace(/^\s*[-*]\s+(.*$)/gm, '<li>$1</li>')
                // Wrap lists in appropriate containers
                .replace(/(<li>.*<\/li>)\n(<li>.*<\/li>)/g, '<ul>$1$2</ul>')
                // Paragraphs
                .replace(/\n\n/g, '</p><p>')
                // Line breaks
                .replace(/\n/g, '<br>')
                // Wrap in paragraph if not already wrapped
                .replace(/^(.+)$/, '<p>$1</p>');
        };

        const PromptCard = ({ prompt, sourceOptions, loading, onUpdate, onDelete, onRun, uploadedImages, uploadedDocuments, apiKey, personaCards, sourceContent, onSourceSelect }) => {
            const [enhancing, setEnhancing] = React.useState(false);
            const [enhanceStatus, setEnhanceStatus] = React.useState('');
            // Add expanded state
            const [isExpanded, setIsExpanded] = React.useState(false);

            const handleEnhance = async () => {
                if (!prompt.result) return;
                
                setEnhancing(true);
                try {
                    const selectedImage = uploadedImages.find(img => img.id === prompt.selectedImage);
                    if (!selectedImage) {
                        throw new Error('Selected image not found');
                    }

                    setEnhanceStatus('Sending analysis request...');
                    
                    // Ensure the image URL is base64
                    const imageUrl = selectedImage.url; // This should already be base64 from our upload process

                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`,
                        },
                        body: JSON.stringify({
                            model: "gpt-4o", // Correct model name
                            messages: [
                                {
                                    role: "user",
                                    content: [
                                        { 
                                            type: "text", 
                                            text: prompt.text 
                                        },
                                        {
                                            type: "image_url",
                                            image_url: {
                                                url: imageUrl,
                                                detail: "high" // Changed from "auto" to "high" for better analysis
                                            }
                                        }
                                    ]
                                }
                            ],
                            max_tokens: 1000 // Increased from 500 for more detailed responses
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                    }

                    setEnhanceStatus('Processing response...');
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error.message);
                    }
                    
                    const enhancedResult = data.choices[0].message.content;
                    onUpdate(prompt.id, { result: enhancedResult });
                    
                    setEnhanceStatus('Analysis complete!');
                    setTimeout(() => setEnhanceStatus(''), 2000);
                } catch (error) {
                    console.error('Analysis error:', error);
                    setEnhanceStatus(`Error: ${error.message}`);
                    setTimeout(() => setEnhanceStatus(''), 3000);
                } finally {
                    setEnhancing(false);
                }
            };

            // When the component mounts or when prompt.id changes, set a default title if none exists
            React.useEffect(() => {
                if (!prompt.title || prompt.title === `${prompt.id}`) {
                    onUpdate(prompt.id, { title: `AGENT${prompt.id}` });
                }
            }, [prompt.id]);

            const isImageMode = prompt.sourceType === 'image';

            const renderFormattedResult = () => {
                return { __html: markdownToHtml(prompt.result) };
            };

            return (
                <div className={`prompt-card ${isImageMode ? 'image-mode' : ''}`} style={{
                    // Add width style based on expanded state
                    width: isExpanded ? '800px' : '400px',
                    maxWidth: isExpanded ? '800px' : '400px',
                    transition: 'width 0.3s ease, max-width 0.3s ease'
                }}>
                    <div className="prompt-header">
                        <span className="prompt-emoji">📝</span>
                        <span className="prompt-title">AGENT CARD</span>
                        <input
                            type="text"
                            className="prompt-title-input"
                            value={prompt.title || `AGENT${prompt.id}`}
                            onChange={(e) => onUpdate(prompt.id, { title: e.target.value })}
                            placeholder={`AGENT${prompt.id}`}
                        />
                        {/* Add expand button */}
                        <button
                            onClick={() => setIsExpanded(!isExpanded)}
                            className="expand-button"
                            title={isExpanded ? "Collapse" : "Expand"}
                            style={{
                                background: 'none',
                                border: 'none',
                                color: 'var(--accent-color)',
                                cursor: 'pointer',
                                padding: '0.5rem',
                                marginLeft: 'auto',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                transition: 'transform 0.3s ease',
                                transform: isExpanded ? 'rotate(180deg)' : 'none'
                            }}
                        >
                            <svg 
                                viewBox="0 0 24 24" 
                                fill="none" 
                                stroke="currentColor" 
                                width="16" 
                                height="16"
                            >
                                <path 
                                    d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" 
                                    strokeWidth="2" 
                                    strokeLinecap="round" 
                                    strokeLinejoin="round"
                                />
                            </svg>
                        </button>
                    </div>
            
                    <div className="source-type-selector">
                        <button 
                            className={`source-type-button ${prompt.sourceType === 'text' ? 'active' : ''}`}
                            onClick={() => onUpdate(prompt.id, { sourceType: 'text' })}
                        >
                            Text
                        </button>
                        <button 
                            className={`source-type-button ${prompt.sourceType === 'image' ? 'active' : ''}`}
                            onClick={() => onUpdate(prompt.id, { sourceType: 'image' })}
                        >
                            Image
                        </button>
                    </div>

                    {isImageMode ? (
                        <>
                            <div className="source-label card-section-title">Select Image</div>
                            <select
                                value={prompt.selectedImage || ''}
                                onChange={(e) => {
                                    const value = e.target.value ? parseInt(e.target.value) : '';
                                    onUpdate(prompt.id, { selectedImage: value });
                                }}
                                className="source-selector"
                            >
                                <option value="">Select an image...</option>
                                {uploadedImages.map(img => (
                                    <option key={img.id} value={img.id}>
                                        {img.name || `Image ${img.id}`}
                                    </option>
                                ))}
                            </select>
                            {prompt.selectedImage && (
                                <div className="image-preview-container">
                                    <img 
                                        src={uploadedImages.find(img => img.id === parseInt(prompt.selectedImage))?.url} 
                                        alt="Selected" 
                                        className="image-preview"
                                    />
                                </div>
                            )}
                        </>
                    ) : (
                        <>
                            <div className="source-label card-section-title">SELECT SOURCES</div>
                            <select 
                                multiple
                                value={prompt.sources || ['SOURCE']}
                                onChange={(e) => {
                                    const selectedOptions = Array.from(e.target.selectedOptions).map(option => option.value);
                                    onUpdate(prompt.id, { 
                                        ...prompt, 
                                        sources: selectedOptions,
                                        source: selectedOptions.includes('SOURCE') ? sourceContent : prompt.source
                                    });
                                }}
                                className="source-selector"
                            >
                                <option value="SOURCE">SOURCE</option>
                                {uploadedDocuments.map(doc => (
                                    <option key={doc.id} value={`DOC-${doc.id}`}>
                                        📄 {doc.name}
                                    </option>
                                ))}
                                {sourceOptions.map(p => (
                                    <option key={p.id} value={`RESULT${p.id}`}>
                                        💬 Result from Prompt {p.id}
                                    </option>
                                ))}
                            </select>
                        </>
                    )}

                    <div className="persona-label">SELECT PERSONAS</div>
                    <select
                        multiple
                        value={prompt.selectedPersonas || []}
                        onChange={(e) => {
                            const selectedOptions = Array.from(e.target.selectedOptions).map(option => option.value);
                            onUpdate(prompt.id, { ...prompt, selectedPersonas: selectedOptions });
                        }}
                        className="source-selector"
                    >
                        {personaCards.map(persona => (
                            <option key={persona.cardId} value={persona.cardId}>
                                {persona.direction === 'from' ? '🗣️ FROM: ' : '👥 TO: '} {persona.name}
                            </option>
                        ))}
                    </select>
            
                    <div className="prompt-label">PROMPT</div>
                    {/* Add prompt actions bar */}
                    <div className="prompt-actions" style={{
                        position: 'relative',
                        marginBottom: '0',  // Remove bottom margin to sit directly on textarea
                        display: 'flex',
                        justifyContent: 'flex-end',
                        gap: '0.5rem'
                    }}>
                        <button
                            className="result-button"
                            onClick={handleEnhance}
                            title="Enhance prompt"
                            disabled={!prompt.text || enhancing}
                        >
                            {enhancing ? (
                                <div className="loading-spinner"></div>
                            ) : (
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83" strokeWidth="2" strokeLinecap="round"/>
                                </svg>
                            )}
                        </button>
                        <button
                            className="result-button"
                            onClick={() => {
                                const textarea = document.querySelector(`#prompt-${prompt.id}`);
                                if (textarea) {
                                    if (textarea.style.height === '500px') {
                                        textarea.style.height = '200px'; // Return to original height
                                    } else {
                                        textarea.style.height = '500px'; // Expand
                                    }
                                }
                            }}
                            title="Toggle prompt size"
                        >
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                            </svg>
                        </button>
                        <button
                            className="result-button"
                            onClick={() => navigator.clipboard.writeText(prompt.text)}
                            title="Copy prompt"
                        >
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M8 4v12a2 2 0 002 2h8a2 2 0 002-2V7.242a2 2 0 00-.602-1.43L16.083 2.57A2 2 0 0014.685 2H10a2 2 0 00-2 2z" strokeWidth="2" strokeLinecap="round"/>
                                <path d="M16 18v2a2 2 0 01-2 2H6a2 2 0 01-2-2V9a2 2 0 012-2h2" strokeWidth="2" strokeLinecap="round"/>
                            </svg>
                        </button>
                        <button
                            className="result-button"
                            onClick={() => onUpdate(prompt.id, { text: '' })}
                            title="Clear prompt"
                        >
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M19 7l-7 7m0 0l-7-7m7 7V4" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                            </svg>
                        </button>
                    </div>

                    <textarea
                        id={`prompt-${prompt.id}`}
                        value={prompt.text}
                        onChange={(e) => onUpdate(prompt.id, { text: e.target.value })}
                        placeholder={isImageMode ? "Enter your image analysis prompt..." : "Enter your prompt..."}
                        className="prompt-textarea"
                        spellCheck="true"
                        autoComplete="off"
                        rows="6"
                    />
            
                    <div className="result-container">
                        <div className="result-label card-section-title">RESULT {prompt.id}</div>
                        
                        {/* Move result actions here, above the textarea */}
                        <div className="result-actions" style={{
                            position: 'relative',
                            marginBottom: '0.5rem',
                            display: 'flex',
                            justifyContent: 'flex-end',
                            gap: '0.5rem'
                        }}>
                            <button
                                className="result-button"
                                onClick={handleEnhance}
                                title="Enhance content"
                                disabled={!prompt.result || enhancing}
                            >
                                {enhancing ? (
                                    <div className="loading-spinner"></div>
                                ) : (
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83" strokeWidth="2" strokeLinecap="round"/>
                                    </svg>
                                )}
                            </button>
                            <button
                                className="result-button"
                                onClick={() => {
                                    const textarea = document.querySelector(`#result-${prompt.id}`);
                                    if (textarea) {
                                        // Toggle between expanded and normal height
                                        if (textarea.style.height === '500px') {
                                            textarea.style.height = '250px'; // Return to original height
                                        } else {
                                            textarea.style.height = '500px'; // Expand
                                        }
                                    }
                                }}
                                title="Toggle result size"
                            >
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                </svg>
                            </button>
                            <button
                                className="result-button"
                                onClick={() => navigator.clipboard.writeText(prompt.result)}
                                title="Copy to clipboard"
                            >
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M8 4v12a2 2 0 002 2h8a2 2 0 002-2V7.242a2 2 0 00-.602-1.43L16.083 2.57A2 2 0 0014.685 2H10a2 2 0 00-2 2z" strokeWidth="2" strokeLinecap="round"/>
                                    <path d="M16 18v2a2 2 0 01-2 2H6a2 2 0 01-2-2V9a2 2 0 012-2h2" strokeWidth="2" strokeLinecap="round"/>
                                </svg>
                            </button>
                            <button
                                className="result-button"
                                onClick={() => onUpdate(prompt.id, { result: '' })}
                                title="Clear result"
                            >
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M19 7l-7 7m0 0l-7-7m7 7V4" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                                </svg>
                            </button>
                        </div>

                        {/* Replace textarea with rich text display */}
                        <div 
                            className="result-content"
                            dangerouslySetInnerHTML={renderFormattedResult()}
                            style={{
                                minHeight: '250px',
                                maxHeight: '500px',
                                overflowY: 'auto',
                                padding: '0.75rem',
                                border: '1px solid var(--border-color)',
                                borderRadius: '4px',
                                background: 'var(--primary-bg)',
                                color: 'var(--text-primary)',
                                lineHeight: '1.5'
                            }}
                        />
                        
                        {enhanceStatus && (
                            <div className={`enhance-status ${enhanceStatus.includes('Error') ? 'error' : ''}`}>
                                {enhanceStatus}
                            </div>
                        )}
                    </div>
            
                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                            <button
                            onClick={() => onRun(prompt.id)} 
                            className="btn btn-success"
                            disabled={loading || (isImageMode && !prompt.selectedImage)}
                        >
                            {loading ? (
                                <span className="loading-spinner" />
                            ) : (
                                isImageMode ? 'Analyze Image' : 'Run'
                            )}
                        </button>
                        <button 
                            onClick={() => onDelete(prompt.id)}
                            className="btn btn-danger"
                        >
                            Delete
                        </button>
                    </div>
                </div>
            );
        };

        const ImageTray = ({ uploadedImages, onDeleteImage }) => (
            <div className="image-tray">
                <div className="image-tray-title">Uploaded Images</div>
                <div className="image-preview-list">
                    {uploadedImages.map(image => (
                        <div key={image.id} className="image-preview-item">
                            <img src={image.url} alt={image.name} />
                            <button 
                                className="delete-button"
                                onClick={() => onDeleteImage(image.id)}
                            >
                                ×
                            </button>
                        </div>
                    ))}
                </div>
            </div>
        );

        const DocumentTray = ({ uploadedDocuments, onDeleteDocument, onSelectDocument }) => {
            const [expandedDoc, setExpandedDoc] = React.useState(null);

            return (
                <div className="document-tray">
                    <div className="document-tray-title">Uploaded Texts</div>
                    <div className="document-preview-list">
                        {uploadedDocuments.map(doc => (
                            <div key={doc.id} className="document-preview-item">
                                <div className="document-preview-content">
                                    <span className="document-icon">📄</span>
                                    <span className="document-name" onClick={() => onSelectDocument(doc.content)}>
                                        {doc.name}
                                    </span>
                                </div>
                                <div className="document-actions">
                                    <button 
                                        className="preview-button"
                                        onClick={() => setExpandedDoc(expandedDoc === doc.id ? null : doc.id)}
                                    >
                                        {expandedDoc === doc.id ? 'Hide' : 'Preview'}
                                    </button>
                                    <button 
                                        className="use-button"
                                        onClick={() => onSelectDocument(doc.content)}
                                    >
                                        Use
                                    </button>
                                    <button 
                                        className="delete-button"
                                        onClick={() => onDeleteDocument(doc.id)}
                                    >
                                        ×
                                    </button>
                                </div>
                                {expandedDoc === doc.id && (
                                    <div className="document-content">
                                        <textarea
                                            readOnly
                                            value={doc.content}
                                            className="document-content-preview"
                                        />
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Update the SCENARIOS constant with new groups and small business scenarios
        const SCENARIOS = [
            {
                id: 'empty',
                emoji: '✨',
                name: 'Empty Scenario Card',
                scenario: {
                    name: '',
                    contextDescription: '',
                    challenges: '',
                    opportunities: ''
                }
            },
            // Small Business Group
            {
                id: 'retail-expansion',
                emoji: '🏪',
                name: 'Retail Store Expansion',
                scenario: {
                    name: 'Local Retail Growth Strategy',
                    contextDescription: 'Successful local retail store with 5 years of operation, $1.2M annual revenue, looking to expand to second location. Current store has loyal customer base and strong community presence.',
                    challenges: 'Limited capital resources, finding right location, maintaining quality across locations, staff recruitment and training, inventory management across stores, preserving brand identity and customer experience.',
                    opportunities: 'Market expansion, economies of scale, increased brand recognition, cross-location customer flow, enhanced purchasing power, operational efficiency improvements.'
                }
            },
            {
                id: 'restaurant-digital',
                emoji: '🍽️',
                name: 'Restaurant Digital Transformation',
                scenario: {
                    name: 'Restaurant Tech Modernization',
                    contextDescription: 'Family-owned restaurant with 15-year history, transitioning to digital operations. Currently uses basic POS system and paper-based processes. 50 seats, $800K annual revenue.',
                    challenges: 'Staff technology adoption, customer acceptance of new systems, integration costs, maintaining personal touch, training requirements, data management compliance.',
                    opportunities: 'Improved efficiency, better customer data insights, online ordering revenue, reduced errors, enhanced customer experience, competitive advantage.'
                }
            },
            {
                id: 'service-scaling',
                emoji: '🔧',
                name: 'Service Business Scaling',
                scenario: {
                    name: 'Professional Services Growth',
                    contextDescription: 'Professional services firm (accounting/consulting) with 3 partners, 12 staff, $1.5M revenue. Looking to scale operations while maintaining quality and client relationships.',
                    challenges: 'Quality control at scale, knowledge transfer, client relationship management, process standardization, team expansion, technology infrastructure needs.',
                    opportunities: 'Market share growth, service diversification, improved profitability, enhanced client services, talent attraction, operational excellence.'
                }
            },
            {
                id: 'ecommerce-launch',
                emoji: '🛍️',
                name: 'E-commerce Launch',
                scenario: {
                    name: 'Traditional to Online Retail',
                    contextDescription: 'Traditional brick-and-mortar gift shop launching e-commerce platform. 10-year established business, $500K annual revenue, strong local reputation, unique product selection.',
                    challenges: 'Online competition, shipping logistics, inventory synchronization, digital marketing expertise, customer service scaling, technology platform selection.',
                    opportunities: 'Geographic market expansion, 24/7 sales potential, reduced overhead, data-driven insights, personalized marketing, automated operations.'
                }
            },
            {
                id: 'wellness-hybrid',
                emoji: '🧘',
                name: 'Wellness Center Hybrid',
                scenario: {
                    name: 'Hybrid Wellness Services',
                    contextDescription: 'Local wellness center transitioning to hybrid service model. Currently offers in-person yoga, fitness, and wellness services. 300 active members, $400K annual revenue.',
                    challenges: 'Technology infrastructure needs, maintaining community feel, pricing strategy, content creation, instructor training, service quality consistency.',
                    opportunities: 'Expanded client reach, new revenue streams, reduced facility constraints, enhanced client convenience, service personalization, data-driven programming.'
                }
            },
            // Enterprise Transformation Group
            {
                id: 'digital-transformation',
                emoji: '🚀',
                name: 'Digital Transformation',
                scenario: {
                    name: 'Enterprise Digital Transformation',
                    contextDescription: 'Fortune 500 manufacturing company transitioning to Industry 4.0. Current infrastructure is legacy-based with minimal digital integration. 5,000+ employees across global facilities.',
                    challenges: 'Legacy system dependencies, workforce digital literacy gaps, cybersecurity vulnerabilities, production downtime risks, union concerns about automation, data silos between departments.',
                    opportunities: 'Predictive maintenance savings, real-time production insights, improved supply chain visibility, enhanced quality control, reduced operational costs, competitive advantage in market.'
                }
            },
            {
                id: 'customer-experience',
                emoji: '🎯',
                name: 'Customer Experience',
                scenario: {
                    name: 'Omnichannel CX Enhancement',
                    contextDescription: 'Global retail chain with 500+ locations modernizing customer experience. Currently operates siloed online and physical channels with inconsistent customer journey touchpoints.',
                    challenges: 'Fragmented customer data, inconsistent brand experience, legacy POS systems, staff training needs, real-time inventory sync issues, personalization limitations.',
                    opportunities: 'Unified customer profiles, seamless cross-channel experiences, increased customer loyalty, data-driven personalization, improved inventory management, higher customer satisfaction.'
                }
            },
            {
                id: 'sustainability',
                emoji: '🌱',
                name: 'Sustainability Initiative',
                scenario: {
                    name: 'Green Supply Chain Transformation',
                    contextDescription: 'International consumer goods company implementing sustainable practices. Current operations have high carbon footprint with traditional packaging and logistics methods.',
                    challenges: 'Higher sustainable material costs, complex supplier transitions, maintaining product quality, measuring environmental impact, consumer price sensitivity, regulatory compliance.',
                    opportunities: 'Reduced carbon footprint, brand reputation enhancement, access to green markets, regulatory compliance advantage, reduced packaging costs, increased market share.'
                }
            },
            {
                id: 'ai-integration',
                emoji: '🤖',
                name: 'AI Integration',
                scenario: {
                    name: 'Healthcare AI Implementation',
                    contextDescription: 'Leading healthcare provider integrating AI across diagnostic and administrative systems. Currently operates traditional manual processes with growing patient wait times.',
                    challenges: 'Data privacy compliance, integration with existing systems, staff resistance to change, accuracy validation, patient trust concerns, high implementation costs.',
                    opportunities: 'Improved diagnostic accuracy, reduced wait times, optimized resource allocation, enhanced patient outcomes, reduced operational costs, competitive market position.'
                }
            },
            {
                id: 'market-expansion',
                emoji: '🌐',
                name: 'Market Expansion',
                scenario: {
                    name: 'APAC Market Entry Strategy',
                    contextDescription: 'European B2B SaaS company expanding into APAC markets. Currently successful in EU/US markets with enterprise security software solutions.',
                    challenges: 'Cultural adaptation needs, local regulatory compliance, established regional competitors, language barriers, different security standards, pricing model adjustments.',
                    opportunities: 'Large untapped market potential, first-mover advantage in specific regions, strategic local partnerships, product localization value, regional tech hub presence.'
                }
            }
        ];

        // React Components
        const ScenarioCard = ({ scenario, onUpdate, onDelete }) => {
            const updateField = (field, value) => {
                const updatedScenario = {
                    ...scenario,
                    scenario: {
                        ...scenario.scenario,
                        [field]: value
                    }
                };
                onUpdate(scenario.cardId, updatedScenario);
            };

            return (
                <div className="scenario-card">
                    <div className="scenario-header">
                        <span className="scenario-emoji">🎯</span>
                        <span className="scenario-title">SCENARIO CARD</span>
                    </div>

                    <div className="scenario-field">
                        <div className="scenario-field-label">Name</div>
                        <textarea
                            className="scenario-textarea"
                            value={scenario.scenario?.name || ''}
                            onChange={(e) => updateField('name', e.target.value)}
                            placeholder="Enter scenario name..."
                        />
                    </div>

                    <div className="scenario-field">
                        <div className="scenario-field-label">Context & Description</div>
                        <textarea
                            className="scenario-textarea"
                            value={scenario.scenario?.contextDescription || ''}
                            onChange={(e) => updateField('contextDescription', e.target.value)}
                            placeholder="Describe the context and background..."
                        />
                    </div>

                    <div className="scenario-field">
                        <div className="scenario-field-label">Challenges</div>
                        <textarea
                            className="scenario-textarea"
                            value={scenario.scenario?.challenges || ''}
                            onChange={(e) => updateField('challenges', e.target.value)}
                            placeholder="List key challenges..."
                        />
                    </div>

                    <div className="scenario-field">
                        <div className="scenario-field-label">Opportunities</div>
                        <textarea
                            className="scenario-textarea"
                            value={scenario.scenario?.opportunities || ''}
                            onChange={(e) => updateField('opportunities', e.target.value)}
                            placeholder="List potential opportunities..."
                        />
                    </div>

                    <button 
                        onClick={() => onDelete(scenario.cardId)}
                        className="btn btn-danger"
                    >
                        Delete
                    </button>
                </div>
            );
        };

        const ScenarioTray = ({ onAddScenario }) => {
            const [selectedScenario, setSelectedScenario] = React.useState('');

            const handleAddScenario = () => {
                if (selectedScenario) {
                    const baseScenario = SCENARIOS.find(s => s.id === selectedScenario);
                    const newScenario = {
                        ...baseScenario,
                        cardId: Date.now(),
                        scenario: { ...baseScenario.scenario },
                    };
                    onAddScenario(newScenario);
                    setSelectedScenario('');
                }
            };

            return (
                <div className="scenario-tray">
                    <div className="scenario-selector-container">
                        <select 
                            value={selectedScenario}
                            onChange={(e) => setSelectedScenario(e.target.value)}
                            className="scenario-selector"
                            style={{ width: "200px" }}
                        >
                            <option value="">🎯 Select Scenario...</option>
                            <option value="empty">✨ Empty Scenario Card</option>
                            <optgroup label="Small Business">
                                {SCENARIOS.slice(1, 6).map(scenario => (
                                    <option key={scenario.id} value={scenario.id}>
                                        {scenario.emoji} {scenario.name}
                                    </option>
                                ))}
                            </optgroup>
                            <optgroup label="Enterprise Transformation">
                                {SCENARIOS.slice(6).map(scenario => (
                                    <option key={scenario.id} value={scenario.id}>
                                        {scenario.emoji} {scenario.name}
                                    </option>
                                ))}
                            </optgroup>
                        </select>
                        <button 
                            onClick={handleAddScenario}
                            className="add-persona-btn"
                            disabled={!selectedScenario}
                        >
                            +
                        </button>
                    </div>
                </div>
            );
        };

        // Add this constant near the other constants at the top of the script
        const EXPERT_PROMPTS = [
            {
                id: 'concept-architect',
                name: 'The Concept Architect',
                emoji: '🏛️',
                text: 'As a visionary innovator who sees potential connections and applications that others miss, analyze this through Pattern Layer (mapping recurring elements), Recombination Layer (creating novel combinations), and Evolution Layer (projecting evolution). Use vivid analogies and create conceptual prototypes to test ideas.'
            },
            {
                id: 'narrative-synthesist',
                name: 'The Narrative Synthesist',
                emoji: '📚',
                text: 'As a master of finding and crafting stories that make complex information compelling, analyze this through Story Structure (mapping narrative elements), Information Architecture (creating multi-layered experiences), and Meaning-Making (surfacing implicit assumptions). Create nested narratives that reward deeper exploration.'
            },
            {
                id: 'system-cartographer',
                name: 'The System Cartographer',
                emoji: '🗺️',
                text: 'As an explorer of complex systems, analyze this through Topology (mapping structures), Dynamics (tracking feedback loops), and Evolution (projecting trajectories). Use visual metaphors to make complex systems graspable and highlight counterintuitive relationships.'
            },
            {
                id: 'integration-architect',
                name: 'The Integration Architect',
                emoji: '🔄',
                text: 'As a master of synthesis, analyze this through Boundary (mapping interface points), Synthesis (creating unifying frameworks), and Emergence (projecting integration outcomes). Create clear frameworks showing how pieces fit together and highlight unique value created through combination.'
            },
            {
                id: 'future-cartographer',
                name: 'The Future Cartographer',
                emoji: '🔮',
                text: 'As an explorer of possible futures, analyze this through Signal (identifying emerging changes), Scenario (mapping decision spaces), and Implication (tracking consequences). Create vivid but plausible future scenarios and highlight present-day implications.'
            },
            {
                id: 'collaborative-catalyst',
                name: 'The Collaborative Catalyst',
                emoji: '🤝',
                text: 'As a master of group dynamics, analyze this through Group Dynamics (mapping interactions), Process Architecture (designing frameworks), and Knowledge Flow (tracking learning). Use inclusive language and highlight collective insights.'
            },
            {
                id: 'strategy-weaver',
                name: 'The Strategy Weaver',
                emoji: '🎯',
                text: 'As a strategic thinker, analyze this through Environmental (mapping external dynamics), Capability (assessing internal strengths), and Implementation (creating execution plans). Use strategic frameworks and highlight key decision points.'
            },
            {
                id: 'knowledge-architect',
                name: 'The Knowledge Architect',
                emoji: '📚',
                text: 'As a curator and connector of knowledge, analyze this through Content (mapping domains), Structure (designing systems), and Evolution (tracking growth). Use clear taxonomies and create multiple entry points for different users.'
            },
            {
                id: 'process-optimizer',
                name: 'The Process Optimizer',
                emoji: '⚙️',
                text: 'As an efficiency expert, analyze this through Efficiency (mapping flows), Quality (assessing consistency), and Innovation (identifying improvements). Use clear process visualizations and highlight both quick wins and strategic improvements.'
            },
            {
                id: 'solution-architect',
                name: 'The Solution Architect',
                emoji: '🔧',
                text: 'As a master problem solver, analyze this through Problem (mapping root causes), Design (creating frameworks), and Implementation (planning deployment). Use clear problem-solution mapping and highlight key decision points.'
            }
        ];

        // Update the PROMPT_TEMPLATES constant to include both basic and expert prompts
        const PROMPT_TEMPLATES = [
            {
                id: 'empty',
                name: 'Empty Prompt Card',
                emoji: '✨',
                text: ''
            },
            {
                id: 'comprehensive-analysis',
                name: 'Comprehensive Analysis',
                emoji: '🔍',
                text: 'Please provide a comprehensive analysis of the content, including:\n\n1. Executive Summary\n- Key findings and insights\n- Critical implications\n- Recommended actions\n\n2. Content Analysis\n- Main themes and concepts\n- Key arguments and positions\n- Supporting evidence quality\n- Gaps or limitations\n\n3. Context Integration\n- Industry/market relevance\n- Historical context\n- Current trends alignment\n- Future implications\n\n4. Stakeholder Impact\n- Primary stakeholder considerations\n- Potential benefits and risks\n- Implementation challenges\n- Success metrics\n\n5. Strategic Recommendations\n- Short-term actions\n- Long-term strategies\n- Resource requirements\n- Risk mitigation approaches'
            },
            {
                id: 'data-insights',
                name: 'Data & Metrics Analysis',
                emoji: '📊',
                text: 'Analyze the data and metrics presented in the content:\n\n1. Key Metrics Review\n- Identify and explain critical metrics\n- Analyze trends and patterns\n- Compare against industry standards\n- Highlight anomalies or concerns\n\n2. Performance Analysis\n- Success indicators\n- Areas for improvement\n- Bottlenecks and constraints\n- Optimization opportunities\n\n3. Predictive Insights\n- Future trend projections\n- Potential scenarios\n- Risk factors\n- Growth opportunities\n\n4. Actionable Recommendations\n- Data-driven decisions\n- Measurement improvements\n- Monitoring strategies\n- Success metrics'
            },
            {
                id: 'strategic-planning',
                name: 'Strategic Planning',
                emoji: '🎯',
                text: 'Develop a strategic analysis and planning framework:\n\n1. Situation Analysis\n- Current state assessment\n- Market position\n- Competitive landscape\n- Core capabilities\n\n2. Strategic Options\n- Potential directions\n- Growth opportunities\n- Innovation possibilities\n- Partnership potential\n\n3. Implementation Framework\n- Key initiatives\n- Resource requirements\n- Timeline considerations\n- Success metrics\n\n4. Risk Assessment\n- Potential obstacles\n- Mitigation strategies\n- Contingency plans\n- Monitoring approach'
            },
            {
                id: 'innovation-opportunities',
                name: 'Innovation Opportunities',
                emoji: '💡',
                text: 'Identify and analyze innovation opportunities:\n\n1. Innovation Landscape\n- Current trends\n- Emerging technologies\n- Market gaps\n- Customer needs\n\n2. Opportunity Analysis\n- Potential solutions\n- Value proposition\n- Market fit\n- Implementation feasibility\n\n3. Development Framework\n- Resource requirements\n- Timeline considerations\n- Technical requirements\n- Success criteria\n\n4. Risk and Impact\n- Implementation challenges\n- Market adoption factors\n- Competition response\n- Success metrics'
            },
            {
                id: 'market-analysis',
                name: 'Market Analysis',
                emoji: '🌐',
                text: 'Conduct a comprehensive market analysis:\n\n1. Market Overview\n- Size and growth\n- Key segments\n- Trends and drivers\n- Regulatory factors\n\n2. Competitive Analysis\n- Key players\n- Market shares\n- Competitive advantages\n- Strategic positions\n\n3. Customer Analysis\n- Needs and preferences\n- Behavior patterns\n- Decision factors\n- Value perceptions\n\n4. Opportunity Assessment\n- Market gaps\n- Growth potential\n- Entry barriers\n- Success factors'
            },
            ...EXPERT_PROMPTS
        ];

        // Add the CURIOSITY_AGENCY prompts as a separate constant
        const CURIOSITY_AGENCY = [
            {
                id: 'concept-architect',
                name: 'The Concept Architect',
                emoji: '🏛️',
                text: 'As a visionary innovator who sees potential connections and applications that others miss, analyze this through Pattern Layer (mapping recurring elements), Recombination Layer (creating novel combinations), and Evolution Layer (projecting evolution). Use vivid analogies and create conceptual prototypes to test ideas.'
            },
            {
                id: 'narrative-synthesist',
                name: 'The Narrative Synthesist',
                emoji: '📚',
                text: 'As a master of finding and crafting stories that make complex information compelling, analyze this through Story Structure (mapping narrative elements), Information Architecture (creating multi-layered experiences), and Meaning-Making (surfacing implicit assumptions). Create nested narratives that reward deeper exploration.'
            },
            {
                id: 'system-cartographer',
                name: 'The System Cartographer',
                emoji: '🗺️',
                text: 'As an explorer of complex systems, analyze this through Topology (mapping structures), Dynamics (tracking feedback loops), and Evolution (projecting trajectories). Use visual metaphors to make complex systems graspable and highlight counterintuitive relationships.'
            },
            {
                id: 'integration-architect',
                name: 'The Integration Architect',
                emoji: '🔄',
                text: 'As a master of synthesis, analyze this through Boundary (mapping interface points), Synthesis (creating unifying frameworks), and Emergence (projecting integration outcomes). Create clear frameworks showing how pieces fit together and highlight unique value created through combination.'
            },
            {
                id: 'future-cartographer',
                name: 'The Future Cartographer',
                emoji: '🔮',
                text: 'As an explorer of possible futures, analyze this through Signal (identifying emerging changes), Scenario (mapping decision spaces), and Implication (tracking consequences). Create vivid but plausible future scenarios and highlight present-day implications.'
            },
            {
                id: 'collaborative-catalyst',
                name: 'The Collaborative Catalyst',
                emoji: '🤝',
                text: 'As a master of group dynamics, analyze this through Group Dynamics (mapping interactions), Process Architecture (designing frameworks), and Knowledge Flow (tracking learning). Use inclusive language and highlight collective insights.'
            },
            {
                id: 'strategy-weaver',
                name: 'The Strategy Weaver',
                emoji: '🎯',
                text: 'As a strategic thinker, analyze this through Environmental (mapping external dynamics), Capability (assessing internal strengths), and Implementation (creating execution plans). Use strategic frameworks and highlight key decision points.'
            },
            {
                id: 'knowledge-architect',
                name: 'The Knowledge Architect',
                emoji: '📚',
                text: 'As a curator and connector of knowledge, analyze this through Content (mapping domains), Structure (designing systems), and Evolution (tracking growth). Use clear taxonomies and create multiple entry points for different users.'
            },
            {
                id: 'process-optimizer',
                name: 'The Process Optimizer',
                emoji: '⚙️',
                text: 'As an efficiency expert, analyze this through Efficiency (mapping flows), Quality (assessing consistency), and Innovation (identifying improvements). Use clear process visualizations and highlight both quick wins and strategic improvements.'
            },
            {
                id: 'solution-architect',
                name: 'The Solution Architect',
                emoji: '🔧',
                text: 'As a master problem solver, analyze this through Problem (mapping root causes), Design (creating frameworks), and Implementation (planning deployment). Use clear problem-solution mapping and highlight key decision points.'
            }
        ];

        // Add the PromptTray component
        const PromptTray = ({ onAddPrompt }) => {
            const [selectedTemplate, setSelectedTemplate] = React.useState('');

            const handleAddPrompt = () => {
                if (selectedTemplate) {
                    const template = [...PROMPT_TEMPLATES, ...CURIOSITY_AGENCY].find(t => t.id === selectedTemplate);
                    if (template) {
                        onAddPrompt({
                            id: Date.now(),
                            title: template.name,
                            text: template.text,
                            result: '',
                            source: 'SOURCE',
                            sources: ['SOURCE'],
                            sourceType: 'text',
                            selectedImage: null,
                            selectedPersonas: []
                        });
                        setSelectedTemplate('');
                    }
                }
            };

            return (
                <div className="persona-tray">
                    <div className="persona-selector-container">
                        <select 
                            value={selectedTemplate}
                            onChange={(e) => setSelectedTemplate(e.target.value)}
                            className="persona-selector"
                        >
                            <option value="">✨ Select Agent... </option>
                            <optgroup label="Basic Prompts">
                                {PROMPT_TEMPLATES.map(template => (
                                    <option key={template.id} value={template.id}>
                                        {template.emoji} {template.name}
                                    </option>
                                ))}
                            </optgroup>
                            <optgroup label="Curiosity Agency">
                                {CURIOSITY_AGENCY.map(template => (
                                    <option key={template.id} value={template.id}>
                                        {template.emoji} {template.name}
                                    </option>
                                ))}
                            </optgroup>
                        </select>
                        <button 
                            onClick={handleAddPrompt}
                            className="add-persona-btn"
                            disabled={!selectedTemplate}
                        >
                            +
                        </button>
                    </div>
                </div>
            );
        };

        // Add these constants near the top of your script
        const LOCAL_STORAGE_KEYS = {
            API_KEY: 'worksona_api_key',
            MODEL: 'worksona_model'
        };

        // Add the Chat component before the App component
        const Chat = ({ llmConfig, isOpen, onClose, prompts, sourceContent }) => {
            const [messages, setMessages] = React.useState([]);
            const [inputValue, setInputValue] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false);
            const [selectedSources, setSelectedSources] = React.useState([]);
            const [currentSelection, setCurrentSelection] = React.useState('');
            const [includeChatHistory, setIncludeChatHistory] = React.useState(true);
            const messagesEndRef = React.useRef(null);

            // Create source options list with separator
            const sourceOptions = [
                { id: 'source', label: 'Source Content', content: sourceContent },
                { id: 'separator', label: '──────────', disabled: true },
                ...prompts.map(prompt => ({
                    id: `result-${prompt.id}`,
                    label: `Result: ${prompt.title || `Prompt ${prompt.id}`}`,
                    content: prompt.result
                }))
            ];

            const addSelectedSource = () => {
                if (!currentSelection) return;
                const source = sourceOptions.find(opt => opt.id === currentSelection);
                if (source && !selectedSources.find(s => s.id === source.id)) {
                    setSelectedSources([...selectedSources, source]);
                }
                setCurrentSelection('');
            };

            const removeSource = (sourceId) => {
                setSelectedSources(selectedSources.filter(s => s.id !== sourceId));
            };

            // Update handleSubmit to include selected sources
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!inputValue.trim() || isLoading) return;

                // Validate API key
                if (!llmConfig.openaiKey) {
                    setMessages(prev => [...prev, { 
                        role: 'assistant', 
                        content: 'Error: Please enter an OpenAI API key in settings' 
                    }]);
                    return;
                }

                const userMessage = inputValue.trim();
                setInputValue('');
                
                // Combine selected sources into context
                const contextContent = selectedSources
                    .map(source => `${source.label}:\n${source.content}`)
                    .join('\n\n');
                
                setMessages(prev => [...prev, { role: 'user', content: userMessage }]);
                setIsLoading(true);

                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${llmConfig.openaiKey.trim()}`
                        },
                        body: JSON.stringify({
                            model: llmConfig.model || "gpt-4-turbo-preview",
                            messages: [
                                { 
                                    role: "system", 
                                    content: contextContent ? 
                                        `Consider this context:\n\n${contextContent}\n\nRespond as a helpful assistant.` : 
                                        "You are a helpful assistant."
                                },
                                // Only include message history if toggle is on
                                ...(includeChatHistory ? messages : []),
                                { role: "user", content: userMessage }
                            ]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }

                    const data = await response.json();
                    const assistantMessage = data.choices[0].message.content;

                    setMessages(prev => [...prev, { role: 'assistant', content: assistantMessage }]);
                } catch (error) {
                    console.error('Chat error:', error);
                    setMessages(prev => [...prev, { 
                        role: 'assistant', 
                        content: `Error: ${error.message}. Please check your API key and try again.` 
                    }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const copyMessages = () => {
                const messageText = messages
                    .map(msg => `${msg.role}: ${msg.content}`)
                    .join('\n\n');
                navigator.clipboard.writeText(messageText);
            };

            const clearMessages = () => {
                setMessages([]);
            };

            // Add state for expanded chat window
            const [isExpanded, setIsExpanded] = React.useState(false);

            if (!isOpen) return null;

            return (
                <div className="chat-window" style={{
                    position: 'fixed',
                    bottom: '5rem',
                    right: '2rem',
                    width: isExpanded ? '80vw' : '400px',
                    height: isExpanded ? '80vh' : '400px',
                    background: 'var(--secondary-bg)',
                    border: '1px solid var(--border-color)',
                    borderRadius: '8px',
                    zIndex: 1000000,
                    display: 'flex',
                    flexDirection: 'column',
                    boxShadow: '0 4px 12px rgba(0, 0, 0, 0.15)',
                    transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)'
                }}>
                    <div className="chat-titlebar" style={{
                        padding: '0.75rem 1rem',
                        borderBottom: '1px solid var(--border-color)',
                        display: 'flex',
                        flexDirection: 'column',
                        gap: '0.5rem',
                        background: 'var(--primary-bg)'
                    }}>
                        <div style={{ 
                            display: 'flex', 
                            justifyContent: 'space-between', 
                            alignItems: 'center',
                            gap: '1rem'
                        }}>
                            <div className="chat-title" style={{ 
                                fontWeight: '500', 
                                color: 'var(--text-primary)',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '1rem'
                            }}>
                                <span>Chat Assistant</span>
                                <div style={{ 
                                    display: 'flex', 
                                    alignItems: 'center',
                                    gap: '0.5rem',
                                    fontSize: '0.8rem'
                                }}>
                                    <span style={{ color: 'var(--text-secondary)' }}>History</span>
                                    <label className="toggle-switch">
                                        <input
                                            type="checkbox"
                                            checked={includeChatHistory}
                                            onChange={(e) => setIncludeChatHistory(e.target.checked)}
                                        />
                                        <span className="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div style={{ display: 'flex', gap: '0.5rem' }}>
                                <button
                                    onClick={copyMessages}
                                    className="chat-titlebar-button"
                                    title="Copy Chat"
                                    style={{
                                        background: 'none',
                                        border: 'none',
                                        color: 'var(--accent-color)', // Changed to accent color
                                        cursor: 'pointer',
                                        padding: '0.5rem',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        transition: 'opacity 0.2s ease',
                                        opacity: '0.8',
                                        hover: {
                                            opacity: '1'
                                        }
                                    }}
                                >
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="16" height="16">
                                        <path d="M8 4v12a2 2 0 002 2h8a2 2 0 002-2V7.242a2 2 0 00-.602-1.43L16.083 2.57A2 2 0 0014.685 2H10a2 2 0 00-2 2z" strokeWidth="2"/>
                                        <path d="M16 18v2a2 2 0 01-2 2H6a2 2 0 01-2-2V9a2 2 0 012-2h2" strokeWidth="2"/>
                                    </svg>
                                </button>
                                <button
                                    onClick={clearMessages}
                                    className="chat-titlebar-button"
                                    title="Clear Chat"
                                    style={{
                                        background: 'none',
                                        border: 'none',
                                        color: 'var(--accent-color)', // Changed to accent color
                                        cursor: 'pointer',
                                        padding: '0.5rem',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        transition: 'opacity 0.2s ease',
                                        opacity: '0.8',
                                        hover: {
                                            opacity: '1'
                                        }
                                    }}
                                >
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="16" height="16">
                                        <path d="M19 7l-7 7m0 0l-7-7m7 7V4" strokeWidth="2"/>
                                    </svg>
                                </button>
                                <button
                                    onClick={() => setIsExpanded(!isExpanded)}
                                    className="chat-titlebar-button"
                                    title={isExpanded ? "Collapse" : "Expand"}
                                    style={{
                                        background: 'none',
                                        border: 'none',
                                        color: 'var(--accent-color)', // Changed to accent color
                                        cursor: 'pointer',
                                        padding: '0.5rem',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        transition: 'opacity 0.2s ease',
                                        opacity: '0.8',
                                        hover: {
                                            opacity: '1'
                                        }
                                    }}
                                >
                                    <svg 
                                        viewBox="0 0 24 24" 
                                        fill="none" 
                                        stroke="currentColor" 
                                        width="16" 
                                        height="16"
                                        style={{
                                            transform: isExpanded ? 'rotate(180deg)' : 'none',
                                            transition: 'transform 0.3s ease'
                                        }}
                                    >
                                        {isExpanded ? (
                                            <path 
                                                d="M8 3v3a2 2 0 01-2 2H3m18 0h-3a2 2 0 01-2-2V3m0 18v-3a2 2 0 012-2h3M3 16h3a2 2 0 012 2v3" 
                                                strokeWidth="2" 
                                                strokeLinecap="round" 
                                                strokeLinejoin="round"
                                            />
                                        ) : (
                                            <path 
                                                d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" 
                                                strokeWidth="2" 
                                                strokeLinecap="round" 
                                                strokeLinejoin="round"
                                            />
                                        )}
                                    </svg>
                                </button>
                                <button
                                    onClick={onClose}
                                    className="chat-titlebar-button"
                                    title="Close Chat"
                                    style={{
                                        background: 'none',
                                        border: 'none',
                                        color: 'var(--accent-color)', // Changed to accent color
                                        cursor: 'pointer',
                                        padding: '0.5rem',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        transition: 'opacity 0.2s ease',
                                        opacity: '0.8',
                                        hover: {
                                            opacity: '1'
                                        }
                                    }}
                                >
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="16" height="16">
                                        <path d="M18 6L6 18M6 6l12 12" strokeWidth="2" strokeLinecap="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        {/* Source selector */}
                        <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                            <select
                                value={currentSelection}
                                onChange={(e) => setCurrentSelection(e.target.value)}
                                style={{
                                    flex: 1,
                                    padding: '0.4rem',
                                    background: 'var(--primary-bg)',
                                    border: '1px solid var(--border-color)',
                                    color: 'var(--text-primary)',
                                    borderRadius: '4px'
                                }}
                            >
                                <option value="">Select source or result...</option>
                                {sourceOptions.map(opt => (
                                    <option 
                                        key={opt.id} 
                                        value={opt.id}
                                        disabled={opt.disabled}
                                    >
                                        {opt.label}
                                    </option>
                                ))}
                            </select>
                            <button
                                onClick={addSelectedSource}
                                disabled={!currentSelection}
                                style={{
                                    padding: '0.4rem',
                                    background: 'var(--accent-color)',
                                    border: 'none',
                                    borderRadius: '4px',
                                    color: 'white',
                                    cursor: currentSelection ? 'pointer' : 'not-allowed',
                                    opacity: currentSelection ? 1 : 0.5
                                }}
                            >
                                +
                            </button>
                        </div>

                        {/* Selected sources tags */}
                        {selectedSources.length > 0 && (
                            <div style={{ 
                                display: 'flex', 
                                flexWrap: 'wrap', 
                                gap: '0.4rem',
                                padding: '0.4rem 0'
                            }}>
                                {selectedSources.map(source => (
                                    <div
                                        key={source.id}
                                        style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '0.4rem',
                                            padding: '0.2rem 0.4rem',
                                            background: 'var(--secondary-bg)',
                                            border: '1px solid var(--border-color)',
                                            borderRadius: '4px',
                                            fontSize: '0.8rem'
                                        }}
                                    >
                                        <span style={{ color: 'var(--text-primary)' }}>{source.label}</span>
                                        <button
                                            onClick={() => removeSource(source.id)}
                                            style={{
                                                background: 'none',
                                                border: 'none',
                                                color: 'var(--text-primary)',
                                                cursor: 'pointer',
                                                padding: '0 0.2rem'
                                            }}
                                        >
                                            ×
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    
                    <div className="chat-messages" style={{
                        flex: 1,
                        overflowY: 'auto',
                        padding: '1rem',
                        display: 'flex',
                        flexDirection: 'column',
                        gap: '0.75rem'
                    }}>
                        {messages.map((message, index) => (
                            <div 
                                key={index} 
                                className={`chat-message ${message.role}`}
                                style={{
                                    maxWidth: '80%',
                                    padding: '0.75rem',
                                    borderRadius: '8px',
                                    alignSelf: message.role === 'user' ? 'flex-end' : 'flex-start',
                                    background: message.role === 'user' ? 'var(--accent-color)' : 'var(--primary-bg)',
                                    color: message.role === 'user' ? 'white' : 'var(--text-primary)'
                                }}
                            >
                                {message.content}
                            </div>
                        ))}
                        {isLoading && (
                            <div className="chat-message assistant" style={{
                                maxWidth: '80%',
                                padding: '0.75rem',
                                borderRadius: '8px',
                                alignSelf: 'flex-start',
                                background: 'var(--primary-bg)',
                                color: 'var(--text-primary)'
                            }}>
                                Thinking...
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    <form 
                        onSubmit={handleSubmit}
                        style={{
                            padding: '0.75rem',
                            borderTop: '1px solid var(--border-color)',
                            display: 'flex',
                            gap: '0.5rem'
                        }}
                    >
                        <textarea 
                            value={inputValue}
                            onChange={(e) => setInputValue(e.target.value)}
                            placeholder="Type your message..."
                            style={{
                                flex: 1,
                                padding: '0.75rem',
                                border: '1px solid var(--border-color)',
                                borderRadius: '4px',
                                background: 'var(--primary-bg)',
                                color: 'var(--text-primary)',
                                resize: 'none',
                                height: '40px',
                                lineHeight: '20px'
                            }}
                            onKeyDown={(e) => {
                                if (e.key === 'Enter' && !e.shiftKey) {
                                    e.preventDefault();
                                    handleSubmit(e);
                                }
                            }}
                        />
                        <button 
                            type="submit"
                            disabled={isLoading}
                            style={{
                                padding: '0.5rem 1rem',
                                background: 'var(--accent-color)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '4px',
                                cursor: isLoading ? 'not-allowed' : 'pointer',
                                opacity: isLoading ? 0.7 : 1
                            }}
                        >
                            Send
                        </button>
                    </form>
                </div>
            );
        };

        // Main App Component
        function App() {
            // Update the API key state and storage handling
            const [apiKey, setApiKey] = React.useState(() => {
                // Try to get the key from localStorage first
                const storedKey = localStorage.getItem(LOCAL_STORAGE_KEYS.API_KEY);
                return storedKey || '';
            });

            // Update the API key handler to ensure proper storage
            const handleApiKeyChange = (e) => {
                const newKey = e.target.value.trim();
                setApiKey(newKey);
                localStorage.setItem(LOCAL_STORAGE_KEYS.API_KEY, newKey);
            };

            const [model, setModel] = React.useState(() => {
                return localStorage.getItem(LOCAL_STORAGE_KEYS.MODEL) || OPENAI_MODELS[0];
            });

            // Update the model handler
            const handleModelChange = (e) => {
                const newModel = e.target.value;
                setModel(newModel);
                localStorage.setItem(LOCAL_STORAGE_KEYS.MODEL, newModel);
            };

            const [sourceContent, setSourceContent] = React.useState('');
            const [uploadedImages, setUploadedImages] = React.useState([]);
            const [agencyName, setAgencyName] = React.useState('');
            const [agencyDescription, setAgencyDescription] = React.useState('');
            const [personaCards, setPersonaCards] = React.useState([]);
            const [prompts, setPrompts] = React.useState([{ 
                id: 1, 
                title: '',
                text: '', 
                result: '',
                source: 'SOURCE',
                sources: ['SOURCE'],
                sourceType: 'text',
                selectedImage: null,
                selectedPersonas: []
            }]);
            const [loading, setLoading] = React.useState({});
            const [error, setError] = React.useState('');
            const [isProcessingFile, setIsProcessingFile] = React.useState(false);
            const [uploadedDocuments, setUploadedDocuments] = React.useState([]);
            const [scenarioCards, setScenarioCards] = React.useState([]);
            const [activeTab, setActiveTab] = React.useState('content');
            const [isSettingsOpen, setIsSettingsOpen] = React.useState(false);

            // Add new state for chat
            const [isChatOpen, setIsChatOpen] = React.useState(false);

            // Add these new states
            const [llmConfig, setLlmConfig] = React.useState({
                openaiKey: localStorage.getItem('openai_api_key') || '',
                anthropicKey: localStorage.getItem('anthropic_api_key') || '',
                model: localStorage.getItem('selected_model') || 'gpt-4'
            });

            // Add this handler
            const handleLlmConfigChange = (key, value) => {
                const trimmedValue = value.trim();
                setLlmConfig(prev => {
                    const newConfig = { ...prev, [key]: trimmedValue };
                    if (key === 'openaiKey') {
                        // Also update the apiKey state and localStorage when openaiKey changes
                        setApiKey(trimmedValue);
                        localStorage.setItem(LOCAL_STORAGE_KEYS.API_KEY, trimmedValue);
                    }
                    localStorage.setItem(
                        `${key === 'model' ? 'selected_model' : key === 'openaiKey' ? 'openai_api_key' : 'anthropic_api_key'}`,
                        trimmedValue
                    );
                    return newConfig;
                });
            };

            // Update the handleFileUpload function to handle PDFs
            const handleFileUpload = async (event) => {
                const files = Array.from(event.target.files);
                if (!files.length) return;

                setIsProcessingFile(true);
                setError('');

                try {
                    for (const file of files) {
                        if (SUPPORTED_IMAGE_TYPES.includes(file.type)) {
                            // Handle image files
                            const imageContent = await FileProcessor.processImage(file);
                            const imageId = Date.now();
                            const imageData = {
                                id: imageId,
                                url: imageContent,
                                name: file.name,
                                type: file.type
                            };
                            setUploadedImages(current => [...current, imageData]);
                        } else if (file.type === 'application/pdf') {
                            // Handle PDF files
                            const pdfContent = await FileProcessor.processPDF(file);
                            const docId = Date.now();
                            const docData = {
                                id: docId,
                                name: file.name,
                                content: pdfContent,
                                type: file.type
                            };
                            setUploadedDocuments(current => [...current, docData]);
                        } else {
                            // Handle other text-based documents
                            const content = await file.text();
                            const docId = Date.now();
                            const docData = {
                                id: docId,
                                name: file.name,
                                content: content,
                                type: file.type
                            };
                            setUploadedDocuments(current => [...current, docData]);
                        }
                    }
                } catch (error) {
                    console.error('File processing error:', error);
                    setError('Error processing file: ' + error.message);
                } finally {
                    setIsProcessingFile(false);
                    // Clear the file input for future uploads
                    event.target.value = '';
                }
            };

            const deleteImage = (imageId) => {
                setUploadedImages(current => current.filter(img => img.id !== imageId));
                setPrompts(current => current.map(prompt => 
                    prompt.selectedImage === imageId 
                        ? {...prompt, selectedImage: null}
                        : prompt
                ));
            };

            const addPersonaCard = (persona) => {
                setPersonaCards([...personaCards, persona]);
            };

            const updatePersonaCard = (id, changes) => {
                setPersonaCards(personaCards.map(p => 
                    p.cardId === id ? {...p, ...changes} : p
                ));
            };

            const deletePersonaCard = (id) => {
                setPersonaCards(personaCards.filter(p => p.cardId !== id));
            };

            const addPrompt = () => {
                const newPrompt = {
                    id: Date.now(),
                    title: '',
                    text: '',
                    result: '',
                    source: 'SOURCE',
                    sources: ['SOURCE'],
                    sourceType: 'text',
                    selectedImage: null,
                    selectedPersonas: []
                };
                setPrompts([...prompts, newPrompt]);
            };

            const deletePrompt = (id) => {
                setPrompts(prompts.filter(p => p.id !== id));
            };

            const updatePrompt = (id, changes) => {
                setPrompts(prompts.map(p => 
                    p.id === id ? {...p, ...changes} : p
                ));
            };
            const getPromptSource = (promptId) => {
                const prompt = prompts.find(p => p.id === promptId);
                if (!prompt) return '';
                
                // Ensure we're working with an array of sources and log for debugging
                const sources = Array.isArray(prompt.sources) ? prompt.sources : [prompt.source];
                console.log('Processing sources:', sources); // Debug log
                
                const sourceContents = sources.map(source => {
                    if (!source) return '';
                    
                    let content = '';
                    if (source === 'SOURCE') {
                        content = sourceContent || '';
                        console.log('SOURCE content length:', content.length); // Debug log
                    } else if (source.startsWith('DOC-')) {
                        const docId = parseInt(source.replace('DOC-', ''));
                        const document = uploadedDocuments.find(doc => doc.id === docId);
                        content = document ? `[Document: ${document.name}]\n${document.content}` : '';
                        console.log('DOC content length:', content.length); // Debug log
                    } else if (source.startsWith('RESULT')) {
                        const sourcePromptId = parseInt(source.replace('RESULT', ''));
                        const sourcePrompt = prompts.find(p => p.id === sourcePromptId);
                        content = sourcePrompt ? `[Result from Prompt ${sourcePromptId}]\n${sourcePrompt.result}` : '';
                        console.log('RESULT content length:', content.length); // Debug log
                    }
                    
                    return content;
                }).filter(content => content.trim() !== '');

                console.log('Number of source contents:', sourceContents.length); // Debug log
                
                // Join all sources with clear separators
                const finalContent = sourceContents.join('\n\n=== SOURCE SEPARATOR ===\n\n');
                console.log('Final content length:', finalContent.length); // Debug log
                
                return finalContent;
            };

            const getPersonaContext = (selectedPersonas) => {
                if (!selectedPersonas || selectedPersonas.length === 0) {
                    return '\nRespond in a professional, general audience-appropriate tone.';
                }

                const personas = selectedPersonas.map(id => 
                    personaCards.find(p => p.cardId === parseInt(id))
                ).filter(Boolean);

                if (personas.length === 0) {
                    return '\nRespond in a professional, general audience-appropriate tone.';
                }

                const fromPersonas = personas.filter(p => p.direction === 'from');
                const toPersonas = personas.filter(p => p.direction === 'to');
                
                let context = '';
                
                if (fromPersonas.length > 0) {
                    context += `\nRespond FROM the perspective of: ${fromPersonas.map(p => 
                        `${p.name} (${p.description})`).join(', ')}`;
                }
                
                if (toPersonas.length > 0) {
                    context += `\nTarget your response TO: ${toPersonas.map(p => 
                        `${p.name} (${p.description})`).join(', ')}`;
                }
                
                return context;
            };

            // Update the runPrompt function to use llmConfig.openaiKey
            const runPrompt = async (promptId) => {
                // More thorough API key validation
                const currentApiKey = llmConfig.openaiKey.trim();
                
                if (!currentApiKey) {
                    const errorMessage = 'Please enter a valid OpenAI API key in settings';
                    console.error(errorMessage);
                    updatePrompt(promptId, { result: `Error: ${errorMessage}` });
                    return;
                }

                const prompt = prompts.find(p => p.id === promptId);
                if (!prompt) {
                    console.error('Prompt not found');
                    return;
                }

                setLoading(prev => ({ ...prev, [promptId]: true }));
                
                try {
                    // Test the API key with a simple request first
                    const testResponse = await fetch('https://api.openai.com/v1/models', {
                        headers: {
                            'Authorization': `Bearer ${currentApiKey}`
                        }
                    });

                    if (!testResponse.ok) {
                        throw new Error('Invalid API key or API access issue');
                    }

                    if (prompt.sourceType === 'image') {
                        // Rest of the image analysis code...
                        const selectedImage = uploadedImages.find(img => img.id === prompt.selectedImage);
                        if (!selectedImage) {
                            throw new Error('Selected image not found');
                        }

                        const response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${currentApiKey}`,
                            },
                            body: JSON.stringify({
                                model: "gpt-4o", // Using GPT-4 Vision model
                                messages: [
                                    {
                                        role: "system",
                                        content: "You are a highly capable image analysis assistant. Provide detailed, accurate, and insightful analysis of images."
                                    },
                                    {
                                        role: "user",
                                        content: [
                                            { type: "text", text: prompt.text },
                                            {
                                                type: "image_url",
                                                image_url: {
                                                    url: selectedImage.url,
                                                    detail: "high" // Using high detail for better analysis
                                                }
                                            }
                                        ]
                                    }
                                ],
                                max_tokens: 4096, // Increased token limit for more detailed responses
                                temperature: 0.7 // Balanced between creativity and accuracy
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        updatePrompt(promptId, { result: data.choices[0].message.content });
                    } else {
                        // Handle text-based prompts
                        const sourceText = getPromptSource(promptId);
                        
                        const response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${currentApiKey}`,
                            },
                            body: JSON.stringify({
                                model: "gpt-4o",
                                messages: [
                                    {
                                        role: "system",
                                        content: `Context:\n${sourceText}${getPersonaContext(prompt.selectedPersonas)}`
                                    },
                                    {
                                        role: "user",
                                        content: prompt.text
                                    }
                                ],
                                max_tokens: 1000
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        updatePrompt(promptId, { result: data.choices[0].message.content });
                    }
                } catch (error) {
                    console.error('Error running prompt:', error);
                    updatePrompt(promptId, { result: `Error: ${error.message}` });
                } finally {
                    setLoading(prev => ({ ...prev, [promptId]: false }));
                }
            };

            // Update runAllPrompts to run sequentially and preserve results
            const runAllPrompts = async () => {
                for (const prompt of prompts) {
                    await runPrompt(prompt.id);
                }
            };

            const exportAgency = async () => {
                try {
                    const exportData = {
                        agencyName,
                        agencyDescription,
                        sourceContent,
                        uploadedImages,
                        personaCards,
                        prompts: prompts.map(({ id, title, text, result, source, sources, sourceType, selectedImage }) => ({
                            id,
                            title,
                            text,
                            result,
                            source,
                            sources,
                            sourceType,
                            selectedImage
                        })),
                        settings: { model },
                        scenarioCards,
                    };
                    
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
                        type: 'application/json' 
                    });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `playground-export-${Date.now()}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    setError('Error exporting playground: ' + error.message);
                }
            };

            const exportContent = () => {
                try {
                    const content = prompts.map(prompt => {
                        let promptContent = `PROMPT ${prompt.id}: ${prompt.title}\n${prompt.text}\n\n`;
                        if (prompt.sourceType === 'image') {
                            promptContent += `[Image Analysis]\n`;
                        }
                        promptContent += `RESULT ${prompt.id}:\n${prompt.result}\n\n---\n\n`;
                        return promptContent;
                    }).join('');
                    
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `playground-content-${Date.now()}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    setError('Error exporting content: ' + error.message);
                }
            };

            const loadAgency = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (!data.prompts || !data.settings) {
                            throw new Error('Invalid playground file structure');
                        }

                        setSourceContent(data.sourceContent || '');
                        setPrompts(data.prompts);
                        setModel(data.settings.model || OPENAI_MODELS[0]);
                        setAgencyName(data.agencyName || '');
                        setAgencyDescription(data.agencyDescription || '');
                        setUploadedImages(data.uploadedImages || []);
                        setPersonaCards(data.personaCards || []);
                        setScenarioCards(data.scenarioCards || []);
                    } catch (error) {
                        setError('Error loading playground: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };

            const handleDocumentSelect = (content) => {
                setSourceContent(content);
            };

            const addScenarioCard = (scenario) => {
                setScenarioCards([...scenarioCards, scenario]);
            };

            const updateScenarioCard = (id, changes) => {
                setScenarioCards(scenarioCards.map(s => 
                    s.cardId === id ? {...s, ...changes} : s
                ));
            };

            const deleteScenarioCard = (id) => {
                setScenarioCards(scenarioCards.filter(s => s.cardId !== id));
            };

            // Add this constant near your other constants (PERSONAS, SCENARIOS)
            const PLAYGROUNDS = [
                {
                    id: 'content-analysis',
                    name: 'Content Analysis',
                    description: 'Analyze content tone, style, and audience targeting',
                    config: {
                        agencyName: 'Content Analysis Playground',
                        agencyDescription: 'Analyze and optimize content for different platforms and audiences',
                        prompts: [{
                            id: 1,
                            title: 'Content Analysis',
                            text: 'Analyze this content and provide key insights about:\n1. Tone and style\n2. Target audience\n3. Key messages\n4. Areas for improvement',
                            result: '',
                            source: 'SOURCE',
                            sources: ['SOURCE'],
                            sourceType: 'text',
                            selectedImage: null
                        }]
                    }
                },
                {
                    id: 'social-media',
                    name: 'Social Media',
                    description: 'Create and optimize social media content',
                    config: {
                        agencyName: 'Social Media Playground',
                        agencyDescription: 'Create engaging social media content across platforms',
                        prompts: [{
                            id: 2,
                            title: 'Social Post Generator',
                            text: 'Create a series of social media posts optimized for engagement. Include variations for:\n1. LinkedIn\n2. Twitter\n3. Instagram',
                            result: '',
                            source: 'SOURCE',
                            sources: ['SOURCE'],
                            sourceType: 'text',
                            selectedImage: null
                        }]
                    }
                },
                {
                    id: 'blog-writing',
                    name: 'Blog Writing',
                    description: 'Generate blog content and outlines',
                    config: {
                        agencyName: 'Blog Writing Playground',
                        agencyDescription: 'Create engaging blog content and structured outlines',
                        prompts: [{
                            id: 3,
                            title: 'Blog Outline',
                            text: 'Create a detailed blog outline including:\n1. Title options\n2. Key sections\n3. Main points for each section\n4. Suggested examples or case studies',
                            result: '',
                            source: 'SOURCE',
                            sources: ['SOURCE'],
                            sourceType: 'text',
                            selectedImage: null
                        }]
                    }
                },
                {
                    id: 'email-marketing',
                    name: 'Email Marketing',
                    description: 'Create email marketing campaigns',
                    config: {
                        agencyName: 'Email Marketing Playground',
                        agencyDescription: 'Design effective email marketing campaigns',
                        prompts: [{
                            id: 4,
                            title: 'Email Sequence',
                            text: 'Generate an email marketing sequence including:\n1. Subject lines\n2. Email body content\n3. Call-to-action suggestions\n4. Follow-up variations',
                            result: '',
                            source: 'SOURCE',
                            sources: ['SOURCE'],
                            sourceType: 'text',
                            selectedImage: null
                        }]
                    }
                },
                {
                    id: 'product-description',
                    name: 'Product Description',
                    description: 'Write compelling product descriptions',
                    config: {
                        agencyName: 'Product Description Playground',
                        agencyDescription: 'Create engaging product descriptions and features',
                        prompts: [{
                            id: 5,
                            title: 'Product Description',
                            text: 'Create a compelling product description including:\n1. Main benefits\n2. Key features\n3. Technical specifications\n4. Use cases\n5. Target audience',
                            result: '',
                            source: 'SOURCE',
                            sources: ['SOURCE'],
                            sourceType: 'text',
                            selectedImage: null
                        }]
                    }
                }
            ];

            // Add this function to load playgrounds from the filesystem
            const loadPlaygroundsFromFS = async () => {
                try {
                    console.log('Starting to load playgrounds...');
                    
                    // Get list of playground files
                    const files = [
                        'playground-product marketing team.json',
                        'sales-playground.json',
                        'product-ideation-team.json',
                        'experts-playground.json',
                        'hackathon-team.json',
                        'corporate-roundtable-team.json',
                        'strategic-planning-team.json'
                    ];
                    
                    console.log('Found playground files:', files);
                    
                    // Load each playground file
                    const loadedPlaygrounds = files.map(file => {
                        try {
                            // For the product marketing team playground, we'll use its actual content
                            if (file === 'playground-product marketing team.json') {
                                return {
                                    id: file.replace('.json', ''),
                                    name: 'Product Marketing Team',
                                    description: 'A Marketing Scenario, Shopping Personas and Marketing Agents.',
                                    config: {
                                        agencyName: 'Product Marketing Team',
                                        agencyDescription: 'A Marketing Scenario, Shopping Personas and Marketing Agents.',
                                        personaCards: [
                                            // ... persona cards would go here
                                        ],
                                        prompts: [
                                            {
                                                id: 1,
                                                title: 'Product Describer',
                                                text: 'Agent for Product Description...',
                                                result: '',
                                                source: 'SOURCE',
                                                sources: ['SOURCE'],
                                                sourceType: 'text',
                                                selectedImage: null
                                            },
                                            // ... other prompts would go here
                                        ]
                                    }
                                };
                            }
                            
                            // For other files, create placeholder content
                            const name = file.replace('.json', '').replace(/-/g, ' ');
                            return {
                                id: file.replace('.json', ''),
                                name: name.charAt(0).toUpperCase() + name.slice(1),
                                description: 'Custom playground',
                                config: {
                                    agencyName: name.charAt(0).toUpperCase() + name.slice(1),
                                    agencyDescription: 'Custom playground',
                                    personaCards: [],
                                    prompts: []
                                }
                            };
                        } catch (error) {
                            console.error(`Error loading playground ${file}:`, error);
                            return null;
                        }
                    });

                    // Filter out any failed loads
                    const validPlaygrounds = loadedPlaygrounds.filter(p => p !== null);
                    console.log('Final loaded playgrounds:', validPlaygrounds);
                    
                    return validPlaygrounds;
                } catch (error) {
                    console.error('Error loading playgrounds:', error);
                    throw error;
                }
            };

            // Update the PlaygroundTray component to handle loading states
            const PlaygroundTray = ({ onLoadPlayground }) => {
                const [selectedPlayground, setSelectedPlayground] = React.useState('');
                const [loadedPlaygrounds, setLoadedPlaygrounds] = React.useState([]);
                const [isLoading, setIsLoading] = React.useState(true);
                const [loadError, setLoadError] = React.useState(null);

                // Load playgrounds when component mounts
                React.useEffect(() => {
                    const loadPlaygrounds = async () => {
                        try {
                            setIsLoading(true);
                            setLoadError(null);
                            const playgrounds = await loadPlaygroundsFromFS();
                            setLoadedPlaygrounds(playgrounds);
                        } catch (error) {
                            console.error('Error loading playgrounds:', error);
                            setLoadError('Failed to load custom playgrounds');
                        } finally {
                            setIsLoading(false);
                        }
                    };

                    loadPlaygrounds();
                }, []);

                const handleLoadPlayground = () => {
                    if (selectedPlayground) {
                        const playground = [...PLAYGROUNDS, ...loadedPlaygrounds].find(p => p.id === selectedPlayground);
                        if (playground && onLoadPlayground) {
                            onLoadPlayground(playground.config);
                            setSelectedPlayground('');
                        }
                    }
                };

                return (
                    <div className="persona-tray" style={{ width: '100%', boxSizing: 'border-box' }}>
                        <div className="persona-selector-container" style={{ width: '100%', display: 'flex', alignItems: 'center' }}>
                            <select 
                                value={selectedPlayground}
                                onChange={(e) => setSelectedPlayground(e.target.value)}
                                className="persona-selector"
                                style={{ 
                                    flex: '1',
                                    maxWidth: 'calc(100% - 45px)',
                                    overflow: 'hidden',
                                    textOverflow: 'ellipsis',
                                    whiteSpace: 'nowrap'
                                }}
                                disabled={isLoading}
                            >
                                <option value="">
                                    {isLoading ? '🔄 Loading playgrounds...' : '🎮 Select Playground...'}
                                </option>
                                <optgroup label="Default Playgrounds">
                                    {PLAYGROUNDS.map(playground => (
                                        <option key={playground.id} value={playground.id}>
                                            {playground.name} - {playground.description}
                                        </option>
                                    ))}
                                </optgroup>
                                {loadedPlaygrounds.length > 0 && (
                                    <optgroup label="Custom Playgrounds">
                                        {loadedPlaygrounds.map(playground => (
                                            <option key={playground.id} value={playground.id}>
                                                {playground.name} - {playground.description}
                                            </option>
                                        ))}
                                    </optgroup>
                                )}
                            </select>
                            <button 
                                onClick={handleLoadPlayground}
                                className="add-persona-btn"
                                disabled={!selectedPlayground || isLoading}
                                style={{ 
                                    minWidth: '35px',
                                    height: '35px',
                                    padding: '0',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    opacity: (!selectedPlayground || isLoading) ? 0.5 : 1
                                }}
                            >
                                {isLoading ? '🔄' : '+'}
                            </button>
                        </div>
                        {loadError && (
                            <div style={{ 
                                color: 'var(--error-color)', 
                                fontSize: '0.75rem', 
                                marginTop: '0.25rem' 
                            }}>
                                {loadError}
                            </div>
                        )}
                        <div style={{ display: 'flex', gap: '0.5rem', marginTop: '0.5rem' }}>
                            <input
                                type="file"
                                id="loadAgencyInput"
                                className="hidden"
                                accept=".json"
                                onChange={loadAgency}
                                disabled={isLoading}
                            />
                            <button 
                                onClick={() => document.getElementById('loadAgencyInput').click()} 
                                className="btn btn-agency"
                                style={{ flex: 1, fontSize: '0.75rem', padding: '0.5rem' }}
                                disabled={isLoading}
                            >
                                📂 Import Playground
                            </button>
                            <button 
                                onClick={exportAgency} 
                                className="btn btn-agency"
                                style={{ flex: 1, fontSize: '0.75rem', padding: '0.5rem' }}
                                disabled={isLoading}
                            >
                                💾 Export Playground
                            </button>
                        </div>
                    </div>
                );
            };

            // Update the loadPlayground function to handle all playground data
            const loadPlayground = (config) => {
                setAgencyName(config.agencyName || '');
                setAgencyDescription(config.agencyDescription || '');
                setPrompts(config.prompts || []);
                setPersonaCards(config.personaCards || []);
                setScenarioCards(config.scenarioCards || []);
                setSourceContent(config.sourceContent || '');
            };

            // Add this debug log
            React.useEffect(() => {
                console.log('Chat open state:', isChatOpen);
            }, [isChatOpen]);

            return (
                <React.Fragment>
                    <div 
                        style={{
                            position: 'fixed',
                            top: '1rem',
                            right: '1rem',
                            zIndex: 99999
                        }}
                    >
                        <button 
                            className="floating-gear"
                            onClick={() => setIsSettingsOpen(!isSettingsOpen)}
                            title="Settings"
                            style={{
                                width: '48px',
                                height: '48px',
                                background: 'var(--accent-color)',
                                border: 'none',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                boxShadow: '0 2px 8px rgba(0, 0, 0, 0.2)',
                                transition: 'all 0.3s ease',
                                color: 'white',
                                padding: 0
                            }}
                        >
                            <svg 
                                viewBox="0 0 24 24" 
                                fill="none" 
                                stroke="currentColor" 
                                strokeWidth="2"
                                style={{
                                    width: '24px',
                                    height: '24px'
                                }}
                            >
                                <path d="M12 15a3 3 0 100-6 3 3 0 000 6z" />
                                <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z" />
                            </svg>
                        </button>
                    </div>
                    <div className="container">
                        {/* Settings Button */}
                        <button 
                            style={{
                                position: 'fixed',
                                top: '1rem',
                                right: '1rem',
                                width: '48px',
                                height: '48px',
                                background: 'var(--accent-color)',
                                border: 'none',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                zIndex: 99999,
                                color: 'white',
                            }}
                            onClick={() => setIsSettingsOpen(!isSettingsOpen)}
                        >
                            ⚙️
                        </button>

                        {/* Settings Panel */}
                        {isSettingsOpen && (
                            <div style={{
                                position: 'fixed',
                                top: 0,
                                right: 0,
                                width: '320px',
                                height: '100vh',
                                background: 'var(--secondary-bg)',
                                borderLeft: '1px solid var(--border-color)',
                                boxShadow: '-2px 0 5px rgba(0, 0, 0, 0.2)',
                                zIndex: 99998,
                                padding: '1rem',
                                overflowY: 'auto'
                            }}>
                                <div style={{ 
                                    display: 'flex', 
                                    justifyContent: 'space-between', 
                                    alignItems: 'center',
                                    marginBottom: '1rem',
                                    borderBottom: '1px solid var(--border-color)',
                                    paddingBottom: '0.5rem'
                                }}>
                                    <h3 style={{ margin: 0 }}>Settings</h3>
                                    <button 
                                        onClick={() => setIsSettingsOpen(false)}
                                        style={{
                                            background: 'none',
                                            border: 'none',
                                            color: 'var(--text-primary)',
                                            cursor: 'pointer',
                                            fontSize: '1.2rem'
                                        }}
                                    >
                                        ×
                                    </button>
                                </div>

                                {/* Only keep the LLM Settings Section */}
                                <div style={{ marginBottom: '2rem' }}>
                                    <h4 style={{ marginBottom: '1rem' }}>LLM Settings</h4>
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                        <div>
                                            <label style={{ display: 'block', marginBottom: '0.5rem' }}>OpenAI API Key</label>
                                            <input
                                                type="password"
                                                value={llmConfig.openaiKey}
                                                onChange={(e) => handleLlmConfigChange('openaiKey', e.target.value)}
                                                placeholder="Enter OpenAI API Key"
                                                style={{
                                                    width: '100%',
                                                    padding: '0.5rem',
                                                    background: 'var(--primary-bg)',
                                                    border: '1px solid var(--border-color)',
                                                    color: 'var(--text-primary)'
                                                }}
                                            />
                                        </div>

                                        <div>
                                            <label style={{ display: 'block', marginBottom: '0.5rem' }}>Anthropic API Key</label>
                                            <input
                                                type="password"
                                                value={llmConfig.anthropicKey}
                                                onChange={(e) => handleLlmConfigChange('anthropicKey', e.target.value)}
                                                placeholder="Enter Anthropic API Key"
                                                style={{
                                                    width: '100%',
                                                    padding: '0.5rem',
                                                    background: 'var(--primary-bg)',
                                                    border: '1px solid var(--border-color)',
                                                    color: 'var(--text-primary)'
                                                }}
                                            />
                                        </div>

                                        <div>
                                            <label style={{ display: 'block', marginBottom: '0.5rem' }}>Model</label>
                                            <select
                                                value={llmConfig.model}
                                                onChange={(e) => handleLlmConfigChange('model', e.target.value)}
                                                style={{
                                                    width: '100%',
                                                    padding: '0.5rem',
                                                    background: 'var(--primary-bg)',
                                                    border: '1px solid var(--border-color)',
                                                    color: 'var(--text-primary)'
                                                }}
                                            >
                                                <optgroup label="OpenAI">
                                                    <option value="gpt-4o">GPT-4o</option>
                                                    <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                                </optgroup>
                                                <optgroup label="Anthropic">
                                                    <option value="claude-3-opus">Claude 3 Opus</option>
                                                    <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                                                    <option value="claude-2.1">Claude 2.1</option>
                                                </optgroup>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        <ProcessingIndicator isVisible={isProcessingFile} />
                        
                        <div className="fixed-section">
                            <div className="tabs-container">
                                <div className="tab-content">
                                    <div className="content-tab">
                                        {/* Playground Name and Description */}
                                        <div className="agency-details">
                                            <textarea
                                                value={agencyName}
                                                onChange={(e) => setAgencyName(e.target.value)}
                                                placeholder="Enter Playground Name..."
                                                className="agency-name-textarea"
                                            />
                                            <textarea
                                                value={agencyDescription}
                                                onChange={(e) => setAgencyDescription(e.target.value)}
                                                placeholder="Enter Playground Description..."
                                                className="agency-description-textarea"
                                            />
                                        </div>

                                        {/* Upload Components Group */}
                                        <div className="upload-content-group">
                                            <div className="document-tray-title">
                                                <h3 className="section-title">📚 DATA</h3>
                                            </div>
                                            <input
                                                type="file"
                                                id="fileInput"
                                                className="hidden"
                                                accept=".txt,.md,.json,.pdf,image/*"
                                                onChange={handleFileUpload}
                                                multiple
                                            />
                                            <button 
                                                onClick={() => document.getElementById('fileInput').click()}
                                                className="btn btn-primary"
                                                style={{ marginBottom: '1rem' }}
                                            >
                                                📎 Upload Texts, PDFs or Images
                                            </button>

                                            <div className="tray-container">
                                                <DocumentTray 
                                                    uploadedDocuments={uploadedDocuments} 
                                                    onDeleteDocument={(id) => {
                                                        setUploadedDocuments(current => current.filter(doc => doc.id !== id));
                                                    }}
                                                    onSelectDocument={(content) => setSourceContent(content)}
                                                />

                                                <div className="document-tray-title">
                                                    Input Text
                                                </div>
                                                <textarea
                                                    value={sourceContent}
                                                    onChange={(e) => setSourceContent(e.target.value)}
                                                    placeholder="Enter or upload source content..."
                                                    className="source-textarea"
                                                    style={{
                                                        backgroundColor: 'black',
                                                        color: 'white',
                                                        width: 'calc(100% - 20px)',
                                                        margin: '10px',
                                                        minHeight: '200px'
                                                    }}
                                                />

                                                <ImageTray uploadedImages={uploadedImages} onDeleteImage={deleteImage} />
                                            </div>
                                        </div>

                                        {/* Card Selection Group - Updated with Playground at top */}
                                        <div className="document-tray-title">
                                            <h3 className="section-title">🎴 CARDS</h3>
                                        </div>
                                        <div className="selection-trays">
                                            {/* Add Playground section here */}
                                            <PlaygroundTray onLoadPlayground={loadPlayground} />
                                            
                                            {/* Existing card selectors */}
                                            <ScenarioTray onAddScenario={addScenarioCard} />
                                            <PersonaTray onAddPersona={addPersonaCard} />
                                            <PromptTray onAddPrompt={(template) => {
                                                const newPrompt = {
                                                    ...template,
                                                    id: Date.now(),
                                                    result: '',
                                                    source: 'SOURCE',
                                                    sources: ['SOURCE'],
                                                    sourceType: 'text',
                                                    selectedImage: null,
                                                    selectedPersonas: []
                                                };
                                                setPrompts([...prompts, newPrompt]);
                                            }} />
                                        </div>

                                        {activeTab === 'content' && (
                                            <div className="button-bar">
                                                <button onClick={runAllPrompts} className="btn btn-agency">
                                                    🚀 Run All
                                                </button>
                                                <button onClick={exportContent} className="btn btn-agency">
                                                    📤 Export Content
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="content-area">
                            <div className="horizontal-scroll">
                                <div className="scenario-container">
                                    {scenarioCards.map(scenario => (
                                        <ScenarioCard
                                            key={scenario.cardId}
                                            scenario={scenario}
                                            onUpdate={updateScenarioCard}
                                            onDelete={deleteScenarioCard}
                                        />
                                    ))}
                                </div>
                                <div className="persona-container">
                                    {personaCards.map(persona => (
                                        <PersonaCard
                                            key={persona.cardId}
                                            persona={persona}
                                            onUpdate={updatePersonaCard}
                                            onDelete={deletePersonaCard}
                                            apiKey={apiKey}
                                        />
                                    ))}
                                </div>
                                <div className="prompt-container">
                                    {prompts.map(prompt => (
                                        <PromptCard
                                            key={prompt.id}
                                            prompt={prompt}
                                            sourceOptions={prompts.filter(p => p.id < prompt.id)}
                                            loading={loading[prompt.id]}
                                            onUpdate={updatePrompt}
                                            onDelete={deletePrompt}
                                            onRun={runPrompt}
                                            uploadedImages={uploadedImages}
                                            uploadedDocuments={uploadedDocuments}
                                            apiKey={apiKey}
                                            personaCards={personaCards}
                                            sourceContent={sourceContent}
                                            onSourceSelect={(content) => setSourceContent(content)}
                                        />
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>

                    <button 
                        className="chat-toggle-button"
                        onClick={() => {
                            console.log('Chat button clicked');
                            setIsChatOpen(prev => !prev);
                        }}
                        style={{
                            position: 'fixed',
                            bottom: '2rem',
                            right: '2rem',
                            zIndex: 999999,
                            width: '48px',
                            height: '48px',
                            background: 'var(--accent-color)',
                            border: 'none',
                            borderRadius: '50%',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            boxShadow: '0 2px 8px rgba(0, 0, 0, 0.2)',
                            transition: 'all 0.3s ease',
                            color: 'white',
                            padding: 0
                        }}
                    >
                        <svg 
                            viewBox="0 0 24 24" 
                            fill="none" 
                            stroke="currentColor"
                            style={{
                                width: '24px',
                                height: '24px'
                            }}
                        >
                            <path 
                                d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10z" 
                                strokeWidth="2" 
                                strokeLinecap="round" 
                                strokeLinejoin="round"
                            />
                        </svg>
                    </button>

                    <Chat 
                        llmConfig={llmConfig}
                        isOpen={isChatOpen}
                        onClose={() => {
                            console.log('Closing chat');
                            setIsChatOpen(false);
                        }}
                        prompts={prompts}
                        sourceContent={sourceContent}
                    />
                </React.Fragment>
            );
        }

        // Initialize React App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>