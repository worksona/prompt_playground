<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worksona Playground</title>
    
    <!-- Core Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js"></script>
    
    <!-- Document Processing Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        /* Theme Variables */
        :root {
            --primary-bg: #ffffff;
            --secondary-bg: #f5f5f7;
            --accent-color: #e29863;
            --text-primary: #1a1e21;
            --text-secondary: #6b7280;
            --border-color: rgba(0, 0, 0, 0.1);
            --border-radius: 0;  /* Add this variable for consistency */
        }

        /* Base styles */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }

        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            border-radius: 0;
        }

        .container {
            padding: 2rem;
            display: flex;
            min-height: calc(100vh - 4rem);
            position: relative;
            z-index: 1;
        }

        /* Agency Details styles */
        .agency-details {
            margin-bottom: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background: transparent;
            padding: 0;
            border: none;
            border-radius: 0;
        }

        .agency-name-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            resize: none;
            outline: none;
            font-family: inherit;
            background: var(--primary-bg);
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 500;
            height: 2.5rem;
        }

        .agency-description-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            resize: vertical;
            outline: none;
            font-family: inherit;
            background: var(--primary-bg);
            color: var(--text-primary);
            min-height: 4rem;
            font-size: 0.875rem;
        }
        /* Fixed section */
        .fixed-section {
            width: 400px; /* Fixed width instead of percentage */
            min-width: 400px;
            max-width: 400px;
            flex-shrink: 0;
            padding: 1.25rem;
            border-right: 1px solid var(--border-color);
            background: var(--secondary-bg);
            height: calc(100vh - 4rem);
            overflow-y: auto;
            position: fixed;
            left: 2rem;
            top: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 100;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Focus states for textareas */
        .agency-name-textarea:focus,
        .agency-description-textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(99, 226, 183, 0.1);
        }

        /* Placeholder colors */
        .agency-name-textarea::placeholder,
        .agency-description-textarea::placeholder {
            color: var(--text-secondary);
        }

        /* Persona styles */
        .persona-tray {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 0;
        }

        .persona-selector-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .persona-selector {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
        }

        .add-persona-btn {
            background: var(--accent-color);
            color: var(--primary-bg);
            border: none;
            border-radius: 0;
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .persona-card {
            background: var(--secondary-bg);
            border-radius: 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            padding: 1rem;
            min-width: 300px;
            max-width: 400px;
            height: fit-content;
            flex-shrink: 0;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            border: 1px solid var(--border-color);
            border-left: 4px solid #FF9800; /* Orange accent for personas */
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-sizing: border-box;
        }

        .persona-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-color);
        }

        .persona-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .persona-emoji {
            font-size: 2rem;
        }

        .persona-title {
            font-weight: 500;
            color: var(--text-primary);
        }

        .persona-name {
            width: calc(100% - 1rem);
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            outline: none;
            margin: 0 0.5rem 0.5rem 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }

        .persona-name:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(99, 226, 183, 0.2);
        }

        .direction-selector {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .persona-textarea {
            width: calc(100% - 1rem);
            min-height: 150px;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            resize: vertical;
            outline: none;
            font-family: inherit;
            background: var(--primary-bg);
            color: var(--text-primary);
            margin: 0 0.5rem 1rem 0.5rem;
            box-sizing: border-box;
        }

        .persona-textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(99, 226, 183, 0.2);
        }

        .persona-textarea::placeholder {
            color: var(--text-secondary);
        }

        /* Image Upload styles */
        .image-upload-zone {
            border: 2px dashed var(--border-color);
            padding: 2rem;
            border-radius: 0;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--secondary-bg);
            margin-bottom: 1rem;
        }

        .image-upload-zone:hover {
            border-color: var(--accent-color);
            background: var(--secondary-bg);
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            margin: 1rem 0;
            border-radius: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Image Tray styles */
        .image-tray {
            margin-top: 1rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--secondary-bg);
        }

        .image-tray-title {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .image-preview-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .image-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 0;
            overflow: hidden;
            border: 2px solid var(--border-color);
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-item.selected {
            border-color: var(--accent-color);
        }

        .image-preview-item .delete-button {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--secondary-bg);
            border: none;
            border-radius: 0;
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-weight: bold;
        }

        /* Content area */
        .content-area {
            flex: 1;
            margin-left: calc(400px + 2rem); /* Fixed margin based on tray width plus padding */
            min-width: 0;
            padding-bottom: 76px;
            padding-left: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* Horizontal scroll */
        .horizontal-scroll {
            display: flex;
            gap: 2rem; /* Fixed gap between cards */
            overflow-x: auto;
            padding: 1rem 0;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) transparent;
        }

        .horizontal-scroll::-webkit-scrollbar {
            height: 8px;
            border-radius: 0;
        }

        .horizontal-scroll::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 0;
        }

        .horizontal-scroll::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: 0;
        }
        /* Prompt card styles */
        .prompt-card {
            background: var(--secondary-bg);
            border-radius: 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            padding: 1rem;
            min-width: 300px;
            max-width: 400px;
            height: fit-content;
            min-height: 500px; /* Increased from default height */
            flex-shrink: 0;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* Slightly increased gap */
        }

        .prompt-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-color);
        }

        .prompt-card.image-mode {
            border-left: 4px solid var(--accent-color);
        }

        .source-type-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0;
            background: transparent;
            border-radius: 0;
        }

        .source-type-button {
            flex: 1;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--secondary-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .source-type-button.active {
            background: var(--accent-color);
            color: var(--primary-bg);
            border-color: var(--accent-color);
        }

        .source-selector {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            outline: none;
            margin-bottom: 0.5rem;
        }

        .prompt-textarea {
            width: 100%;
            min-height: 200px; /* Increased from 150px */
            height: 200px;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            resize: vertical;
            outline: none;
            font-family: inherit;
            background: var(--primary-bg);
            color: var(--text-primary);
            margin: 0;
            box-sizing: border-box;
            transition: border-color 0.2s ease;
        }

        .prompt-textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(99, 226, 183, 0.2);
        }

        .prompt-textarea::placeholder {
            color: var(--text-secondary);
        }

        .result-container {
            position: relative;
            width: 100%;
        }

        .result-textarea {
            width: 100%;
            min-height: 250px; /* Increased from 200px */
            height: 250px;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            resize: vertical;
            outline: none;
            font-family: inherit;
            background: var(--primary-bg);
            color: var(--text-primary);
            margin: 0;
            box-sizing: border-box;
        }

        /* API Key Input styles */
        .api-key-input,
        .model-selector {
            width: 100%;
            height: 45px;  /* Explicit height to match */
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.875rem;
            outline: none;
            margin: 0.5rem 0;
            box-sizing: border-box;
            -webkit-appearance: none;  /* Remove default styling */
            -moz-appearance: none;
            appearance: none;
        }

        .api-key-input {
            type: password;  /* Make the input secure */
        }

        .api-key-input:focus,
        .model-selector:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(226, 152, 99, 0.1);
        }

        /* Button styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 0;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            font-size: 0.875rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(99, 226, 183, 0.3);
        }

        .btn-primary, .btn-agency {
            background-color: var(--accent-color);
            color: var(--primary-bg);
            border: 1px solid transparent;
        }

        .btn-primary:hover, .btn-agency:hover {
            background-color: var(--primary-bg);
            color: var(--accent-color);
            border-color: var(--accent-color);
        }

        .btn-success {
            background-color: var(--accent-color);
            color: var(--primary-bg);
            width: 100%;
        }

        .btn-danger,
        .delete-button {
            background-color: #8B7E7E;  /* Muted gray-red */
            color: var(--primary-bg);
        }

        .btn-danger:hover,
        .delete-button:hover {
            background-color: #766868;  /* Slightly darker on hover */
            color: var(--primary-bg);
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-bg);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Utility styles */
        .hidden {
            display: none;
        }

        .error {
            background-color: rgba(139, 126, 126, 0.2);  /* Matching muted color with transparency */
            border-left: 4px solid #8B7E7E;
            padding: 1rem;
            margin: 1rem 0;
            color: #8B7E7E;
        }

        /* Copy button styles */
        .copy-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 0;
            padding: 0.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .copy-button svg {
            width: 16px;
            height: 16px;
            stroke: var(--text-primary);
        }

        .copy-button:hover {
            background: var(--accent-color);
        }

        .copy-button:hover svg {
            stroke: var(--primary-bg);
        }

        .model-selector {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            outline: none;
            margin-bottom: 1rem;
        }

        /* Add styles for the button bar */
        .button-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .button-bar .btn {
            flex: 1;
            min-width: calc(50% - 0.25rem);  /* 2 buttons per row with gap */
        }

        .document-tray {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 0;
        }

        .document-tray-title {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .document-preview-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .document-preview-item {
            display: flex;
            flex-direction: column;
            background: var(--primary-bg);
            border-radius: 0;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .document-preview-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--secondary-bg);
        }

        .document-icon {
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .document-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .document-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .preview-button,
        .use-button {
            background: var(--accent-color);
            color: var(--primary-bg);
            border: none;
            border-radius: 0;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .preview-button:hover,
        .use-button:hover {
            opacity: 0.9;
        }

        .document-content {
            width: 100%;
            min-height: 100px;
            max-height: 200px;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--secondary-bg);
            color: var(--text-primary);
            font-size: 0.875rem;
            resize: vertical;
            overflow-y: auto;
        }

        .prompt-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .prompt-title {
            font-weight: 500;
            color: var(--text-primary);
        }

        .prompt-title-input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            font-size: 0.875rem;
            outline: none;
        }

        .prompt-title-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(226, 152, 99, 0.1);
        }

        /* Scenario styles */
        .scenario-card {
            background: var(--secondary-bg);
            border-radius: 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            padding: 1rem;
            min-width: 300px;
            max-width: 400px;
            height: fit-content;
            min-height: 320px; /* Match persona card initial height */
            flex-shrink: 0;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            border: 1px solid var(--border-color);
            border-left: 4px solid #4CAF50; /* Green accent for scenarios */
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-sizing: border-box;
        }

        .scenario-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-color);
        }

        .scenario-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .scenario-title {
            font-weight: 500;
            color: var(--text-primary);
        }

        .scenario-name {
            width: calc(100% - 1rem);
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            outline: none;
            margin: 0 0.5rem 0.5rem 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }

        .scenario-name:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(99, 226, 183, 0.2);
        }

        .scenario-textarea {
            width: calc(100% - 1rem);
            min-height: 150px;
            height: 150px; /* Set initial height to match persona textarea */
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            resize: vertical;
            outline: none;
            font-family: inherit;
            background: var(--primary-bg);
            color: var(--text-primary);
            margin: 0 0.5rem 1rem 0.5rem;
            box-sizing: border-box;
        }

        .scenario-textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(99, 226, 183, 0.2);
        }

        .scenario-textarea::placeholder {
            color: var(--text-secondary);
        }

        /* Scenario Tray styles */
        .scenario-tray {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 0;
        }

        .scenario-selector-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .scenario-selector {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
        }

        .add-scenario-btn {
            background: var(--accent-color);
            color: var(--primary-bg);
            border: none;
            border-radius: 0;
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .add-scenario-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .add-scenario-btn:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .card {
            background-color: #ffffff;
            border-radius: 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 15px;
            width: 300px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .card-content {
            flex-grow: 1;
            font-size: 1rem;
            line-height: 1.5;
            color: #666;
        }

        .scenario-card {
            border-left: 5px solid #4CAF50;  /* Green accent */
        }

        .prompt-card {
            border-left: 5px solid #2196F3;  /* Blue accent */
        }

        .persona-card {
            border-left: 5px solid #FF9800;  /* Orange accent */
        }

        /* Add emoji styles for both cards */
        .prompt-emoji,
        .scenario-emoji {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }

        /* Update headers to accommodate emojis */
        .prompt-header,
        .scenario-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .prompt-title,
        .scenario-title {
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            margin-right: 0.5rem;
        }

        .source-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            padding-left: 0.25rem;
        }

        .tabs-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .tab-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .tab-button {
            flex: 1;
            padding: 0.75rem 0.5rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .tab-button.active {
            background: var(--accent-color);
            color: var(--primary-bg);
            border-color: var(--accent-color);
        }

        .tab-button emoji {
            font-size: 1rem;
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
        }

        .instructions-content {
            padding: 1rem;
            background: var(--primary-bg);
            border-radius: 0;
            border: 1px solid var(--border-color);
        }

        .instructions-section {
            margin-bottom: 1.5rem;
        }

        .instructions-section h3 {
            color: var(--accent-color);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .instructions-section p {
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .instructions-section ul {
            list-style-type: none;
            padding-left: 1rem;
            margin-bottom: 0.75rem;
        }

        .instructions-section li {
            color: var(--text-primary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .instructions-section li::before {
            content: "•";
            color: var(--accent-color);
            position: absolute;
            left: -1rem;
        }

        /* Update the tab buttons to accommodate three tabs */
        .tab-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .tab-button {
            flex: 1;
            padding: 0.75rem 0.5rem;
            font-size: 0.875rem;
        }

        /* In the App component, update the tab buttons and add instructions content */
        <div className="tab-buttons">
            <button 
                className={`tab-button ${activeTab === 'welcome' ? 'active' : ''}`}
                onClick={() => setActiveTab('welcome')}
            >
                👋 Welcome
            </button>
            <button 
                className={`tab-button ${activeTab === 'content' ? 'active' : ''}`}
                onClick={() => setActiveTab('content')}
            >
                🎮 Play
            </button>
            <button 
                className={`tab-button ${activeTab === 'settings' ? 'active' : ''}`}
                onClick={() => setActiveTab('settings')}
            >
                ⚙️ Settings
            </button>
        </div>

        <div className="tab-content">
            {activeTab === 'settings' ? (
                <>
                    <input
                        type="text"
                        placeholder="Enter OpenAI API Key"
                        value={apiKey}
                        onChange={(e) => setApiKey(e.target.value)}
                        className="api-key-input"
                    />

                    <div className="model-selector-wrapper">
                        <select 
                            value={model}
                            onChange={(e) => setModel(e.target.value)}
                            className="model-selector"
                        >
                            {OPENAI_MODELS.map(model => (
                                <option key={model} value={model}>{model}</option>
                            ))}
                        </select>
                    </div>

                    <div className="agency-details">
                        <textarea
                            value={agencyName}
                            onChange={(e) => setAgencyName(e.target.value)}
                            placeholder="Enter Playground Name..."
                            className="agency-name-textarea"
                        />
                        <textarea
                            value={agencyDescription}
                            onChange={(e) => setAgencyDescription(e.target.value)}
                            placeholder="Enter Playground Description..."
                            className="agency-description-textarea"
                        />
                    </div>

                    <div style={{ display: 'flex', gap: '0.5rem', marginTop: '1rem' }}>
                        <input
                            type="file"
                            id="loadAgencyInput"
                            className="hidden"
                            accept=".json"
                            onChange={loadAgency}
                        />
                        <button 
                            onClick={() => document.getElementById('loadAgencyInput').click()} 
                            className="btn btn-agency"
                            style={{ flex: 1 }}
                        >
                            📂 Load Playground
                        </button>
                        <button 
                            onClick={exportAgency} 
                            className="btn btn-agency"
                            style={{ flex: 1 }}
                        >
                            💾 Export Playground
                        </button>
                    </div>
                </>
            ) : activeTab === 'content' ? (
                <>
                    <input
                        type="file"
                        id="fileInput"
                        className="hidden"
                        accept=".pdf,.doc,.docx,.txt,.md,image/*"
                        onChange={handleFileUpload}
                        multiple
                    />
                    <button 
                        onClick={() => document.getElementById('fileInput').click()}
                        className="btn btn-primary"
                        style={{ marginBottom: '1rem' }}
                    >
                        📎 Upload File or Image
                    </button>

                    <DocumentTray 
                        uploadedDocuments={uploadedDocuments} 
                        onDeleteDocument={(id) => {
                            setUploadedDocuments(current => current.filter(doc => doc.id !== id));
                        }}
                        onSelectDocument={(content) => setSourceContent(content)}
                    />

                    <textarea
                        value={sourceContent}
                        onChange={(e) => setSourceContent(e.target.value)}
                        placeholder="Enter or upload source content..."
                        style={{ 
                            display: 'block',
                            width: '100%',
                            minHeight: '200px',
                            margin: '1rem 0',
                            padding: '0.75rem',
                            borderRadius: '0',
                            border: '1px solid var(--border-color)',
                            background: 'var(--primary-bg)',
                            color: 'var(--text-primary)',
                            resize: 'vertical'
                        }}
                    />

                    <ImageTray uploadedImages={uploadedImages} onDeleteImage={deleteImage} />
                    <PersonaTray onAddPersona={addPersonaCard} />
                    <ScenarioTray onAddScenario={addScenarioCard} />
                </>
            ) : (
                <div className="instructions-content">
                    <div className="instructions-section">
                        <h3> Getting Started</h3>
                        <p>Before using the playground, set up your environment in the Settings tab:</p>
                        <ul>
                            <li>Enter your OpenAI API key</li>
                            <li>Select your preferred model</li>
                            <li>Set your agency name and description</li>
                        </ul>
                    </div>

                    <div className="instructions-section">
                        <h3>📄 Working with Content</h3>
                        <p>In the Content tab, you can:</p>
                        <ul>
                            <li>Upload documents (PDF, DOC, TXT) or images</li>
                            <li>Enter source content manually in the text area</li>
                            <li>Create and manage personas for different communication styles</li>
                            <li>Define scenarios for specific use cases</li>
                        </ul>
                    </div>

                    <div className="instructions-section">
                        <h3>💡 Using Prompts</h3>
                        <p>Create and manage prompts in the main area:</p>
                        <ul>
                            <li>Click "Add Prompt" to create a new prompt card</li>
                            <li>Choose between text or image analysis</li>
                            <li>Select source content from uploaded files</li>
                            <li>Use previous results as sources for new prompts</li>
                            <li>Run prompts individually or all at once</li>
                        </ul>
                    </div>

                    <div className="instructions-section">
                        <h3>👥 Personas & Scenarios</h3>
                        <p>Enhance your prompts with context:</p>
                        <ul>
                            <li>Add personas to define the voice (FROM) or audience (TO)</li>
                            <li>Create scenarios to set specific business contexts</li>
                            <li>Combine multiple personas and scenarios for complex use cases</li>
                        </ul>
                    </div>

                    <div className="instructions-section">
                        <h3>💾 Saving Your Work</h3>
                        <p>Manage your playground setup:</p>
                        <ul>
                            <li>Export your entire playground configuration</li>
                            <li>Save just the content and results</li>
                            <li>Load previously saved configurations</li>
                        </ul>
                    </div>

                    <div className="instructions-section">
                        <h3>⚡ Pro Tips</h3>
                        <ul>
                            <li>Use multiple personas to create more nuanced responses</li>
                            <li>Chain prompts together by using previous results as sources</li>
                            <li>Combine text and image analysis for comprehensive insights</li>
                            <li>Save different configurations for various use cases</li>
                        </ul>
                    </div>
                </div>
            )}
        </div>
    </style>
</head>
<body>
    <div id="particles-js"></div>
    <div id="root"></div>
    <script type="text/babel">
        // Add this constant at the top of your script, before any other code
        const PERSONAS = [
            {
                id: 'executive',
                name: 'Executive',
                emoji: '👔',
                description: 'Strategic, high-level communication focused on business impact and ROI'
            },
            {
                id: 'technical',
                name: 'Technical Expert',
                emoji: '🔧',
                description: 'Detailed, precise communication with technical specifications and implementation details'
            },
            {
                id: 'creative',
                name: 'Creative Director',
                emoji: '🎨',
                description: 'Visual and conceptual thinking with emphasis on design and innovation'
            },
            {
                id: 'marketer',
                name: 'Marketing Specialist',
                emoji: '📢',
                description: 'Persuasive communication focused on value proposition and audience engagement'
            },
            {
                id: 'customer',
                name: 'Customer Service',
                emoji: '🤝',
                description: 'Empathetic, solution-oriented communication focused on user satisfaction'
            },
            {
                id: 'analyst',
                name: 'Data Analyst',
                emoji: '📊',
                description: 'Analytical communication with focus on metrics, trends, and insights'
            },
            {
                id: 'trainer',
                name: 'Training Specialist',
                emoji: '📚',
                description: 'Educational communication focused on learning outcomes and skill development'
            },
            {
                id: 'hr',
                name: 'HR Professional',
                emoji: '👥',
                description: 'People-focused communication emphasizing policies, culture, and employee relations'
            }
        ];

        // Constants
        const OPENAI_MODELS = [
            "gpt-4o",  // GPT-4o
            "gpt-4",
            "gpt-3.5-turbo-1106",
            "gpt-3.5-turbo",
        ];

        const SUPPORTED_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/gif'];
        const MAX_IMAGE_SIZE = 10 * 1024 * 1024; // 10MB

        // Initialize particles.js
        particlesJS('particles-js', {
            particles: {
                number: { value: 80, density: { enable: true, value_area: 800 } },
                color: { value: '#e29863' },
                shape: { type: 'circle' },
                opacity: { value: 0.5, random: false },
                size: { value: 3, random: true },
                line_linked: { 
                    enable: true, 
                    distance: 150, 
                    color: '#e29863', 
                    opacity: 0.4, 
                    width: 1 
                },
                move: { enable: true, speed: 2, direction: 'none', random: false, straight: false, out_mode: 'out' }
            },
            interactivity: {
                detect_on: 'canvas',
                events: {
                    onhover: { enable: true, mode: 'grab' },
                    onclick: { enable: true, mode: 'push' },
                    resize: true
                }
            },
            retina_detect: true
        });

        // File Processing Utility
        const FileProcessor = {
            async readPDFFile(file) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let text = '';
                    
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        const strings = content.items.map(item => item.str);
                        text += strings.join(' ') + '\n';
                    }
                    
                    return text.trim();
                } catch (error) {
                    console.error('PDF Processing Error:', error);
                    throw new Error(`Failed to process PDF file: ${error.message}`);
                }
            },

            async readDocFile(file) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    return result.value.trim();
                } catch (error) {
                    console.error('DOC Processing Error:', error);
                    throw new Error(`Failed to process DOC/DOCX file: ${error.message}`);
                }
            },

            async readTextFile(file) {
                try {
                    const text = await file.text();
                    return text.trim();
                } catch (error) {
                    console.error('Text File Processing Error:', error);
                    throw new Error(`Failed to read text file: ${error.message}`);
                }
            },

            async processImage(file) {
                if (!file || !SUPPORTED_IMAGE_TYPES.includes(file.type)) {
                    throw new Error('Unsupported image type');
                }

                if (file.size > MAX_IMAGE_SIZE) {
                    throw new Error('Image size too large (max 10MB)');
                }

                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = () => reject(new Error('Error reading image'));
                    reader.readAsDataURL(file);
                });
            },

            async processFile(file) {
                if (!file) throw new Error('No file provided');

                const fileType = file.type;
                if (SUPPORTED_IMAGE_TYPES.includes(fileType)) {
                    return await this.processImage(file);
                }

                const extension = file.name.toLowerCase().split('.').pop();
                switch (extension) {
                    case 'pdf':
                        return await this.readPDFFile(file);
                    case 'doc':
                    case 'docx':
                        return await this.readDocFile(file);
                    case 'txt':
                    case 'md':
                        return await this.readTextFile(file);
                    default:
                        throw new Error(`Unsupported file type: ${extension}`);
                }
            }
        };
        // React Components
        const CopyButton = ({ text }) => {
            const [copied, setCopied] = React.useState(false);
            
            const copyToClipboard = async () => {
                try {
                    await navigator.clipboard.writeText(text);
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                } catch (err) {
                    console.error('Failed to copy:', err);
                }
            };

            return (
                <button 
                    onClick={copyToClipboard} 
                    className="copy-button" 
                    title={copied ? "Copied!" : "Copy to clipboard"}
                >
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        {copied ? (
                            <path d="M20 6L9 17l-5-5"/>
                        ) : (
                            <>
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </>
                        )}
                    </svg>
                </button>
            );
        };

        const ProcessingIndicator = ({ isVisible }) => (
            <div className={`processing-file ${!isVisible ? 'hidden' : ''}`}>
                <h3>Processing File...</h3>
                <p>Please wait while we process your content</p>
            </div>
        );

        const PersonaCard = ({ persona, onUpdate, onDelete }) => {
            return (
                <div className="persona-card">
                    <div className="persona-header">
                        <span className="persona-emoji">{persona.emoji}</span>
                        <span className="persona-title">AUDIENCE PERSONA</span>
                        <input 
                            type="text" 
                            className="persona-name" 
                            value={persona.name} 
                            onChange={(e) => onUpdate(persona.cardId, { name: e.target.value })}
                        />
                    </div>
                    
                    <textarea
                        value={persona.description}
                        onChange={(e) => onUpdate(persona.cardId, { description: e.target.value })}
                        className="persona-textarea"
                        spellCheck="true"
                        rows="6"
                    />
                    
                    <button 
                        onClick={() => onDelete(persona.cardId)}
                        className="btn btn-danger"
                    >
                        Delete
                    </button>
                </div>
            );
        };

        const PersonaTray = ({ onAddPersona }) => {
            const [selectedPersona, setSelectedPersona] = React.useState('');

            const handleAddPersona = () => {
                if (selectedPersona) {
                    const persona = PERSONAS.find(p => p.id === selectedPersona);
                    onAddPersona({
                        ...persona,
                        cardId: Date.now()
                    });
                    setSelectedPersona('');
                }
            };

            return (
                <div className="persona-tray">
                    <div className="persona-selector-container">
                        <select 
                            value={selectedPersona}
                            onChange={(e) => setSelectedPersona(e.target.value)}
                            className="persona-selector"
                        >
                            <option value="">👥 Select Audience...</option>
                            {PERSONAS.map(persona => (
                                <option key={persona.id} value={persona.id}>
                                    {persona.emoji} {persona.name}
                                </option>
                            ))}
                        </select>
                        <button 
                            onClick={handleAddPersona}
                            className="add-persona-btn"
                            disabled={!selectedPersona}
                        >
                            +
                        </button>
                    </div>
                </div>
            );
        };
        const PromptCard = ({ prompt, sourceOptions, loading, onUpdate, onDelete, onRun, uploadedImages, uploadedDocuments }) => {
            // When the component mounts or when prompt.id changes, set a default title if none exists
            React.useEffect(() => {
                if (!prompt.title || prompt.title === `${prompt.id}`) {
                    onUpdate(prompt.id, { title: `PROMPT${prompt.id}` });
                }
            }, [prompt.id]);

            const isImageMode = prompt.sourceType === 'image';

            return (
                <div className={`prompt-card ${isImageMode ? 'image-mode' : ''}`}>
                    <div className="prompt-header">
                        <span className="prompt-emoji">📝</span>
                        <span className="prompt-title">PROMPT CARD</span>
                        <input
                            type="text"
                            className="prompt-title-input"
                            value={prompt.title || `PROMPT${prompt.id}`}
                            onChange={(e) => onUpdate(prompt.id, { title: e.target.value })}
                            placeholder={`PROMPT${prompt.id}`}
                        />
                    </div>
            
                    <div className="source-label">Select Source</div>
                    <div className="source-type-selector">
                        <button 
                            className={`source-type-button ${!isImageMode ? 'active' : ''}`}
                            onClick={() => onUpdate(prompt.id, { sourceType: 'text', selectedImage: null })}
                        >
                            Text
                        </button>
                        <button 
                            className={`source-type-button ${isImageMode ? 'active' : ''}`}
                            onClick={() => onUpdate(prompt.id, { sourceType: 'image' })}
                        >
                            Image
                        </button>
                    </div>

                    {isImageMode ? (
                        <select 
                            value={prompt.selectedImage || ''}
                            onChange={(e) => onUpdate(prompt.id, { selectedImage: parseFloat(e.target.value) })}
                            className="source-selector"
                        >
                            <option value="">Select an image...</option>
                            {uploadedImages.map(img => (
                                <option key={img.id} value={img.id}>
                                    {img.name}
                                </option>
                            ))}
                        </select>
                    ) : (
                        <select 
                            multiple
                            value={Array.isArray(prompt.sources) ? prompt.sources : [prompt.source]}
                            onChange={(e) => {
                                const selectedOptions = Array.from(e.target.selectedOptions).map(option => option.value);
                                onUpdate(prompt.id, { sources: selectedOptions });
                            }}
                            className="source-selector multiple"
                        >
                            <option value="SOURCE">SOURCE</option>
                            {uploadedDocuments.map(doc => (
                                <option key={`doc-${doc.id}`} value={`DOC-${doc.id}`}>
                                    {doc.name}
                                </option>
                            ))}
                            {sourceOptions.map(option => (
                                <option key={`result-${option.id}`} value={`RESULT${option.id}`}>
                                    RESULT{option.id}
                                </option>
                            ))}
                        </select>
                    )}
            
                    <textarea
                        value={prompt.text}
                        onChange={(e) => onUpdate(prompt.id, { text: e.target.value })}
                        placeholder={isImageMode ? "Enter your image analysis prompt..." : "Enter your prompt..."}
                        className="prompt-textarea"
                        spellCheck="true"
                        autoComplete="off"
                        rows="6"
                    />
            
                    <div className="result-label">RESULT{prompt.id}</div>
            
                    <div className="result-container">
                        <textarea
                            value={prompt.result}
                            onChange={(e) => onUpdate(prompt.id, { result: e.target.value })}
                            placeholder="Results will appear here..."
                            className="result-textarea"
                            readOnly
                            rows="8"
                        />
                        <CopyButton text={prompt.result} />
                    </div>
            
                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                        <button 
                            onClick={() => onRun(prompt.id)} 
                            className="btn btn-success"
                            disabled={loading || (isImageMode && !prompt.selectedImage)}
                        >
                            {loading ? (
                                <span className="loading-spinner" />
                            ) : (
                                isImageMode ? 'Analyze Image' : 'Run'
                            )}
                        </button>
                        <button 
                            onClick={() => onDelete(prompt.id)}
                            className="btn btn-danger"
                        >
                            Delete
                        </button>
                    </div>
                </div>
            );
        };

        const ImageTray = ({ uploadedImages, onDeleteImage }) => (
            <div className="image-tray">
                <div className="image-tray-title">Uploaded Images</div>
                <div className="image-preview-list">
                    {uploadedImages.map(image => (
                        <div key={image.id} className="image-preview-item">
                            <img src={image.url} alt={image.name} />
                            <button 
                                className="delete-button"
                                onClick={() => onDeleteImage(image.id)}
                            >
                                ×
                            </button>
                        </div>
                    ))}
                </div>
            </div>
        );

        const DocumentTray = ({ uploadedDocuments, onDeleteDocument, onSelectDocument }) => {
            const [expandedDoc, setExpandedDoc] = React.useState(null);

            return (
                <div className="document-tray">
                    <div className="document-tray-title">Uploaded Documents</div>
                    <div className="document-preview-list">
                        {uploadedDocuments.map(doc => (
                            <div key={doc.id} className="document-preview-item">
                                <div className="document-preview-content">
                                    <span className="document-icon">📄</span>
                                    <span className="document-name" onClick={() => onSelectDocument(doc.content)}>
                                        {doc.name}
                                    </span>
                                </div>
                                <div className="document-actions">
                                    <button 
                                        className="preview-button"
                                        onClick={() => setExpandedDoc(expandedDoc === doc.id ? null : doc.id)}
                                    >
                                        {expandedDoc === doc.id ? 'Hide' : 'Preview'}
                                    </button>
                                    <button 
                                        className="use-button"
                                        onClick={() => onSelectDocument(doc.content)}
                                    >
                                        Use
                                    </button>
                                    <button 
                                        className="delete-button"
                                        onClick={() => onDeleteDocument(doc.id)}
                                    >
                                        ×
                                    </button>
                                </div>
                                {expandedDoc === doc.id && (
                                    <div className="document-content">
                                        <textarea
                                            readOnly
                                            value={doc.content}
                                            className="document-content-preview"
                                        />
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Add this constant at the top of your script, before any other code
        const SCENARIOS = [
            {
                id: 'meeting',
                emoji: '🎯',
                name: 'Team Meeting',
                description: 'A scenario focused on team collaboration and meeting outcomes.'
            },
            {
                id: 'presentation',
                emoji: '🎯',
                name: 'Client Presentation',
                description: 'A scenario for preparing and delivering client presentations.'
            }
        ];

        // React Components
        const ScenarioCard = ({ scenario, onUpdate, onDelete }) => {
            return (
                <div className="scenario-card">
                    <div className="scenario-header">
                        <span className="scenario-emoji">🎯</span>
                        <span className="scenario-title">SCENARIO CARD</span>
                        <input 
                            type="text" 
                            className="scenario-name" 
                            value={scenario.name} 
                            onChange={(e) => onUpdate(scenario.cardId, { name: e.target.value })}
                        />
                    </div>
                    
                    <textarea
                        value={scenario.description}
                        onChange={(e) => onUpdate(scenario.cardId, { description: e.target.value })}
                        className="scenario-textarea"
                        spellCheck="true"
                        rows="6"
                    />
                    
                    <button 
                        onClick={() => onDelete(scenario.cardId)}
                        className="btn btn-danger"
                    >
                        Delete
                    </button>
                </div>
            );
        };

        const ScenarioTray = ({ onAddScenario }) => {
            const [selectedScenario, setSelectedScenario] = React.useState('');

            const handleAddScenario = () => {
                if (selectedScenario) {
                    const scenario = SCENARIOS.find(s => s.id === selectedScenario);
                    onAddScenario({
                        ...scenario,
                        cardId: Date.now()
                    });
                    setSelectedScenario('');
                }
            };

            return (
                <div className="scenario-tray">
                    <div className="scenario-selector-container">
                        <select 
                            value={selectedScenario}
                            onChange={(e) => setSelectedScenario(e.target.value)}
                            className="scenario-selector"
                        >
                            <option value="">🎯 Select Scenario...</option>
                            {SCENARIOS.map(scenario => (
                                <option key={scenario.id} value={scenario.id}>
                                    {scenario.emoji} {scenario.name}
                                </option>
                            ))}
                        </select>
                        <button 
                            onClick={handleAddScenario}
                            className="add-scenario-btn"
                            disabled={!selectedScenario}
                        >
                            +
                        </button>
                    </div>
                </div>
            );
        };

        // Main App Component
        function App() {
            const [apiKey, setApiKey] = React.useState('');
            const [model, setModel] = React.useState(OPENAI_MODELS[0]);  // Will now default to gpt-4-turbo-preview
            const [sourceContent, setSourceContent] = React.useState('');
            const [uploadedImages, setUploadedImages] = React.useState([]);
            const [agencyName, setAgencyName] = React.useState('');
            const [agencyDescription, setAgencyDescription] = React.useState('');
            const [personaCards, setPersonaCards] = React.useState([]);
            const [prompts, setPrompts] = React.useState([{ 
                id: 1, 
                title: '',
                text: '', 
                result: '',
                source: 'SOURCE',
                sources: ['SOURCE'],
                sourceType: 'text',
                selectedImage: null
            }]);
            const [loading, setLoading] = React.useState({});
            const [error, setError] = React.useState('');
            const [isProcessingFile, setIsProcessingFile] = React.useState(false);
            const [uploadedDocuments, setUploadedDocuments] = React.useState([]);
            const [scenarioCards, setScenarioCards] = React.useState([]);
            const [activeTab, setActiveTab] = React.useState('welcome');

            const handleFileUpload = async (event) => {
                const files = Array.from(event.target.files);
                if (!files.length) return;

                setIsProcessingFile(true);
                setError('');

                try {
                    for (const file of files) {
                        const content = await FileProcessor.processFile(file);
                        
                        if (SUPPORTED_IMAGE_TYPES.includes(file.type)) {
                            const imageId = Date.now() + Math.random();
                            setUploadedImages(current => [...current, {
                                id: imageId,
                                url: content,
                                name: file.name
                            }]);
                        } else {
                            const docId = Date.now() + Math.random();
                            setUploadedDocuments(current => [...current, {
                                id: docId,
                                content: content,
                                name: file.name
                            }]);
                        }
                    }
                } catch (error) {
                    setError('Error processing file: ' + error.message);
                } finally {
                    setIsProcessingFile(false);
                }
            };

            const deleteImage = (imageId) => {
                setUploadedImages(current => current.filter(img => img.id !== imageId));
                setPrompts(current => current.map(prompt => 
                    prompt.selectedImage === imageId 
                        ? {...prompt, selectedImage: null}
                        : prompt
                ));
            };

            const addPersonaCard = (persona) => {
                setPersonaCards([...personaCards, persona]);
            };

            const updatePersonaCard = (id, changes) => {
                setPersonaCards(personaCards.map(p => 
                    p.cardId === id ? {...p, ...changes} : p
                ));
            };

            const deletePersonaCard = (id) => {
                setPersonaCards(personaCards.filter(p => p.cardId !== id));
            };

            const addPrompt = () => {
                const newPrompt = {
                    id: Date.now(),
                    title: '',
                    text: '',
                    result: '',
                    source: 'SOURCE',
                    sources: ['SOURCE'],
                    sourceType: 'text',
                    selectedImage: null
                };
                setPrompts([...prompts, newPrompt]);
            };

            const deletePrompt = (id) => {
                setPrompts(prompts.filter(p => p.id !== id));
            };

            const updatePrompt = (id, changes) => {
                setPrompts(prompts.map(p => 
                    p.id === id ? {...p, ...changes} : p
                ));
            };
            const getPromptSource = (promptId) => {
                const prompt = prompts.find(p => p.id === promptId);
                if (!prompt) return '';
                
                // Ensure we're working with an array of sources
                const sources = Array.isArray(prompt.sources) ? prompt.sources : [prompt.source];
                
                // Map each source to its content and filter out any empty sources
                const sourceContents = sources.map(source => {
                    if (!source) return '';  // Handle undefined/null sources
                    
                    if (source === 'SOURCE') {
                        return sourceContent || '';
                    }
                    
                    if (source.startsWith('DOC-')) {
                        const docId = parseFloat(source.replace('DOC-', ''));
                        const document = uploadedDocuments.find(doc => doc.id === docId);
                        return document ? document.content : '';
                    }
                    
                    const sourcePromptId = parseInt(source.replace('RESULT', ''));
                    const sourcePrompt = prompts.find(p => p.id === sourcePromptId);
                    return sourcePrompt ? sourcePrompt.result : '';
                }).filter(content => content.trim() !== '');

                // If no valid sources found, return explicit message
                if (sourceContents.length === 0) {
                    return 'No source content provided. Please select a valid source.';
                }

                // Combine all source contents with clear separation
                return sourceContents.join('\n\n=== SOURCE SEPARATOR ===\n\n');
            };

            const getPersonaContext = () => {
                const fromPersonas = personaCards.filter(p => p.direction === 'from');
                const toPersonas = personaCards.filter(p => p.direction === 'to');
                
                let context = '';
                
                if (fromPersonas.length > 0) {
                    context += `\nRespond FROM the perspective of: ${fromPersonas.map(p => 
                        `${p.name} (${p.description})`).join(', ')}`;
                }
                
                if (toPersonas.length > 0) {
                    context += `\nTarget your response TO: ${toPersonas.map(p => 
                        `${p.name} (${p.description})`).join(', ')}`;
                }
                
                return context;
            };

            const runPrompt = async (id) => {
                if (!apiKey) {
                    setError('Please enter an OpenAI API key');
                    return;
                }

                setLoading(prev => ({ ...prev, [id]: true }));
                setError('');

                try {
                    const prompt = prompts.find(p => p.id === id);
                    let requestBody;

                    if (prompt.sourceType === 'image') {
                        const selectedImage = uploadedImages.find(img => img.id === prompt.selectedImage);
                        if (!selectedImage) throw new Error('No image selected');

                        requestBody = {
                            model: "gpt-4-vision-preview",
                            messages: [
                                {
                                    role: "user",
                                    content: [
                                        {
                                            type: "text",
                                            text: `${getPersonaContext()}\n${prompt.text}`
                                        },
                                        {
                                            type: "image_url",
                                            image_url: {
                                                url: selectedImage.url
                                            }
                                        }
                                    ]
                                }
                            ],
                            max_tokens: 500
                        };
                    } else {
                        const sourceText = getPromptSource(id);
                        
                        // Check if source is valid
                        if (sourceText === 'No source content provided. Please select a valid source.') {
                            throw new Error('Please select a valid source content before running the prompt.');
                        }
                        
                        const personaContext = getPersonaContext();
                        requestBody = {
                            model: model,
                            messages: [
                                { 
                                    role: "system", 
                                    content: `Context:\n${sourceText}${personaContext}`
                                },
                                { 
                                    role: "user", 
                                    content: prompt.text 
                                }
                            ],
                            max_tokens: 1000
                        };
                    }

                    try {
                        const response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            mode: 'cors', // Add CORS mode
                            cache: 'no-cache', // Disable caching
                            credentials: 'same-origin',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey.trim()}`,
                                'OpenAI-Beta': 'assistants=v1'
                            },
                            redirect: 'follow',
                            referrerPolicy: 'no-referrer',
                            body: JSON.stringify(requestBody)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        
                        if (data.error) {
                            throw new Error(data.error.message || 'Unknown error occurred');
                        }

                        const result = data.choices[0].message.content;
                        updatePrompt(id, { result });

                    } catch (fetchError) {
                        // Check if it's a network error
                        if (fetchError.name === 'TypeError' && fetchError.message === 'Failed to fetch') {
                            throw new Error('Network error: Please check your internet connection or try using a VPN');
                        }
                        throw fetchError;
                    }

                } catch (err) {
                    console.error('API Error:', err);
                    setError(`Error: ${err.message}`);
                } finally {
                    setLoading(prev => ({ ...prev, [id]: false }));
                }
            };

            const runAllPrompts = async () => {
                for (const prompt of prompts) {
                    await runPrompt(prompt.id);
                }
            };
            const exportAgency = async () => {
                try {
                    const exportData = {
                        agencyName,
                        agencyDescription,
                        sourceContent,
                        uploadedImages,
                        personaCards,
                        prompts: prompts.map(({ id, title, text, result, source, sources, sourceType, selectedImage }) => ({
                            id,
                            title,
                            text,
                            result,
                            source,
                            sources,
                            sourceType,
                            selectedImage
                        })),
                        settings: { model },
                        scenarioCards,
                    };
                    
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
                        type: 'application/json' 
                    });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `playground-export-${Date.now()}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    setError('Error exporting playground: ' + error.message);
                }
            };

            const exportContent = () => {
                try {
                    const content = prompts.map(prompt => {
                        let promptContent = `PROMPT ${prompt.id}: ${prompt.title}\n${prompt.text}\n\n`;
                        if (prompt.sourceType === 'image') {
                            promptContent += `[Image Analysis]\n`;
                        }
                        promptContent += `RESULT ${prompt.id}:\n${prompt.result}\n\n---\n\n`;
                        return promptContent;
                    }).join('');
                    
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `playground-content-${Date.now()}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    setError('Error exporting content: ' + error.message);
                }
            };

            const loadAgency = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (!data.prompts || !data.settings) {
                            throw new Error('Invalid playground file structure');
                        }

                        setSourceContent(data.sourceContent || '');
                        setPrompts(data.prompts);
                        setModel(data.settings.model || OPENAI_MODELS[0]);
                        setAgencyName(data.agencyName || '');
                        setAgencyDescription(data.agencyDescription || '');
                        setUploadedImages(data.uploadedImages || []);
                        setPersonaCards(data.personaCards || []);
                        setScenarioCards(data.scenarioCards || []);
                    } catch (error) {
                        setError('Error loading playground: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };

            const handleDocumentSelect = (content) => {
                setSourceContent(content);
            };

            const addScenarioCard = (scenario) => {
                setScenarioCards([...scenarioCards, scenario]);
            };

            const updateScenarioCard = (id, changes) => {
                setScenarioCards(scenarioCards.map(s => 
                    s.cardId === id ? {...s, ...changes} : s
                ));
            };

            const deleteScenarioCard = (id) => {
                setScenarioCards(scenarioCards.filter(s => s.cardId !== id));
            };

            // Add this constant near your other constants (PERSONAS, SCENARIOS)
            const PLAYGROUNDS = [
                {
                    id: 'content-analysis',
                    name: 'Content Analysis',
                    description: 'Analyze content tone, style, and audience targeting',
                    config: {
                        agencyName: 'Content Analysis Playground',
                        agencyDescription: 'Analyze and optimize content for different platforms and audiences',
                        prompts: [{
                            id: 1,
                            title: 'Content Analysis',
                            text: 'Analyze this content and provide key insights about:\n1. Tone and style\n2. Target audience\n3. Key messages\n4. Areas for improvement',
                            result: '',
                            source: 'SOURCE',
                            sources: ['SOURCE'],
                            sourceType: 'text',
                            selectedImage: null
                        }]
                    }
                },
                {
                    id: 'social-media',
                    name: 'Social Media',
                    description: 'Create and optimize social media content',
                    config: {
                        agencyName: 'Social Media Playground',
                        agencyDescription: 'Create engaging social media content across platforms',
                        prompts: [{
                            id: 2,
                            title: 'Social Post Generator',
                            text: 'Create a series of social media posts optimized for engagement. Include variations for:\n1. LinkedIn\n2. Twitter\n3. Instagram',
                            result: '',
                            source: 'SOURCE',
                            sources: ['SOURCE'],
                            sourceType: 'text',
                            selectedImage: null
                        }]
                    }
                },
                {
                    id: 'blog-writing',
                    name: 'Blog Writing',
                    description: 'Generate blog content and outlines',
                    config: {
                        agencyName: 'Blog Writing Playground',
                        agencyDescription: 'Create engaging blog content and structured outlines',
                        prompts: [{
                            id: 3,
                            title: 'Blog Outline',
                            text: 'Create a detailed blog outline including:\n1. Title options\n2. Key sections\n3. Main points for each section\n4. Suggested examples or case studies',
                            result: '',
                            source: 'SOURCE',
                            sources: ['SOURCE'],
                            sourceType: 'text',
                            selectedImage: null
                        }]
                    }
                },
                {
                    id: 'email-marketing',
                    name: 'Email Marketing',
                    description: 'Create email marketing campaigns',
                    config: {
                        agencyName: 'Email Marketing Playground',
                        agencyDescription: 'Design effective email marketing campaigns',
                        prompts: [{
                            id: 4,
                            title: 'Email Sequence',
                            text: 'Generate an email marketing sequence including:\n1. Subject lines\n2. Email body content\n3. Call-to-action suggestions\n4. Follow-up variations',
                            result: '',
                            source: 'SOURCE',
                            sources: ['SOURCE'],
                            sourceType: 'text',
                            selectedImage: null
                        }]
                    }
                },
                {
                    id: 'product-description',
                    name: 'Product Description',
                    description: 'Write compelling product descriptions',
                    config: {
                        agencyName: 'Product Description Playground',
                        agencyDescription: 'Create engaging product descriptions and features',
                        prompts: [{
                            id: 5,
                            title: 'Product Description',
                            text: 'Create a compelling product description including:\n1. Main benefits\n2. Key features\n3. Technical specifications\n4. Use cases\n5. Target audience',
                            result: '',
                            source: 'SOURCE',
                            sources: ['SOURCE'],
                            sourceType: 'text',
                            selectedImage: null
                        }]
                    }
                }
            ];

            // Add the PlaygroundTray component
            const PlaygroundTray = ({ onLoadPlayground }) => {
                const [selectedPlayground, setSelectedPlayground] = React.useState('');

                const handleLoadPlayground = () => {
                    if (selectedPlayground) {
                        const playground = PLAYGROUNDS.find(p => p.id === selectedPlayground);
                        onLoadPlayground(playground.config);
                        setSelectedPlayground('');
                    }
                };

                return (
                    <div className="playground-tray">
                        <div className="playground-selector-container">
                            <select 
                                value={selectedPlayground}
                                onChange={(e) => setSelectedPlayground(e.target.value)}
                                className="playground-selector"
                            >
                                <option value="">Select Playground Template...</option>
                                {PLAYGROUNDS.map(playground => (
                                    <option key={playground.id} value={playground.id}>
                                        {playground.name}
                                    </option>
                                ))}
                            </select>
                            <button 
                                onClick={handleLoadPlayground}
                                className="add-playground-btn"
                                disabled={!selectedPlayground}
                            >
                                Load
                            </button>
                        </div>
                    </div>
                );
            };

            // In your App component, add the loadPlayground function
            const loadPlayground = (config) => {
                setAgencyName(config.agencyName);
                setAgencyDescription(config.agencyDescription);
                setPrompts(config.prompts);
            };

            return (
                <div className="container">
                    <ProcessingIndicator isVisible={isProcessingFile} />
                    
                    
                    <div className="fixed-section">
                        <div className="tabs-container">
                            <div className="tab-buttons">
                                <button 
                                    className={`tab-button ${activeTab === 'welcome' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('welcome')}
                                >
                                    👋 Welcome
                                </button>
                                                                <button 
                                    className={`tab-button ${activeTab === 'settings' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('settings')}
                                >
                                    ⚙️ Settings
                                </button>
                                <button 
                                    className={`tab-button ${activeTab === 'content' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('content')}
                                >
                                    🎮 Play
                                </button>

                            </div>

                            <div className="tab-content">
                                {activeTab === 'settings' ? (
                                    <>
                                        <input
                                            type="text"
                                            placeholder="Enter OpenAI API Key"
                                            value={apiKey}
                                            onChange={(e) => setApiKey(e.target.value)}
                                            className="api-key-input"
                                        />

                                        <div className="model-selector-wrapper">
                                            <select 
                                                value={model}
                                                onChange={(e) => setModel(e.target.value)}
                                                className="model-selector"
                                            >
                                                {OPENAI_MODELS.map(model => (
                                                    <option key={model} value={model}>{model}</option>
                                                ))}
                                            </select>
                                        </div>

                                        <PlaygroundTray onLoadPlayground={loadPlayground} />

                                        <div className="agency-details">
                                            <textarea
                                                value={agencyName}
                                                onChange={(e) => setAgencyName(e.target.value)}
                                                placeholder="Enter Playground Name..."
                                                className="agency-name-textarea"
                                            />
                                            <textarea
                                                value={agencyDescription}
                                                onChange={(e) => setAgencyDescription(e.target.value)}
                                                placeholder="Enter Playground Description..."
                                                className="agency-description-textarea"
                                            />
                                        </div>

                                        <div style={{ display: 'flex', gap: '0.5rem', marginTop: '1rem' }}>
                                            <input
                                                type="file"
                                                id="loadAgencyInput"
                                                className="hidden"
                                                accept=".json"
                                                onChange={loadAgency}
                                            />
                                            <button 
                                                onClick={() => document.getElementById('loadAgencyInput').click()} 
                                                className="btn btn-agency"
                                                style={{ flex: 1 }}
                                            >
                                                📂 Import Playground
                                            </button>
                                            <button 
                                                onClick={exportAgency} 
                                                className="btn btn-agency"
                                                style={{ flex: 1 }}
                                            >
                                                💾 Export Playground
                                            </button>
                                        </div>
                                    </>
                                ) : activeTab === 'content' ? (
                                    <>
                                        <input
                                            type="file"
                                            id="fileInput"
                                            className="hidden"
                                            accept=".pdf,.doc,.docx,.txt,.md,image/*"
                                            onChange={handleFileUpload}
                                            multiple
                                        />
                                        <button 
                                            onClick={() => document.getElementById('fileInput').click()}
                                            className="btn btn-primary"
                                            style={{ marginBottom: '1rem' }}
                                        >
                                            📎 Upload File or Image
                                        </button>

                                        <DocumentTray 
                                            uploadedDocuments={uploadedDocuments} 
                                            onDeleteDocument={(id) => {
                                                setUploadedDocuments(current => current.filter(doc => doc.id !== id));
                                            }}
                                            onSelectDocument={(content) => setSourceContent(content)}
                                        />

                                        <textarea
                                            value={sourceContent}
                                            onChange={(e) => setSourceContent(e.target.value)}
                                            placeholder="Enter or upload source content..."
                                            style={{ 
                                                display: 'block',
                                                width: '100%',
                                                minHeight: '200px',
                                                margin: '1rem 0',
                                                padding: '0.75rem',
                                                borderRadius: '0',
                                                border: '1px solid var(--border-color)',
                                                background: 'var(--primary-bg)',
                                                color: 'var(--text-primary)',
                                                resize: 'vertical'
                                            }}
                                        />

                                        <ImageTray uploadedImages={uploadedImages} onDeleteImage={deleteImage} />
                                        <PersonaTray onAddPersona={addPersonaCard} />
                                        <ScenarioTray onAddScenario={addScenarioCard} />
                                    </>
                                ) : (
                                    <div className="instructions-content">
                                        <div className="instructions-section">
                                            <h3> Getting Started</h3>
                                            <p>Before using the playground, set up your environment in the Settings tab:</p>
                                            <ul>
                                                <li>Enter your OpenAI API key</li>
                                                <li>Select your preferred model</li>
                                                <li>Set your agency name and description</li>
                                            </ul>
                                        </div>

                                        <div className="instructions-section">
                                            <h3>📄 Working with Content</h3>
                                            <p>In the Content tab, you can:</p>
                                            <ul>
                                                <li>Upload documents (PDF, DOC, TXT) or images</li>
                                                <li>Enter source content manually in the text area</li>
                                                <li>Create and manage personas for different communication styles</li>
                                                <li>Define scenarios for specific use cases</li>
                                            </ul>
                                        </div>

                                        <div className="instructions-section">
                                            <h3>💡 Using Prompts</h3>
                                            <p>Create and manage prompts in the main area:</p>
                                            <ul>
                                                <li>Click "Add Prompt" to create a new prompt card</li>
                                                <li>Choose between text or image analysis</li>
                                                <li>Select source content from uploaded files</li>
                                                <li>Use previous results as sources for new prompts</li>
                                                <li>Run prompts individually or all at once</li>
                                            </ul>
                                        </div>

                                        <div className="instructions-section">
                                            <h3>👥 Personas & Scenarios</h3>
                                            <p>Enhance your prompts with context:</p>
                                            <ul>
                                                <li>Add personas to define the voice (FROM) or audience (TO)</li>
                                                <li>Create scenarios to set specific business contexts</li>
                                                <li>Combine multiple personas and scenarios for complex use cases</li>
                                            </ul>
                                        </div>

                                        <div className="instructions-section">
                                            <h3>💾 Saving Your Work</h3>
                                            <p>Manage your playground setup:</p>
                                            <ul>
                                                <li>Export your entire playground configuration</li>
                                                <li>Save just the content and results</li>
                                                <li>Load previously saved configurations</li>
                                            </ul>
                                        </div>

                                        <div className="instructions-section">
                                            <h3>⚡ Pro Tips</h3>
                                            <ul>
                                                <li>Use multiple personas to create more nuanced responses</li>
                                                <li>Chain prompts together by using previous results as sources</li>
                                                <li>Combine text and image analysis for comprehensive insights</li>
                                                <li>Save different configurations for various use cases</li>
                                            </ul>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {error && <div className="error">{error}</div>}
                            
                            {/* Only show button bar in content/play tab */}
                            {activeTab === 'content' && (
                                <div className="button-bar">
                                    <button onClick={addPrompt} className="btn btn-agency">
                                        ✨ Add Prompt Card
                                    </button>
                                    <button onClick={runAllPrompts} className="btn btn-agency">
                                        🚀 Run All
                                    </button>
                                    <button onClick={exportContent} className="btn btn-agency">
                                        📤 Export Content
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="content-area">
                        <div className="horizontal-scroll">
                            {personaCards.map(persona => (
                                <PersonaCard
                                    key={persona.cardId}
                                    persona={persona}
                                    onUpdate={updatePersonaCard}
                                    onDelete={deletePersonaCard}
                                />
                            ))}
                            {scenarioCards.map(scenario => (
                                <ScenarioCard
                                    key={scenario.cardId}
                                    scenario={scenario}
                                    onUpdate={updateScenarioCard}
                                    onDelete={deleteScenarioCard}
                                />
                            ))}
                            {prompts.map(prompt => (
                                <PromptCard
                                    key={prompt.id}
                                    prompt={prompt}
                                    sourceOptions={prompts.filter(p => p.id < prompt.id)}
                                    loading={loading[prompt.id]}
                                    onUpdate={updatePrompt}
                                    onDelete={deletePrompt}
                                    onRun={runPrompt}
                                    uploadedImages={uploadedImages}
                                    uploadedDocuments={uploadedDocuments}
                                />
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // Initialize React App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>